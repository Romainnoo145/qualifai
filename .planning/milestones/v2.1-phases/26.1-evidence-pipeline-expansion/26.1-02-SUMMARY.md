---
phase: 26.1-evidence-pipeline-expansion
plan: 02
subsystem: api
tags:
  [scrapling, google-reviews, google-news, rss, evidence-pipeline, enrichment]

# Dependency graph
requires:
  - phase: 26.1-01
    provides: REVIEWS and NEWS EvidenceSourceType enum values in DB + Prisma client
  - phase: 25-pipeline-hardening
    provides: research-executor.ts with deepCrawl block, SourceDiagnostic type, discoverSerpUrls with mapsDataId
provides:
  - fetchGoogleReviews in lib/enrichment/google-reviews.ts — Scrapling StealthyFetcher scrape for review snippets
  - fetchGoogleNewsRss in lib/enrichment/google-news.ts — native fetch Google News RSS parser
  - Both wired into research-executor.ts deepCrawl block with empty-result recording
  - REVIEWS and NEWS source types now produced by pipeline (not just enum values)
  - google_reviews and google_news in SourceDiagnostic union
affects: [26.1-03, 26-quality-calibration, quality-gate]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Google Reviews scraping uses Scrapling StealthyFetcher via fetchStealth (bot-detection bypass)
    - Google News RSS uses native fetch with AbortSignal.timeout (no Scrapling needed — plain XML)
    - Empty-result recording pattern — always push a placeholder (notFound: true, confidenceScore 0.1) when source returns zero results
    - Regex-only XML parsing for RSS (no external XML parser)
    - Regex-only HTML snippet extraction (no cheerio/external HTML parser)

key-files:
  created:
    - lib/enrichment/google-reviews.ts
    - lib/enrichment/google-news.ts
  modified:
    - lib/research-executor.ts

key-decisions:
  - 'Google Reviews uses Google Search reviews URL (not Maps embed) — easier to scrape, same data'
  - 'Google News uses native fetch RSS (not Scrapling) — public XML feed, no bot detection needed'
  - 'Empty-result recording mandatory for both sources — confidenceScore 0.1 + notFound: true metadata'
  - 'evidence cap stays at 48 (set in 26.1-03 unstaged work that was included in this commit)'

patterns-established:
  - 'Empty-result recording: when enrichment source returns [], push a placeholder with notFound:true and confidenceScore 0.1'
  - 'All enrichment modules wrap entirely in try/catch — return [] on any error, never throw'
  - 'RSS XML parsing via regex extractTagContent with CDATA and plain-text variants — no external XML parser'

requirements-completed: [EXP-03, EXP-04]

# Metrics
duration: 3min
completed: 2026-02-28
---

# Phase 26.1 Plan 02: Google Reviews + Google News Evidence Sources Summary

**Google Reviews (Scrapling StealthyFetcher) and Google News RSS wired into deepCrawl pipeline with mandatory empty-result recording — REVIEWS and NEWS source types now produced for every research run**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-28T04:01:01Z
- **Completed:** 2026-02-28T04:04:00Z
- **Tasks:** 3 (Task 1 + Task 2 combined into 2 commits due to unstaged work discovery)
- **Files modified:** 3

## Accomplishments

- Created `lib/enrichment/google-reviews.ts` — scrapes Google Search reviews page via Scrapling StealthyFetcher, extracts snippets using 4 regex patterns (data-ved spans, quoted text, review cards, organic snippets)
- Created `lib/enrichment/google-news.ts` — fetches Google News RSS feed (native fetch, 10s timeout), parses XML with regex, filters own-domain and stale items (12-month cutoff)
- Wired both modules into `research-executor.ts` deepCrawl block with full try/catch + empty-result recording
- Added `google_reviews` and `google_news` to SourceDiagnostic union type
- Added skipped diagnostics in else branch (non-deepCrawl runs)
- Included pending `fetchLinkedInPosts` integration (from 26.1-03 unstaged work) in the same commit

## Task Commits

Each task was committed atomically:

1. **Task 1: Google Reviews module via Scrapling** - `a1fc511` (feat)
2. **Task 2: Google News RSS module** - part of `ba7a7c9` (feat)
3. **Task 3: Wire Google Reviews + Google News into research-executor** - `ba7a7c9` (feat)

**Plan metadata:** committed with final docs commit

## Files Created/Modified

- `lib/enrichment/google-reviews.ts` — fetchGoogleReviews; StealthyFetcher scrape + regex snippet extraction + HTML entity decoding
- `lib/enrichment/google-news.ts` — fetchGoogleNewsRss; native fetch RSS + regex XML parsing + own-domain + date filters
- `lib/research-executor.ts` — imports, SourceDiagnostic union extended, both sources wired in deepCrawl block, skipped diagnostics in else branch; also includes fetchLinkedInPosts integration from 26.1-03

## Decisions Made

- Used Google Search page for reviews (not Maps embed) — the /search?q=company+reviews URL is simpler to scrape and Google renders review snippets there
- Used native fetch (not Scrapling) for Google News RSS — it's a public XML feed with no bot detection, adding Scrapling would be unnecessary overhead
- Empty-result recording is mandatory: when a source returns zero items, a placeholder is always written to allDrafts with `confidenceScore: 0.1` and `notFound: true` — this distinguishes "tried and found nothing" from "never tried", which matters for quality calibration in Phase 26
- Merged in uncommitted `fetchLinkedInPosts` integration (from 26.1-03) because it was already in the working tree from a prior stash pop

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed TypeScript TS2532 errors (Object is possibly 'undefined') in google-reviews.ts**

- **Found during:** Task 1 (TypeScript compilation check)
- **Issue:** `match[1]` in regex exec loop is `string | undefined` in TS strict mode — 4 occurrences
- **Fix:** Added explicit `const captured = match[1]; if (!captured) continue;` guard before each use
- **Files modified:** lib/enrichment/google-reviews.ts
- **Verification:** `npx tsc --noEmit` returns 0 errors after fix
- **Committed in:** a1fc511 (Task 1 commit)

**2. [Rule 3 - Blocking] Included uncommitted fetchLinkedInPosts integration from 26.1-03**

- **Found during:** Task 3 (git status revealed unstaged changes to research-executor.ts from prior stash pop)
- **Issue:** research-executor.ts had uncommitted changes from plan 26.1-03 (fetchLinkedInPosts wiring, linkedin_posts diagnostic, evidence cap 48) — these were correct changes that needed to be committed
- **Fix:** Staged the existing unstaged changes alongside the 26.1-02 additions in the same commit
- **Files modified:** lib/research-executor.ts
- **Verification:** TypeScript compiles clean, all features present
- **Committed in:** ba7a7c9 (Task 3 commit)

---

**Total deviations:** 2 auto-fixed (1 bug, 1 blocking)
**Impact on plan:** Both fixes necessary for correctness. No scope creep — TS type guard is a required fix; linkedin_posts inclusion completes uncommitted 26.1-03 work.

## Issues Encountered

- `npm run check` script does not exist in this project — ran `npx tsc --noEmit` and `npm run lint` individually (same as plan 26.1-01)
- Found unstaged research-executor.ts changes from prior session stash pop — incorporated cleanly into Task 3 commit

## Self-Check

### Created files:

- [x] lib/enrichment/google-reviews.ts - FOUND
- [x] lib/enrichment/google-news.ts - FOUND

### Verified artifacts:

- [x] fetchGoogleReviews exports from google-reviews.ts (confirmed)
- [x] fetchGoogleNewsRss exports from google-news.ts (confirmed)
- [x] Both imported in research-executor.ts (lines 18-19)
- [x] Both called inside deepCrawl block (lines 392, 430)
- [x] Empty-result recording with notFound: true (lines 408, 445)
- [x] Evidence cap at 48 (line 614)
- [x] 0 TypeScript errors (npx tsc --noEmit clean)
- [x] google_reviews and google_news in SourceDiagnostic union

## Self-Check: PASSED

## Next Phase Readiness

- REVIEWS and NEWS source types will now appear in research runs (previously only schema values, no producer)
- Empty-result recording means quality calibration in Phase 26 can distinguish "not found" from "not attempted"
- Phase 26 calibration now has 5 distinct source types possible: WEBSITE, LINKEDIN, REGISTRY (KvK), REVIEWS, NEWS
- 26.1-03 module (fetchLinkedInPosts) now also wired into pipeline (was in working tree, now committed)

---

_Phase: 26.1-evidence-pipeline-expansion_
_Completed: 2026-02-28_
