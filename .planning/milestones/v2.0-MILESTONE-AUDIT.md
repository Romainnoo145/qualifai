---
milestone: v2.0
audited: 2026-02-23T09:40:00Z
status: gaps_found
scores:
  requirements: 16/18
  phases: 5/5
  integration: 17/18
  flows: 2/3
gaps:
  requirements:
    - 'HYPO-06: /voor/ validation UI exists but hypotheses remain DRAFT after quality approval — never shown to prospect'
    - 'HYPO-07: Admin feedback loop exists but validateByProspect never triggered because HYPO-06 is broken'
  integration:
    - 'approveQuality mutation does not transition hypotheses from DRAFT to PENDING — missing workflowHypothesis.updateMany call'
  flows:
    - 'Flow 1 (Discovery→Research→Send): Breaks at step 6 — hypotheses stay DRAFT after quality approval, never appear on /voor/, prospect can never validate'
tech_debt:
  - phase: 17-evidence-pipeline-enrichment
    items:
      - 'Pre-existing Phase 8 bug: SERP cache re-read happens AFTER inputSnapshot overwrite — SERP cache on re-runs always treated as stale'
  - phase: 18-research-quality-gate
    items:
      - 'List-view traffic light uses approximate computeTrafficLight(evidenceCount, 1, 0.65) — hardcodes sourceTypeCount=1 and confidence=0.65; detail view shows correct values'
  - phase: 19-client-hypothesis-validation
    items:
      - 'logoUrl prop declared in DashboardClient interface but never rendered (unused prop)'
---

# Milestone v2.0: Streamlined Flow — Audit Report

**Audited:** 2026-02-23
**Status:** GAPS FOUND
**Overall:** 16/18 requirements satisfied, 1 critical integration gap

## Executive Summary

All 5 phases (17-21) passed individual verification with 32/32 observable truths confirmed. However, **cross-phase integration checking revealed a critical gap**: the `approveQuality` mutation (Phase 18) does not transition hypotheses from `DRAFT` to `PENDING`, which breaks the hypothesis validation flow for new prospects (Phase 19). The UI, mutation, and status labels all exist — but the write path that connects them is missing.

**Impact:** For any prospect created after v2.0, the /voor/ dashboard will show zero hypotheses and the validation section will never render. The prospect cannot confirm or decline pain points. This breaks 2 of the 18 requirements (HYPO-06, HYPO-07).

**Fix:** 3-line addition to `approveQuality` in `server/routers/research.ts`.

---

## Phase Verification Summary

| Phase | Name                            | Score | Status | Gaps                    |
| ----- | ------------------------------- | ----- | ------ | ----------------------- |
| 17    | Evidence Pipeline Enrichment    | 5/5   | PASSED | None                    |
| 18    | Research Quality Gate           | 5/5   | PASSED | None (individual phase) |
| 19    | Client Hypothesis Validation    | 8/8   | PASSED | None (individual phase) |
| 20    | One-Click Send Queue + Pipeline | 7/7   | PASSED | None                    |
| 21    | Prospect Discovery + Cleanup    | 7/7   | PASSED | None                    |

All phases pass individual verification. The gap only appears in cross-phase integration.

---

## Critical Gap: DRAFT → PENDING Transition Missing

### The Problem

When admin calls `approveQuality({ runId, approved: true })`, only the `ResearchRun` record is updated:

```typescript
// server/routers/research.ts lines 198-207
return ctx.db.researchRun.update({
  where: { id: input.runId },
  data: {
    qualityApproved: input.approved,
    qualityReviewedAt: new Date(),
    qualityNotes: input.notes ?? null,
  },
});
// ← Missing: workflowHypothesis.updateMany DRAFT → PENDING
```

### The Consequence Chain

1. Admin approves quality → `qualityApproved = true` stored on ResearchRun
2. Hypotheses remain `status = 'DRAFT'`
3. `/voor/[slug]/page.tsx` line 47 filters `{ status: { in: ['ACCEPTED', 'PENDING'] } }` → returns 0 rows
4. `DashboardClient` receives `hypotheses = []` → validation section never renders
5. `validateByProspect` mutation is never invoked → hypotheses never reach ACCEPTED
6. Outreach asset gates in `assets.ts` (5 locations) require `{ in: ['ACCEPTED', 'PENDING'] }` → outreach generation blocked

### The Fix

Add to `approveQuality` mutation after updating ResearchRun:

```typescript
if (input.approved) {
  await ctx.db.workflowHypothesis.updateMany({
    where: { researchRunId: input.runId, status: 'DRAFT' },
    data: { status: 'PENDING' },
  });
}
```

This transitions all DRAFT hypotheses to PENDING when quality is approved, making them visible on the /voor/ dashboard and eligible for outreach generation.

---

## Requirements Coverage

| Requirement | Phase  | Status      | Notes                                                                  |
| ----------- | ------ | ----------- | ---------------------------------------------------------------------- |
| EVID-06     | 17     | SATISFIED   | Sitemap URL discovery wired as primary source                          |
| EVID-07     | 17     | SATISFIED   | Google search mentions with 3 NL queries                               |
| EVID-08     | 17     | SATISFIED   | Apollo-derived + Crawl4AI LinkedIn evidence                            |
| EVID-09     | 17     | SATISFIED   | KvK registry data with REGISTRY enum                                   |
| RQUAL-01    | 18     | SATISFIED   | Traffic-light chip on list + detail                                    |
| RQUAL-02    | 18     | SATISFIED   | Lazy breakdown panel with evidence stats                               |
| RQUAL-03    | 18     | SATISFIED   | "Toch goedkeuren (beperkt)" amber override                             |
| RQUAL-04    | 18     | SATISFIED   | QualityChip breakdown shows evidence grounding                         |
| HYPO-05     | 18     | SATISFIED   | Accept/reject buttons removed, read-only badges                        |
| **HYPO-06** | **19** | **PARTIAL** | **UI exists but hypotheses stay DRAFT — never shown to prospect**      |
| **HYPO-07** | **19** | **PARTIAL** | **Admin feedback works but mutation never triggered (HYPO-06 broken)** |
| SEND-01     | 20     | SATISFIED   | Inline preview + one-click send from queue                             |
| SEND-02     | 20     | SATISFIED   | Atomic updateMany idempotency guard                                    |
| PIPE-01     | 20     | SATISFIED   | 7-stage pipeline chip on list + detail                                 |
| PIPE-02     | 20     | SATISFIED   | getActionQueue filters out researching prospects                       |
| PIPE-03     | 20     | SATISFIED   | Engagement ranking via latestEngagementAt                              |
| DISC-01     | 21     | SATISFIED   | Apollo sector + location search with batch import                      |
| CLEAN-01    | 21     | SATISFIED   | 3 dead pages return 404 via notFound()                                 |

**Score:** 16/18 satisfied, 2 partial

---

## E2E Flow Verification

### Flow 1: Discovery → Research → Quality Review → Send — BROKEN

| Step  | Description                                                  | Phase     | Status                            |
| ----- | ------------------------------------------------------------ | --------- | --------------------------------- |
| 1     | Admin searches Apollo by sector + location                   | 21        | OK                                |
| 2     | Admin batch-imports companies                                | 21        | OK                                |
| 3     | Research collects sitemap + Google + KvK + LinkedIn evidence | 17        | OK                                |
| 4     | Quality gate shows traffic light                             | 18        | OK                                |
| 5     | Admin reviews quality and approves                           | 18        | OK                                |
| **6** | **Hypotheses transition to PENDING**                         | **18→19** | **BROKEN — stay DRAFT**           |
| 7     | Draft appears in action queue                                | 20        | OK (queue shows DRAFT hypotheses) |
| 8     | Admin sends draft with one click                             | 20        | OK (idempotency works)            |
| 9     | Pipeline chip updates to "Sending"                           | 20        | OK                                |

**Break:** Step 6 — approveQuality doesn't transition hypotheses to PENDING. Downstream: /voor/ validation never triggers (hypotheses invisible), but admin outreach send still works via the action queue (which shows DRAFT hypotheses).

### Flow 2: Prospect Receives Outreach → Validates → Admin Sees — COMPLETE

All steps verified. Once hypotheses reach ACCEPTED/PENDING (via the fix above), the prospect sees the validation section, can confirm/decline, and admin sees the result in Analysis section.

### Flow 3: Quality Gate → Amber Override → Outreach Allowed — COMPLETE

Amber override stores `qualityApproved=true`. Pipeline chip shows "Reviewed." The same PENDING transition gap applies here, but the admin send path works via getActionQueue (which returns DRAFT outreach logs, not gated by hypothesis status).

---

## Tech Debt (Non-Blocking)

### Phase 17: Evidence Pipeline Enrichment

- **SERP cache re-read after overwrite** (pre-existing from Phase 8): `existingRunId` snapshot re-read happens AFTER the run update overwrites `inputSnapshot`. SERP cache on re-runs is always treated as stale, causing unnecessary SerpAPI calls. Phase 17 fixed this pattern for sitemap cache but not SERP cache.

### Phase 18: Research Quality Gate

- **Approximate list-view traffic light**: `computeTrafficLight(evidenceCount, 1, 0.65)` hardcodes `sourceTypeCount=1` and `averageConfidence=0.65`. This always returns amber when evidence ≥ 3, regardless of actual source diversity. The detail panel shows correct values. This is documented as an intentional design decision.

### Phase 19: Client Hypothesis Validation

- **Unused `logoUrl` prop**: Declared in `DashboardClient` interface, passed from page.tsx, but never rendered. Harmless, TypeScript compiles clean.

---

## Integration Wiring Summary

| Check                   | Score | Notes                                          |
| ----------------------- | ----- | ---------------------------------------------- |
| Phase exports connected | 17/18 | 1 gap: PENDING has no writer                   |
| API routes mounted      | 5/5   | All routers in \_app.ts                        |
| Auth protection         | 5/5   | adminProcedure or prospectProcedure everywhere |
| E2E flows complete      | 2/3   | Flow 1 breaks at hypothesis transition         |

---

_Audited: 2026-02-23T09:40:00Z_
_Auditor: Claude (milestone audit orchestrator + gsd-integration-checker)_
