---
phase: 22-hypothesis-flow-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/routers/research.ts
  - components/features/prospects/quality-chip.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - 'When admin approves research quality, all DRAFT hypotheses for that research run transition to PENDING'
    - 'When admin rejects research quality, any PENDING hypotheses for that research run revert to DRAFT'
    - 'After quality approval, the /voor/ dashboard shows hypotheses in the validation section'
    - 'After quality approval, the admin Analysis section immediately reflects the PENDING status without page refresh'
    - 'When a prospect validates a hypothesis on /voor/, admin sees the result in Analysis on next page load'
  artifacts:
    - path: 'server/routers/research.ts'
      provides: 'DRAFT→PENDING transition in approveQuality mutation'
      contains: 'workflowHypothesis.updateMany'
    - path: 'components/features/prospects/quality-chip.tsx'
      provides: 'Cache invalidation for hypothesis status after quality approval'
      contains: 'hypotheses.listByProspect.invalidate'
  key_links:
    - from: 'server/routers/research.ts'
      to: 'prisma.workflowHypothesis'
      via: 'updateMany in approveQuality mutation'
      pattern: "workflowHypothesis\\.updateMany.*researchRunId.*status.*DRAFT"
    - from: 'components/features/prospects/quality-chip.tsx'
      to: 'utils.hypotheses.listByProspect'
      via: 'cache invalidation in onSuccess'
      pattern: "utils\\.hypotheses\\.listByProspect\\.invalidate"
---

<objective>
Add the missing DRAFT→PENDING hypothesis transition to the `approveQuality` mutation and complete the cache invalidation chain so the admin UI reflects status changes immediately.

Purpose: Close the critical integration gap identified in the v2.0 milestone audit — without this fix, hypotheses created by the research pipeline remain DRAFT forever, the /voor/ dashboard shows zero hypotheses, and prospects can never validate pain points.

Output: Two modified files completing the E2E hypothesis flow: discovery → research → quality approval → PENDING → /voor/ validation → ACCEPTED/DECLINED → admin visibility.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-hypothesis-flow-fix/22-RESEARCH.md
@server/routers/research.ts
@components/features/prospects/quality-chip.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DRAFT→PENDING transition to approveQuality mutation</name>
  <files>server/routers/research.ts</files>
  <action>
In `server/routers/research.ts`, modify the `approveQuality` mutation (lines 198-207).

Current code returns `ctx.db.researchRun.update(...)` directly. Change it to:

1. Assign the `researchRun.update` result to a `const run` variable using `await`
2. Add an `if (input.approved)` block that calls `await ctx.db.workflowHypothesis.updateMany` with:
   - `where: { researchRunId: input.runId, status: 'DRAFT' }`
   - `data: { status: 'PENDING' }`
3. Add an `else` block (when `!input.approved`) that calls `await ctx.db.workflowHypothesis.updateMany` with:
   - `where: { researchRunId: input.runId, status: 'PENDING' }`
   - `data: { status: 'DRAFT' }`
4. Return `run` at the end

The `status: 'DRAFT'` guard in the approval branch prevents overwriting hypotheses that are already ACCEPTED or DECLINED by a prospect. The reverse branch (`!approved`) handles the edge case where an admin rejects quality after previously approving — PENDING hypotheses revert to DRAFT so they disappear from /voor/.

CRITICAL: Do NOT change the return type. The mutation must still return a ResearchRun object. The `updateMany` result (`{ count }`) is discarded.

The function already uses `async ({ ctx, input }) => {` — no signature change needed.
</action>
<verify>
Run `npx tsc --noEmit` from project root — no TypeScript errors in research.ts. Confirm the mutation still returns a ResearchRun type by checking the return statement is `return run;` where `run` is the result of `ctx.db.researchRun.update(...)`.
</verify>
<done>
The `approveQuality` mutation transitions DRAFT hypotheses to PENDING on approval and PENDING hypotheses back to DRAFT on rejection. Return type unchanged. TypeScript compiles clean.
</done>
</task>

<task type="auto">
  <name>Task 2: Add hypothesis cache invalidation to quality-chip onSuccess</name>
  <files>components/features/prospects/quality-chip.tsx</files>
  <action>
In `components/features/prospects/quality-chip.tsx`, find the `approveQuality` useMutation `onSuccess` callback (around line 62-66).

Add one line after the existing invalidation calls:

```
void utils.hypotheses.listByProspect.invalidate();
```

This invalidates all cached `hypotheses.listByProspect` queries without arguments (broad invalidation). This matches the existing pattern used for `utils.research.listRuns.invalidate()` in the same callback.

Do NOT pass a `prospectId` argument — `QualityChip` only receives `runId` as a prop, and the broad invalidation is correct here because React Query will only refetch queries with active subscribers.
</action>
<verify>
Run `npx tsc --noEmit` from project root — no TypeScript errors in quality-chip.tsx. Confirm the `onSuccess` callback now contains four `void utils...invalidate()` calls: `admin.listProspects`, `research.listRuns`, `research.getRun`, and `hypotheses.listByProspect`.
</verify>
<done>
After admin approves or rejects quality, the Analysis section's hypothesis status badges update immediately without requiring a manual page refresh.
</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run check` passes (type-check + lint + format)
3. Grep confirms `workflowHypothesis.updateMany` exists in `server/routers/research.ts`
4. Grep confirms `hypotheses.listByProspect.invalidate` exists in `components/features/prospects/quality-chip.tsx`
5. The `approveQuality` mutation return type is still `ResearchRun` (return statement is `return run;`)
</verification>

<success_criteria>

- The approveQuality mutation in research.ts contains a conditional updateMany that transitions DRAFT→PENDING on approval and PENDING→DRAFT on rejection
- The quality-chip.tsx onSuccess invalidates hypotheses.listByProspect cache
- TypeScript compiles clean (`npx tsc --noEmit` exits 0)
- No schema changes, no migrations, no new files created
  </success_criteria>

<output>
After completion, create `.planning/phases/22-hypothesis-flow-fix/22-01-SUMMARY.md`
</output>
