---
phase: 11-prospect-dashboard
plan: 02
type: execute
wave: 2
depends_on: ['11-01']
files_modified:
  - app/voor/[slug]/page.tsx
  - app/voor/[slug]/dashboard-client.tsx
  - app/admin/prospects/page.tsx
  - app/admin/prospects/[id]/page.tsx
  - app/admin/prospects/new/page.tsx
autonomous: false

must_haves:
  truths:
    - 'Visiting /voor/bedrijfsnaam shows a prospect dashboard with evidence-backed pain points from ACCEPTED hypotheses'
    - 'Dashboard displays matched use cases from ProofMatch records linked to each hypothesis'
    - 'Dashboard shows Cal.com booking, WhatsApp, call, and email contact buttons'
    - 'Clicking Request Quote sends the mutation and shows confirmation'
    - 'Existing /discover/[slug] route still works with the old wizard UI'
    - 'WizardSession engagement tracking (step times, PDF download, call booked) works on the new dashboard'
    - 'Admin copy-link and view buttons prefer /voor/ URL when readableSlug exists'
    - 'Dashboard gracefully falls back when no ACCEPTED hypotheses exist'
  artifacts:
    - path: 'app/voor/[slug]/page.tsx'
      provides: 'Server component resolving readableSlug and fetching evidence data'
      contains: 'readableSlug'
    - path: 'app/voor/[slug]/dashboard-client.tsx'
      provides: 'Client component rendering evidence dashboard with contact buttons'
      contains: 'DashboardClient'
    - path: 'app/admin/prospects/page.tsx'
      provides: 'Updated copy-link preferring /voor/ URL'
      contains: 'readableSlug'
    - path: 'app/admin/prospects/[id]/page.tsx'
      provides: 'Updated prospect detail link preferring /voor/ URL'
      contains: 'readableSlug'
  key_links:
    - from: 'app/voor/[slug]/page.tsx'
      to: 'prisma.prospect.findUnique'
      via: 'readableSlug lookup'
      pattern: 'readableSlug.*slug'
    - from: 'app/voor/[slug]/page.tsx'
      to: 'app/voor/[slug]/dashboard-client.tsx'
      via: 'DashboardClient props including prospectSlug (nanoid)'
      pattern: "prospectSlug.*prospect\\.slug"
    - from: 'app/voor/[slug]/dashboard-client.tsx'
      to: 'api.wizard.startSession'
      via: 'session tracking using nanoid slug'
      pattern: 'startSession.*slug'
    - from: 'app/voor/[slug]/dashboard-client.tsx'
      to: 'api.wizard.requestQuote'
      via: 'quote request mutation'
      pattern: 'requestQuote'
---

<objective>
Create the `/voor/[slug]` prospect dashboard route with evidence-backed content, multi-channel contact buttons, quote request UI, and update admin links to prefer readable URLs.

Purpose: This is the core user-facing deliverable of Phase 11 — transforming the prospect experience from an AI-generated wizard into an evidence-backed dashboard with real data and multiple contact channels.
Output: New `/voor/[slug]` route with DashboardClient, updated admin link behavior.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-prospect-dashboard/11-RESEARCH.md
@.planning/phases/11-prospect-dashboard/11-01-SUMMARY.md

@app/discover/[slug]/page.tsx
@app/discover/[slug]/wizard-client.tsx
@server/routers/wizard.ts
@lib/readable-slug.ts
@env.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: /voor/[slug] server component + DashboardClient</name>
  <files>
    app/voor/[slug]/page.tsx
    app/voor/[slug]/dashboard-client.tsx
  </files>
  <action>
**app/voor/[slug]/page.tsx** — Server component following exact pattern of `app/discover/[slug]/page.tsx`:

1. Export `dynamic = 'force-dynamic'`.
2. `generateMetadata` function: look up prospect by `readableSlug`, return Dutch-oriented metadata: `title: "${name} | Workflow Analyse by Klarifai"`, `description: "Gepersonaliseerde workflow analyse voor ${name}"`.
3. Default export `ProspectDashboardPage({ params })`:
   - Await params, extract slug.
   - Query `prisma.prospect.findUnique({ where: { readableSlug: slug } })` with select:
     - `id, slug` (nanoid — critical for session tracking), `readableSlug, companyName, domain, industry, logoUrl, status`
     - `workflowHypotheses` where status `ACCEPTED`, orderBy confidenceScore desc, take 6, include `proofMatches` (orderBy score desc, take 3, include `useCase` select: id, title, summary, category, outcomes)
     - `workflowLossMaps` orderBy createdAt desc, take 1, select id
     - Also select the old JSON content fields for fallback: `heroContent, dataOpportunities, automationAgents, successStories, aiRoadmap`
   - Guard: if no prospect or status not in ['READY','SENT','VIEWED','ENGAGED','CONVERTED'], return `notFound()`.
   - Render `<DashboardClient>` with props:
     - `prospectSlug={prospect.slug}` (CRITICAL: pass the nanoid slug, NOT readableSlug)
     - `companyName={prospect.companyName ?? prospect.domain}`
     - `logoUrl={prospect.logoUrl}`
     - `industry={prospect.industry}`
     - `hypotheses={prospect.workflowHypotheses}` (serialized)
     - `lossMapId={prospect.workflowLossMaps[0]?.id ?? null}`
     - `bookingUrl={process.env.NEXT_PUBLIC_CALCOM_BOOKING_URL ?? null}`
     - `whatsappNumber={process.env.NEXT_PUBLIC_WHATSAPP_NUMBER ?? null}`
     - `phoneNumber={process.env.NEXT_PUBLIC_PHONE_NUMBER ?? null}`
     - `contactEmail={process.env.NEXT_PUBLIC_CONTACT_EMAIL ?? null}`
     - Fallback content: `heroContent, dataOpportunities` etc. as `Record<string, unknown>` (same casting as discover page)

**app/voor/[slug]/dashboard-client.tsx** — Client component. This is a fresh component, NOT a copy of wizard-client.tsx. It uses the same step-based navigation pattern but renders evidence-backed content:

1. Import `api` from `@/components/providers`, lucide icons, framer-motion.
2. Props interface `DashboardClientProps`:
   - `prospectSlug: string` (nanoid for session tracking)
   - `companyName: string`
   - `logoUrl: string | null`
   - `industry: string | null`
   - `hypotheses: Array<HypothesisData>` where HypothesisData includes title, problemStatement, confidenceScore, hoursSavedWeekMid, hoursSavedWeekLow, hoursSavedWeekHigh, handoffSpeedGainPct, errorReductionPct, revenueLeakageRecoveredMid, proofMatches array with useCase data
   - `lossMapId: string | null`
   - `bookingUrl: string | null`
   - `whatsappNumber: string | null`
   - `phoneNumber: string | null`
   - `contactEmail: string | null`
   - Fallback JSON fields: `heroContent, dataOpportunities, automationAgents, successStories, aiRoadmap` as `Record<string, unknown>`

3. Dashboard structure — 4 steps (not 6 like the old wizard, evidence content is denser):
   - Step 0: **Welkom** — Company hero with industry context, total hours saved summary from hypotheses, Klarifai branding
   - Step 1: **Pijnpunten** — Evidence-backed pain points from ACCEPTED hypotheses. Each hypothesis card shows: title, problemStatement, hoursSavedWeekMid (with low-high range), matched use cases from proofMatches. If no hypotheses, fall back to old `dataOpportunities` JSON content.
   - Step 2: **Oplossingen** — Matched use cases aggregated from all hypotheses' proofMatches. Show useCase.title, useCase.summary, useCase.outcomes. If proofMatches are empty but hypotheses exist, show hypothesis titles with "oplossing in voorbereiding" message. If no hypotheses at all, fall back to `automationAgents` or `successStories` content.
   - Step 3: **Contact** — Multi-channel contact section + quote request:
     - Download Report button (same as old wizard, uses lossMapId)
     - Cal.com booking button (same URL construction as old wizard)
     - WhatsApp button: `href="https://wa.me/${whatsappNumber.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(`Hallo Klarifai, ik heb de analyse voor ${companyName} bekeken en wil graag meer informatie.`)}"` — only show when whatsappNumber is provided
     - Phone button: `href="tel:${phoneNumber}"` — only show when phoneNumber is provided
     - Email button: `href="mailto:${contactEmail}?subject=${encodeURIComponent(`Offerte aanvraag - ${companyName}`)}"` — only show when contactEmail is provided
     - **Request Quote button**: Calls `api.wizard.requestQuote.useMutation()` with sessionId. Shows loading state, then confirmation message. Use `canvas-confetti` (already installed) for a small burst on success. Disable button after successful submission (quoteRequested state).

4. Session tracking — CRITICAL: Use `prospectSlug` (nanoid), NOT the readableSlug from the URL. All procedure names below are confirmed to exist in `server/routers/wizard.ts` and are already used by `wizard-client.tsx`:
   - `api.wizard.startSession.useMutation()` — call on mount with `{ slug: prospectSlug, userAgent: navigator.userAgent }`, store returned `sessionId` in state
   - `api.wizard.trackProgress.useMutation()` — call on step change with `{ sessionId, currentStep, stepTimes }`
   - `api.wizard.trackPdfDownload.useMutation()` — call on PDF download with `{ sessionId }` (confirmed: wizard.ts line 128, wizard-client.tsx line 90)
   - `api.wizard.trackCallBooked.useMutation()` — call on Cal.com booking click with `{ sessionId }` (confirmed: wizard.ts line 163, wizard-client.tsx line 91)

5. Visual design — Follow the same design language as wizard-client.tsx:
   - Same header with Klarifai K logo, company name, step indicators
   - Same progress bar gradient (from-klarifai-yellow to-klarifai-cyan)
   - Same glass-card styling
   - Same bottom navigation with Previous/Continue buttons
   - Same framer-motion transitions
   - Dutch labels: "Welkom", "Pijnpunten", "Oplossingen", "Contact"

6. Fallback behavior: If `hypotheses.length === 0`, show a fallback using the old JSON content fields if available, or show a message "Jouw analyse wordt nog verfijnd door ons team. Neem gerust alvast contact op." with the contact buttons.
   </action>
   <verify>
   Run `npm run check` — must pass.
   Verify `app/voor/[slug]/page.tsx` queries by readableSlug and passes prospect.slug (nanoid) as prospectSlug.
   Verify `app/voor/[slug]/dashboard-client.tsx` uses prospectSlug for all session tracking calls.
   Verify contact buttons only render when their env var is provided (conditional rendering).
   Verify fallback rendering works when hypotheses array is empty.
   </verify>
   <done>
   /voor/[slug] route resolves by readableSlug, renders evidence-backed dashboard with 4 steps, multi-channel contact, quote request, and full session tracking using nanoid slug.
   </done>
   </task>

<task type="auto">
  <name>Task 2: Update admin links to prefer /voor/ URL</name>
  <files>
    app/admin/prospects/page.tsx
    app/admin/prospects/[id]/page.tsx
    app/admin/prospects/new/page.tsx
  </files>
  <action>
1. **app/admin/prospects/page.tsx** — Update `copyLink` function and view link:
   - Change `copyLink` to accept prospect object (or slug + readableSlug): if `prospect.readableSlug` exists, construct URL as `${window.location.origin}/voor/${prospect.readableSlug}`, otherwise fall back to `${window.location.origin}/discover/${prospect.slug}`.
   - Update the `<Link>` element (line ~142): if `prospect.readableSlug`, href to `/voor/${prospect.readableSlug}`, otherwise `/discover/${prospect.slug}`.

2. **app/admin/prospects/[id]/page.tsx** — Update `copyLink` function and view link:
   - Same pattern: check `prospect.data.readableSlug` first, fall back to `prospect.data.slug` with `/discover/` prefix.
   - Update the Link at line ~467: prefer `/voor/` when readableSlug exists.
   - Add a small text indicator showing the readable URL when it exists: `<code className="text-xs text-slate-400">/voor/{p.readableSlug}</code>` near the share button area.

3. **app/admin/prospects/new/page.tsx** — Update the result display:
   - The result state stores slug. After enrichment completes and the result has a readableSlug (if available from the response), prefer showing `/voor/` URL. If not yet available (prospect just created, not enriched), show `/discover/` URL. This requires checking if the createProspect response includes readableSlug — it won't since it is set during enrichment. So for new prospects, always show `/discover/` URL initially. No change needed here unless we want to conditionally show it. Keep the existing `/discover/` URL display — admin will see `/voor/` after enrichment in the prospect list page.

Note: The `listProspects` query returns all Prospect fields (no select clause, uses include for \_count). The `readableSlug` field will automatically be available in the response without changing the query.
</action>
<verify>
Run `npm run check` — must pass.
Verify prospects list page copyLink uses readableSlug when available.
Verify prospect detail page copyLink uses readableSlug when available.
Verify /discover/ fallback is used when readableSlug is null.
</verify>
<done>
Admin UI prefers /voor/ readable URLs when readableSlug is set on a prospect, falls back to /discover/ for prospects without one. Backward compatibility maintained.
</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify prospect dashboard end-to-end</name>
  <files>app/voor/[slug]/page.tsx, app/voor/[slug]/dashboard-client.tsx</files>
  <action>
Human verification of the complete prospect dashboard. Claude has automated all code — this checkpoint verifies visual correctness, user interaction flow, and backward compatibility.

What was built:

- Complete prospect dashboard at /voor/[slug] with evidence-backed content from ACCEPTED hypotheses
- Multi-channel contact buttons (Cal.com, WhatsApp, phone, email)
- One-click quote request with admin notification
- Updated admin links preferring /voor/ URL when readableSlug exists
- Old /discover/[slug] wizard remains intact for backward compatibility

How to verify:

1. Pick a prospect with ACCEPTED hypotheses and a readableSlug (generate one via admin enrichment if needed)
2. Visit `/voor/{readableSlug}` — verify:
   - Step 0 (Welkom): Company name and hero content renders
   - Step 1 (Pijnpunten): ACCEPTED hypotheses show with titles, problem statements, hours saved
   - Step 2 (Oplossingen): Matched use cases from ProofMatch records display
   - Step 3 (Contact): Download Report, Book Call, and any configured contact buttons appear
   - Quote request button works and shows confirmation
3. Verify session tracking: Check admin prospect detail — WizardSession should show activity
4. Visit `/discover/{nanoid-slug}` — verify old wizard still works
5. Check admin prospects list — "Copy Link" button should generate /voor/ URL for prospects with readableSlug
6. Check admin prospect detail — share link should prefer /voor/ URL
   </action>
   <verify>User confirms all 6 verification steps pass.</verify>
   <done>Prospect dashboard verified: evidence content renders, contact buttons work, quote request fires, session tracking active, backward compat confirmed, admin links updated.</done>
   </task>

</tasks>

<verification>
1. `npm run check` passes
2. /voor/[slug] resolves by readableSlug and shows evidence dashboard
3. /discover/[slug] still works unchanged (backward compat)
4. Dashboard shows ACCEPTED hypotheses with matched use cases
5. Contact buttons render conditionally based on env vars
6. Quote request mutation fires and admin receives notification
7. Session tracking works (step times, PDF download, call booked)
8. Admin copy-link prefers /voor/ when readableSlug exists
9. Fallback content shows when no ACCEPTED hypotheses
</verification>

<success_criteria>
Prospect dashboard is fully functional: evidence-backed content from approved hypotheses, multi-channel contact options, one-click quote request with admin notification, readable Dutch URLs, and all existing engagement tracking continues to work. Admin links are updated to prefer the new URL format.
</success_criteria>

<output>
After completion, create `.planning/phases/11-prospect-dashboard/11-02-SUMMARY.md`
</output>
