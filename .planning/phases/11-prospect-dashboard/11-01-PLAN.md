---
phase: 11-prospect-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/20260221120000_readable_slug_and_quote/migration.sql
  - lib/readable-slug.ts
  - server/routers/admin.ts
  - server/routers/wizard.ts
  - lib/notifications.ts
  - env.mjs
autonomous: true

must_haves:
  truths:
    - 'Prospect model has a readableSlug field that is unique and nullable'
    - 'Enriching a prospect auto-generates a readableSlug from companyName when none exists'
    - 'Admin can manually generate or override a readableSlug for any prospect'
    - 'WizardSession has quoteRequested and quoteRequestedAt fields for tracking'
    - 'wizard.requestQuote mutation stores quote on session and notifies admin with quote_request type'
    - 'notifyAdmin supports quote_request type with Dutch subject and body'
    - 'NEXT_PUBLIC_WHATSAPP_NUMBER, NEXT_PUBLIC_PHONE_NUMBER, NEXT_PUBLIC_CONTACT_EMAIL declared in env.mjs'
  artifacts:
    - path: 'prisma/schema.prisma'
      provides: 'readableSlug field on Prospect, quoteRequested/quoteRequestedAt on WizardSession'
      contains: 'readableSlug'
    - path: 'lib/readable-slug.ts'
      provides: 'toReadableSlug and generateUniqueReadableSlug utilities'
      exports: ['toReadableSlug', 'generateUniqueReadableSlug']
    - path: 'server/routers/wizard.ts'
      provides: 'requestQuote public mutation'
      contains: 'requestQuote'
    - path: 'lib/notifications.ts'
      provides: 'quote_request notification type'
      contains: 'quote_request'
    - path: 'env.mjs'
      provides: 'Contact channel env vars'
      contains: 'NEXT_PUBLIC_WHATSAPP_NUMBER'
  key_links:
    - from: 'server/routers/admin.ts'
      to: 'lib/readable-slug.ts'
      via: 'generateUniqueReadableSlug call in enrichProspect'
      pattern: 'generateUniqueReadableSlug'
    - from: 'server/routers/wizard.ts'
      to: 'lib/notifications.ts'
      via: 'notifyAdmin call with type quote_request'
      pattern: 'notifyAdmin.*quote_request'
---

<objective>
Add the database schema, backend mutations, slug generation, env vars, and notification support needed for the prospect dashboard.

Purpose: All backend infrastructure must exist before the dashboard UI can render evidence data, generate readable URLs, handle quote requests, and display contact channels.
Output: Prisma migration applied, slug utility, enrichment auto-slug, requestQuote mutation, notifyAdmin extension, contact env vars.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-prospect-dashboard/11-RESEARCH.md

@prisma/schema.prisma
@server/routers/admin.ts
@server/routers/wizard.ts
@lib/notifications.ts
@env.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prisma schema migration + slug utility</name>
  <files>
    prisma/schema.prisma
    prisma/migrations/20260221120000_readable_slug_and_quote/migration.sql
    lib/readable-slug.ts
  </files>
  <action>
1. Add `readableSlug String? @unique @db.VarChar(80)` to the Prospect model in prisma/schema.prisma, after the existing `slug` field. Add `@@index([readableSlug])` to the Prospect @@index list.

2. Add `quoteRequested Boolean @default(false)` and `quoteRequestedAt DateTime?` to the WizardSession model in prisma/schema.prisma, after the existing `callBookedAt` field.

3. Create the migration SQL file at `prisma/migrations/20260221120000_readable_slug_and_quote/migration.sql`:

```sql
-- AlterTable
ALTER TABLE "Prospect" ADD COLUMN "readableSlug" VARCHAR(80);

-- AlterTable
ALTER TABLE "WizardSession" ADD COLUMN "quoteRequested" BOOLEAN NOT NULL DEFAULT false;
ALTER TABLE "WizardSession" ADD COLUMN "quoteRequestedAt" TIMESTAMP(3);

-- CreateIndex
CREATE UNIQUE INDEX "Prospect_readableSlug_key" ON "Prospect"("readableSlug");

-- CreateIndex
CREATE INDEX "Prospect_readableSlug_idx" ON "Prospect"("readableSlug");
```

4. Run `npx prisma migrate resolve --applied 20260221120000_readable_slug_and_quote` then `npx prisma generate` to sync the client.

5. Run the SQL directly: `npx prisma db execute --file prisma/migrations/20260221120000_readable_slug_and_quote/migration.sql`

6. Create `lib/readable-slug.ts` with two exported functions:

```typescript
import type { PrismaClient } from '@prisma/client';

export function toReadableSlug(companyName: string): string {
  return companyName
    .toLowerCase()
    .replace(/[^a-z0-9\s-]/g, '')
    .trim()
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .slice(0, 60);
}

export async function generateUniqueReadableSlug(
  db: PrismaClient,
  companyName: string,
): Promise<string> {
  const base = toReadableSlug(companyName);
  if (!base)
    return (
      companyName.slice(0, 8).toLowerCase().replace(/\s/g, '-') || 'prospect'
    );
  let candidate = base;
  let i = 2;
  while (await db.prospect.findUnique({ where: { readableSlug: candidate } })) {
    candidate = `${base}-${i}`;
    i++;
  }
  return candidate;
}
```

Pass PrismaClient as explicit `db` parameter (same pattern as matchProofs — keeps function testable).
</action>
<verify>
Run `npx prisma validate` — schema must pass validation.
Run `npx prisma generate` — client must generate without errors.
Verify the migration SQL file exists and has correct ALTER TABLE statements.
Verify `lib/readable-slug.ts` exports both functions.
</verify>
<done>
Prospect model has readableSlug field. WizardSession has quoteRequested/quoteRequestedAt. Slug utility functions are available for import.
</done>
</task>

<task type="auto">
  <name>Task 2: Backend wiring — enrichment auto-slug, quote mutation, notification, env vars</name>
  <files>
    server/routers/admin.ts
    server/routers/wizard.ts
    lib/notifications.ts
    env.mjs
  </files>
  <action>
1. **env.mjs** — Add three optional client env vars:
   - In the `client` section: `NEXT_PUBLIC_WHATSAPP_NUMBER: z.string().optional()`, `NEXT_PUBLIC_PHONE_NUMBER: z.string().optional()`, `NEXT_PUBLIC_CONTACT_EMAIL: z.string().email().optional()`
   - In the `runtimeEnv` section: add corresponding `NEXT_PUBLIC_WHATSAPP_NUMBER: process.env.NEXT_PUBLIC_WHATSAPP_NUMBER`, etc.

2. **server/routers/admin.ts** — Wire readableSlug auto-generation into `enrichProspect`:
   - Import `{ generateUniqueReadableSlug }` from `@/lib/readable-slug`
   - After `const enriched = await enrichCompany(...)` and before `ctx.db.prospect.update(...)`, check: if `enriched.companyName` is truthy and the current `prospect.readableSlug` is null, call `const readableSlug = await generateUniqueReadableSlug(ctx.db, enriched.companyName)` and include `readableSlug` in the update data object passed to `ctx.db.prospect.update`.
   - Add a new `generateReadableSlug` adminProcedure mutation:
     ```
     input: z.object({ id: z.string(), override: z.string().optional() })
     ```
     Logic: Find prospect by id. If `override` is provided, sanitize with `toReadableSlug(override)`. Otherwise generate from `prospect.companyName ?? prospect.domain`. Check uniqueness (not same prospect). Update prospect with new readableSlug. Return updated prospect.

3. **lib/notifications.ts** — Extend `NotifyOptions.type` union to include `'quote_request'`. Add `matchedUseCases?: string[]` optional field to `NotifyOptions`. Add to `subjects` map: `quote_request: \`${companyName} vraagt een offerte aan\``. Add to `bodies`map:`quote_request`with HTML containing company name, matched use cases list (if provided), and admin panel link. Use the same`env.NEXT_PUBLIC_APP_URL` pattern as existing entries.

4. **server/routers/wizard.ts** — Add `requestQuote` public procedure:
   - Input: `z.object({ sessionId: z.string(), message: z.string().max(500).optional() })`
   - Find wizardSession by id, include prospect with workflowHypotheses (where status ACCEPTED, take 3) including proofMatches (take 2) with useCase (select title).
   - If no session, return null.
   - Update wizardSession: set `quoteRequested: true`, `quoteRequestedAt: new Date()`.
   - Update prospect status to `CONVERTED` (if not already).
   - Build `matchedUseCases` string array from hypothesis proofMatches useCase titles.
   - Call `notifyAdmin({ prospectId, type: 'quote_request', companyName, slug, matchedUseCases })` fire-and-forget with `.catch(console.error)`.
   - Return `{ success: true }`.
     </action>
     <verify>
     Run `npm run check` (type-check + lint + format) — must pass with no errors.
     Verify `requestQuote` procedure exists in wizard router.
     Verify notifyAdmin handles 'quote_request' type in its type union.
     Verify env.mjs has the three new NEXT_PUBLIC env vars.
     Verify enrichProspect includes readableSlug auto-generation logic.
     </verify>
     <done>
     Enriching a prospect auto-generates readableSlug from companyName. Admin can override via generateReadableSlug mutation. wizard.requestQuote mutation creates quote tracking, sets CONVERTED status, and fires admin notification. notifyAdmin supports quote_request with matched use case context. Three contact channel env vars are declared.
     </done>
     </task>

</tasks>

<verification>
1. `npx prisma validate` passes
2. `npm run check` passes
3. Prospect schema has readableSlug with @unique
4. WizardSession schema has quoteRequested and quoteRequestedAt
5. lib/readable-slug.ts exports toReadableSlug and generateUniqueReadableSlug
6. server/routers/wizard.ts has requestQuote procedure
7. lib/notifications.ts type union includes quote_request
8. env.mjs has NEXT_PUBLIC_WHATSAPP_NUMBER, NEXT_PUBLIC_PHONE_NUMBER, NEXT_PUBLIC_CONTACT_EMAIL
9. server/routers/admin.ts enrichProspect calls generateUniqueReadableSlug
10. server/routers/admin.ts has generateReadableSlug mutation
</verification>

<success_criteria>
All backend infrastructure for Phase 11 is in place: schema migrated, slug utilities available, enrichment auto-generates readable slugs, admin can override slugs, quote request mutation works with notification, contact channel env vars declared.
</success_criteria>

<output>
After completion, create `.planning/phases/11-prospect-dashboard/11-01-SUMMARY.md`
</output>
