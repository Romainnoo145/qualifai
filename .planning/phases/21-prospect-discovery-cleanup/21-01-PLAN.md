---
phase: 21-prospect-discovery-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/enrichment/providers/apollo.ts
  - server/routers/search.ts
  - app/admin/prospects/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can type a sector keyword (e.g. 'marketingbureaus') and a location (e.g. 'Amsterdam, Netherlands') into the search form and receive Apollo results filtered by both"
    - "Admin can tick checkboxes on multiple search result rows and click a single 'Import Selected' button to import them all at once"
    - 'After batch import, a summary message shows how many were imported and how many were duplicates (already existed)'
    - 'Company name, domain, employee count, and industry are visible on each search result row before importing'
  artifacts:
    - path: 'lib/enrichment/providers/apollo.ts'
      provides: 'Apollo searchCompanies sends organization_keywords and cities in POST body'
      contains: 'organization_keywords'
    - path: 'server/routers/search.ts'
      provides: 'search.companies mutation accepts cities input param'
      contains: 'cities: z.array'
    - path: 'app/admin/prospects/page.tsx'
      provides: 'CompanySearch with sector + location fields, multi-select checkboxes, batch import button, import summary'
      contains: 'selectedDomains'
  key_links:
    - from: 'app/admin/prospects/page.tsx'
      to: 'server/routers/search.ts'
      via: 'search.companies mutation with industries + cities params'
      pattern: 'industries.*cities'
    - from: 'server/routers/search.ts'
      to: 'lib/enrichment/providers/apollo.ts'
      via: 'searchCompanies(filters) with cities forwarded'
      pattern: "cities: input\\.cities"
    - from: 'app/admin/prospects/page.tsx'
      to: 'server/routers/search.ts'
      via: 'importCompany.mutateAsync called in parallel for batch import'
      pattern: "Promise\\.allSettled"
---

<objective>
Add sector + location search and batch import to the existing company search UI.

Purpose: Admin can find prospects by typing a sector and location (e.g., "marketingbureaus Amsterdam") instead of adding companies one by one — the primary discovery workflow for new prospects.

Output: Extended CompanySearch component with sector/location fields wired through to Apollo, multi-select checkboxes, batch import button, and duplicate-aware summary message.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-prospect-discovery-cleanup/21-RESEARCH.md

@lib/enrichment/providers/apollo.ts
@lib/enrichment/types.ts
@server/routers/search.ts
@app/admin/prospects/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire industries and cities through to Apollo API</name>
  <files>
    lib/enrichment/providers/apollo.ts
    server/routers/search.ts
  </files>
  <action>
    **apollo.ts — searchCompanies method body:**
    In the `body` object of the `/mixed_companies/search` POST call (around line 619-634), add two new fields:

    1. Replace `organization_locations: filters.countries,` with:
       ```
       organization_locations: [...(filters.countries ?? []), ...(filters.cities ?? [])].filter(Boolean).length > 0
         ? [...(filters.countries ?? []), ...(filters.cities ?? [])]
         : undefined,
       ```
       This merges countries and cities into one array for Apollo (Apollo accepts both city and country strings in the same locations field).

    2. Add after `organization_locations`:
       ```
       organization_keywords: filters.industries?.length ? filters.industries : undefined,
       ```
       This sends sector keywords as free-text to Apollo. Do NOT use `organization_industry_tag_ids` — that requires mapping to Apollo's internal taxonomy.

    **search.ts — companies mutation input schema:**
    Add `cities: z.array(z.string()).optional(),` to the input z.object (after the existing `countries` field around line 66).

    Then in the mutation handler (around line 85-94), add `cities: input.cities,` to the object passed to `searchCompanies()`.

    Why NOT a new field name: `cities` already exists in `CompanySearchFilters` type (lib/enrichment/types.ts line 69), so the type layer is already correct. We are only wiring it through the router and Apollo provider.

  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors on the modified files.
    Grep for `organization_keywords` in apollo.ts to confirm it's present in the body.
    Grep for `cities` in search.ts to confirm it's in the input schema.
  </verify>
  <done>
    `search.companies` mutation accepts `cities` parameter; Apollo provider sends `organization_keywords` (from industries) and merged cities+countries in `organization_locations`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add sector/location fields, multi-select, and batch import to CompanySearch UI</name>
  <files>
    app/admin/prospects/page.tsx
  </files>
  <action>
    Modify the `CompanySearch` component function (starts around line 279). Changes:

    **1. Add new state variables** at the top of the component:
    ```typescript
    const [city, setCity] = useState('');
    const [selectedDomains, setSelectedDomains] = useState<Map<string, string>>(new Map());
    // Map<domain, companyName> — need both for importCompany mutation
    const [batchPending, setBatchPending] = useState(false);
    const [importSummary, setImportSummary] = useState<string | null>(null);
    ```

    **2. Update the search mutation `onSuccess`** to clear selection and summary when new search results arrive:
    ```typescript
    onSuccess: (data: any) => {
      setResults(data.results);
      setGuardrail((data.guardrail as SearchGuardrail | null) ?? null);
      setSelectedDomains(new Map());
      setImportSummary(null);
    },
    ```

    **3. Update `importCompany` mutation:** Remove the `onImported()` call from the single-import mutation's onSuccess. Instead, the batch handler will call `onImported()` after all imports complete. Keep `importCompany` mutation declared at top level (rules of hooks).

    **4. Update `handleSearch`** to also pass `cities`:
    ```typescript
    search.mutate({
      companyName: name || undefined,
      domain: domain || undefined,
      industries: industry ? [industry] : undefined,
      countries: country ? [country] : undefined,
      cities: city ? [city] : undefined,
    });
    ```

    **5. Relabel form fields** (Dutch-friendly for the user's workflow):
    - Rename "Industry" label to "Sector" and update placeholder to `"b.v. marketingbureaus, webdesign"`.
    - Rename "Country" label to "Land" (keep existing field for country).
    - Add a NEW "Locatie" (Location) field below the grid for the `city` state, with placeholder `"b.v. Amsterdam, Netherlands"`. This maps to Apollo's location field.
    - Rearrange to a 3-column top row (Company Name, Domain, Sector) and 2-column bottom row (Land, Locatie), or keep the 2-column grid and add the 5th field. Use `md:grid-cols-2` existing pattern — just add a 5th field row. The grid naturally wraps.

    **6. Add select-all checkbox and batch import bar** above the results list.
    When `results` is not null and has items, show a sticky action bar:
    ```tsx
    {results && results.length > 0 && (
      <div className="flex items-center justify-between gap-4 p-4 glass-card rounded-2xl">
        <label className="flex items-center gap-3 text-xs font-black text-slate-500 uppercase tracking-widest cursor-pointer">
          <input
            type="checkbox"
            checked={selectedDomains.size === results.length}
            onChange={(e) => {
              if (e.target.checked) {
                const all = new Map<string, string>();
                results.forEach((c: any) => all.set(c.domain, c.companyName ?? c.domain));
                setSelectedDomains(all);
              } else {
                setSelectedDomains(new Map());
              }
            }}
            className="w-4 h-4 rounded accent-[#040026]"
          />
          {selectedDomains.size} geselecteerd
        </label>
        {selectedDomains.size > 0 && (
          <button
            onClick={handleBatchImport}
            disabled={batchPending}
            className="ui-tap flex items-center gap-2 px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest bg-[#040026] text-white hover:bg-[#EBCB4B] hover:text-[#040026] transition-all disabled:opacity-50"
          >
            {batchPending ? <Loader2 className="w-4 h-4 animate-spin" /> : <Plus className="w-4 h-4" />}
            Importeer geselecteerd
          </button>
        )}
      </div>
    )}
    ```

    **7. Add checkbox to each result row.** In the result card (around line 428-479), add a checkbox as the first element inside the flex container, before the logo:
    ```tsx
    <input
      type="checkbox"
      checked={selectedDomains.has(company.domain)}
      onChange={(e) => {
        const next = new Map(selectedDomains);
        if (e.target.checked) {
          next.set(company.domain, company.companyName ?? company.domain);
        } else {
          next.delete(company.domain);
        }
        setSelectedDomains(next);
      }}
      className="w-4 h-4 rounded accent-[#040026] shrink-0"
    />
    ```

    **8. Remove the per-row "Import" button.** The individual import button on each result card (around line 466-477) is replaced by the batch import flow. Delete the per-row `<button>` that calls `importCompany.mutate`.

    **9. Add `handleBatchImport` function** after the mutation declarations:
    ```typescript
    const handleBatchImport = async () => {
      setBatchPending(true);
      setImportSummary(null);
      try {
        const entries = Array.from(selectedDomains.entries());
        const results = await Promise.allSettled(
          entries.map(([domain, companyName]) =>
            importCompany.mutateAsync({ domain, companyName: companyName || undefined })
          ),
        );
        const fulfilled = results.filter(
          (r): r is PromiseFulfilledResult<any> => r.status === 'fulfilled',
        );
        const imported = fulfilled.filter((r) => !r.value.alreadyExists).length;
        const skipped = fulfilled.filter((r) => r.value.alreadyExists).length;
        const failed = results.length - fulfilled.length;
        let summary = `${imported} geïmporteerd`;
        if (skipped > 0) summary += `, ${skipped} al aanwezig`;
        if (failed > 0) summary += `, ${failed} mislukt`;
        setImportSummary(summary);
        setSelectedDomains(new Map());
        utils.admin.listProspects.invalidate();
      } finally {
        setBatchPending(false);
      }
    };
    ```

    **10. Show import summary** below the action bar when `importSummary` is set:
    ```tsx
    {importSummary && (
      <div className="flex items-center gap-3 p-4 rounded-2xl bg-emerald-50 border border-emerald-200">
        <Check className="w-5 h-5 text-emerald-600 shrink-0" />
        <p className="text-sm font-bold text-emerald-800">{importSummary}</p>
      </div>
    )}
    ```

    **Important anti-patterns to avoid:**
    - Do NOT call `useMutation` inside a loop — define `importCompany` once at top level, use `mutateAsync` in the handler
    - Do NOT rely on `importCompany.isPending` for batch state — it only tracks the last call; use `batchPending` local state instead
    - Keep the existing `Check` icon import (already imported) for the summary checkmark

  </action>
  <verify>
    Run `npm run check` — no type errors, no lint errors.
    Visually inspect: CompanySearch should show Sector + Locatie fields, checkboxes on results, batch import button with summary.
  </verify>
  <done>
    CompanySearch has sector (maps to industries/organization_keywords) and location (maps to cities/organization_locations) input fields. Results show checkboxes. "Importeer geselecteerd" button imports all selected in parallel with duplicate-aware summary ("N geïmporteerd, M al aanwezig").
  </done>
</task>

</tasks>

<verification>
1. Type-check: `npx tsc --noEmit` passes with zero errors on all modified files
2. Lint: `npm run check` passes
3. Functional: Search with sector "marketing" and location "Amsterdam, Netherlands" returns Apollo results showing company name, domain, industry, employee range
4. Functional: Selecting 3 results and clicking "Importeer geselecteerd" creates prospects; summary shows correct imported/skipped count
5. Functional: Re-importing the same companies shows "0 geïmporteerd, 3 al aanwezig"
</verification>

<success_criteria>

- Sector field sends `organization_keywords` to Apollo API
- Location field sends city string merged into `organization_locations`
- Multi-select checkboxes + batch import button work
- Import summary displays correct counts including duplicates
- No type errors, no lint errors
  </success_criteria>

<output>
After completion, create `.planning/phases/21-prospect-discovery-cleanup/21-01-SUMMARY.md`
</output>
