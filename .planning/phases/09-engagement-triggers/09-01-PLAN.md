---
phase: 09-engagement-triggers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - env.mjs
  - app/api/webhooks/resend/route.ts
  - lib/outreach/send-email.ts
autonomous: true
user_setup:
  - service: resend
    why: 'Webhook endpoint must be registered in Resend dashboard to receive events'
    env_vars:
      - name: RESEND_WEBHOOK_SECRET
        source: 'Resend Dashboard -> Webhooks -> Add Endpoint -> Signing Secret (starts with whsec_...)'
    dashboard_config:
      - task: 'Create webhook endpoint pointing to https://<your-domain>/api/webhooks/resend'
        location: 'Resend Dashboard -> Webhooks -> Add Endpoint'
      - task: 'Subscribe to email.opened and email.clicked event types'
        location: 'Resend Dashboard -> Webhooks -> (endpoint) -> Event Types'

must_haves:
  truths:
    - 'Resend webhook POST to /api/webhooks/resend with valid Svix signature returns 200'
    - 'Resend webhook POST with invalid signature returns 400'
    - 'email.opened event updates OutreachLog.openedAt for the matching resendMessageId'
    - 'email.clicked event is captured without creating a call task'
    - 'Email opens never create call tasks or trigger cadence escalation'
    - 'Every sent email stores resendMessageId in OutreachLog.metadata'
  artifacts:
    - path: 'app/api/webhooks/resend/route.ts'
      provides: 'Resend webhook handler with Svix verification'
      exports: ['POST']
    - path: 'env.mjs'
      provides: 'RESEND_WEBHOOK_SECRET env var definition'
      contains: 'RESEND_WEBHOOK_SECRET'
    - path: 'lib/outreach/send-email.ts'
      provides: 'resendMessageId capture from resend.emails.send() return value'
      contains: 'resendMessageId'
  key_links:
    - from: 'app/api/webhooks/resend/route.ts'
      to: 'prisma.outreachLog'
      via: 'metadata JSON path query on resendMessageId'
      pattern: 'metadata.*path.*resendMessageId'
    - from: 'lib/outreach/send-email.ts'
      to: 'resend.emails.send()'
      via: 'captures return value id as resendMessageId'
      pattern: 'resendMessageId'
---

<objective>
Capture Resend email open/click events via webhook and store resendMessageId at send time for correlation.

Purpose: ENGAG-04 requires email open/click event capture with signature verification. ENGAG-05 requires that opens never trigger cadence escalation. The resendMessageId stored at send time enables correlating webhook events back to specific OutreachLog records.

Output: Working `/api/webhooks/resend` route with Svix verification, `openedAt` update on email.opened, click metadata storage on email.clicked, and resendMessageId captured in send-email.ts.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-engagement-triggers/09-RESEARCH.md

@env.mjs
@lib/outreach/send-email.ts
@app/api/webhooks/calcom/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Resend webhook route with Svix verification and event capture</name>
  <files>env.mjs, app/api/webhooks/resend/route.ts</files>
  <action>
1. Add `RESEND_WEBHOOK_SECRET` to env.mjs:
   - In `server` block: `RESEND_WEBHOOK_SECRET: z.string().min(8).optional()`
   - In `runtimeEnv` block: `RESEND_WEBHOOK_SECRET: process.env.RESEND_WEBHOOK_SECRET`
   - Match the pattern used by CALCOM_WEBHOOK_SECRET (optional, runtime 500 if missing)

2. Create `app/api/webhooks/resend/route.ts` as a Next.js App Router POST handler:
   - Import `Resend` from 'resend', `env` from '@/env.mjs', `prisma` from '@/lib/prisma'
   - Early return 500 if `env.RESEND_WEBHOOK_SECRET` is not configured (match calcom route pattern)
   - Read raw body with `await req.text()` FIRST (critical: do NOT call req.json() before this)
   - Call `resend.webhooks.verify()` with:
     - `payload: rawBody`
     - `headers: { id: req.headers.get('svix-id') ?? '', timestamp: req.headers.get('svix-timestamp') ?? '', signature: req.headers.get('svix-signature') ?? '' }`
     - `webhookSecret: env.RESEND_WEBHOOK_SECRET`
   - Wrap verify in try/catch; return 400 on failure with `{ error: 'Invalid webhook signature' }`
   - For `email.opened` event:
     - Extract `event.data.email_id`
     - Find OutreachLog via `prisma.outreachLog.findFirst({ where: { metadata: { path: ['resendMessageId'], equals: emailId } } })`
     - If found and `openedAt` is null, update `openedAt` to `new Date(event.created_at)`
     - Do NOT create any call task or trigger any escalation (ENGAG-05)
   - For `email.clicked` event:
     - Same lookup by resendMessageId
     - If found, update metadata by merging a `clicks` array (append click object with `link`, `timestamp`, `userAgent` from event.data.click)
     - Do NOT create any call task (ENGAG-05)
   - For all other event types: return `{ received: true }` without processing
   - Return `{ received: true }` on success

IMPORTANT: Do NOT use node:crypto HMAC for Resend. Resend uses Svix multi-header signing, not HMAC-SHA256. The `resend.webhooks.verify()` method handles this.
</action>
<verify> - `npx tsc --noEmit` passes (type-check the new route) - Manually verify the route file uses `req.text()` before `verify()` and never calls `createEngagementCallTask`
</verify>
<done> - `/api/webhooks/resend` POST route exists with Svix signature verification - email.opened updates OutreachLog.openedAt via resendMessageId correlation - email.clicked stores click data in OutreachLog metadata - No call task creation or cadence escalation from open/click events - RESEND_WEBHOOK_SECRET defined as optional in env.mjs
</done>
</task>

<task type="auto">
  <name>Task 2: Capture resendMessageId in send-email.ts</name>
  <files>lib/outreach/send-email.ts</files>
  <action>
In `lib/outreach/send-email.ts`, modify the `sendOutreachEmail` function:

1. Capture the return value of `resend.emails.send()`:
   - Change from `await resend.emails.send({ ... })` (discards return) to:
     ```
     const { data: sendResult, error: sendError } = await resend.emails.send({ ... });
     if (sendError) { throw sendError; }
     ```
   - Adjust the existing try/catch to use `sendError`/`sendResult` pattern

2. Store `resendMessageId` in the OutreachLog metadata:
   - In the `messageMetadata` object or in the `prisma.outreachLog.create` data, add:
     `resendMessageId: sendResult?.id ?? null`
   - This goes into the metadata JSON, not a separate column

3. Keep existing error handling: if send fails, status = 'failed', sentAt = null. The resendMessageId will be null in the failure case.

The existing `messageMetadata` object already spreads into the metadata field. Add `resendMessageId` to it:

```typescript
const messageMetadata = {
  ...(metadata ?? {}),
  unsubscribeUrl,
  resendMessageId: null as string | null, // will be set after send
  emailQuality: { ... },
};
```

Then after successful send: `messageMetadata.resendMessageId = sendResult?.id ?? null;`
</action>
<verify> - `npx tsc --noEmit` passes - Grep `send-email.ts` for `resendMessageId` â€” must appear in metadata - Verify the return value of `resend.emails.send()` is captured (not discarded)
</verify>
<done> - `resend.emails.send()` return value is captured - `resendMessageId` is stored in OutreachLog.metadata for every sent email - Failed sends store `resendMessageId: null` - Webhook route can correlate email events back to OutreachLog via metadata path query
</done>
</task>

</tasks>

<verification>
1. `npm run check` passes (type-check + lint + format)
2. `app/api/webhooks/resend/route.ts` exists and exports POST
3. `env.mjs` contains RESEND_WEBHOOK_SECRET in both server and runtimeEnv blocks
4. `lib/outreach/send-email.ts` captures resend.emails.send() return and stores resendMessageId
5. No reference to `createEngagementCallTask` or `createHmac` in the webhook route
</verification>

<success_criteria>

- Resend webhook events are verified with Svix and captured without triggering cadence actions
- Email opens update OutreachLog.openedAt; clicks store click data in metadata
- All sent emails have resendMessageId in their OutreachLog metadata for correlation
- ENGAG-04 and ENGAG-05 are satisfied
  </success_criteria>

<output>
After completion, create `.planning/phases/09-engagement-triggers/09-01-SUMMARY.md`
</output>
