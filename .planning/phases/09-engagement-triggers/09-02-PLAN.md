---
phase: 09-engagement-triggers
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/outreach/engagement-triggers.ts
  - server/routers/wizard.ts
  - lib/outreach/reply-workflow.ts
autonomous: true

must_haves:
  truths:
    - 'When a prospect reaches wizard step 3 or beyond, a call task is created immediately without admin action'
    - 'When a prospect downloads the PDF, a call task is created immediately without admin action'
    - 'When a reply is triaged as interested, a call task is created immediately without admin action'
    - 'The same engagement type for the same prospect never creates duplicate call tasks'
    - 'If a prospect has no contacts, the trigger skips gracefully without error'
  artifacts:
    - path: 'lib/outreach/engagement-triggers.ts'
      provides: 'createEngagementCallTask utility with contact resolution and dedup guard'
      exports: ['createEngagementCallTask']
    - path: 'server/routers/wizard.ts'
      provides: 'trackProgress calls createEngagementCallTask on maxStep >= 3'
      contains: 'createEngagementCallTask'
    - path: 'server/routers/wizard.ts'
      provides: 'trackPdfDownload calls createEngagementCallTask'
      contains: 'pdf_download'
    - path: 'lib/outreach/reply-workflow.ts'
      provides: 'applyReplyTriage calls createEngagementCallTask on interested intent'
      contains: 'interested_reply'
  key_links:
    - from: 'lib/outreach/engagement-triggers.ts'
      to: 'prisma.outreachLog'
      via: 'dedup check with metadata JSON path query on triggerSource'
      pattern: 'metadata.*path.*triggerSource'
    - from: 'server/routers/wizard.ts'
      to: 'lib/outreach/engagement-triggers.ts'
      via: 'import createEngagementCallTask'
      pattern: 'createEngagementCallTask.*wizard_step3'
    - from: 'lib/outreach/reply-workflow.ts'
      to: 'lib/outreach/engagement-triggers.ts'
      via: 'import createEngagementCallTask'
      pattern: 'createEngagementCallTask.*interested_reply'
---

<objective>
Create shared engagement trigger utility and wire it into wizard step 3+, PDF download, and interested reply triage to automatically create call tasks with deduplication.

Purpose: ENGAG-01, ENGAG-02, ENGAG-03 require immediate call task creation on engagement signals. The dedup guard (originally roadmap plan 09-03) is built directly into the utility since the dedup check IS the first step of task creation -- they cannot be separated without creating a broken intermediate state.

Output: `createEngagementCallTask` utility in `lib/outreach/engagement-triggers.ts`, wired into `wizard.ts` (trackProgress + trackPdfDownload) and `reply-workflow.ts` (applyReplyTriage).
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-engagement-triggers/09-RESEARCH.md

@server/routers/wizard.ts
@lib/outreach/reply-workflow.ts
@server/routers/outreach.ts (for touch task metadata schema reference: kind, priority, dueAt, notes, createdBy pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create engagement trigger utility with contact resolution and dedup guard</name>
  <files>lib/outreach/engagement-triggers.ts</files>
  <action>
Create `lib/outreach/engagement-triggers.ts` with the following:

1. Define `TriggerSource` type: `'wizard_step3' | 'pdf_download' | 'interested_reply'`

2. Implement `resolveContactId(db: PrismaClient, prospectId: string): Promise<string | null>`:
   - Priority 1: Find most recent OutreachSequence with non-null contactId for this prospect, ordered by updatedAt desc. Return sequence.contactId.
   - Priority 2: Find earliest Contact for this prospect where outreachStatus is not 'OPTED_OUT', ordered by createdAt asc. Return contact.id.
   - If neither found, return null.

3. Implement `createEngagementCallTask(db: PrismaClient, prospectId: string, triggerSource: TriggerSource): Promise<{ created: boolean; taskId: string | null; reason?: string }>`:
   - **Dedup check first:** Query `db.outreachLog.findFirst` where:
     - `channel: 'call'`
     - `status: 'touch_open'`
     - `contact: { prospectId }` (relation filter)
     - `metadata: { path: ['triggerSource'], equals: triggerSource }`
   - If existing found, return `{ created: false, taskId: existing.id, reason: 'already_exists' }`
   - Call `resolveContactId`. If null, `console.warn` and return `{ created: false, taskId: null, reason: 'no_contact' }`
   - Create OutreachLog with:
     - `contactId` from resolved contact
     - `type: 'FOLLOW_UP'`
     - `channel: 'call'`
     - `status: 'touch_open'`
     - `subject`: Use trigger-specific text:
       - wizard_step3: `'Follow-up: prospect engaged with wizard (step 3+)'`
       - pdf_download: `'Follow-up: prospect downloaded PDF report'`
       - interested_reply: `'Follow-up: prospect replied with interest'`
     - `metadata: { kind: 'touch_task', priority: 'high', dueAt: null, notes: null, createdBy: 'engagement-trigger', triggerSource, prospectId } as never`
   - Return `{ created: true, taskId: task.id }`

4. Export `createEngagementCallTask` (and TriggerSource type).

Match the touch task metadata schema from `outreach.ts` queueTouchTask (kind, priority, dueAt, notes, createdBy). Add `triggerSource` and `prospectId` for dedup and traceability.

IMPORTANT: The function accepts PrismaClient as explicit `db` parameter (not module-level singleton) -- follows established pattern from matchProofs and reply-workflow.
</action>
<verify> - `npx tsc --noEmit` passes - File exports `createEngagementCallTask` - Dedup check uses `metadata: { path: ['triggerSource'], equals: triggerSource }` pattern - No direct import of prisma singleton (takes db as parameter)
</verify>
<done> - `createEngagementCallTask` utility exists with contact resolution, dedup guard, and call task creation - Dedup key is (prospectId via contact relation, triggerSource via metadata path) - Missing contact handled gracefully with console.warn and skip - Touch task metadata matches existing queueTouchTask schema
</done>
</task>

<task type="auto">
  <name>Task 2: Wire engagement triggers into wizard trackProgress, trackPdfDownload, and reply triage</name>
  <files>server/routers/wizard.ts, lib/outreach/reply-workflow.ts</files>
  <action>
1. In `server/routers/wizard.ts`:

a. Add import at top: `import { createEngagementCallTask } from '@/lib/outreach/engagement-triggers';`

b. In `trackProgress` mutation, after the `if (maxStep >= 3)` block that updates prospect status to ENGAGED, add:
`       // Create engagement call task (fire-and-forget, non-blocking)
      createEngagementCallTask(ctx.db, session.prospectId, 'wizard_step3').catch(console.error);
      `
Place this INSIDE the `if (maxStep >= 3)` block, after the `ctx.db.prospect.update`.

c. In `trackPdfDownload` mutation, after the existing `notifyAdmin(...).catch(console.error)` call, add:
`       // Create engagement call task for PDF download
      createEngagementCallTask(ctx.db, session.prospectId, 'pdf_download').catch(console.error);
      `

Both calls use `.catch(console.error)` for fire-and-forget. Engagement task creation must NEVER block or error the public wizard flow.

2. In `lib/outreach/reply-workflow.ts`:

   a. Add import at top: `import { createEngagementCallTask } from '@/lib/outreach/engagement-triggers';`

   b. In `applyReplyTriage`, inside the existing `if (intent === 'interested')` block (which already sets prospect status to ENGAGED), add AFTER the prospect update:

   ```
   await createEngagementCallTask(db, reply.contact.prospectId, 'interested_reply');
   ```

   Use `await` here (not fire-and-forget) because reply triage is an admin action, not a public endpoint. The await ensures the task is created before the triage result is returned. But wrap in try/catch to prevent triage failure if task creation fails:

   ```
   try {
     await createEngagementCallTask(db, reply.contact.prospectId, 'interested_reply');
   } catch (err) {
     console.error('Failed to create engagement call task for interested reply:', err);
   }
   ```

IMPORTANT:

- wizard.ts uses `ctx.db` (from tRPC context)
- reply-workflow.ts uses `db` parameter (PrismaClient passed in)
- Both are correct -- follow the existing parameter style in each file
  </action>
  <verify> - `npx tsc --noEmit` passes - `npm run check` passes - Grep wizard.ts for `createEngagementCallTask` — must appear in both trackProgress and trackPdfDownload - Grep reply-workflow.ts for `createEngagementCallTask` — must appear in applyReplyTriage - Grep wizard.ts for 'wizard_step3' and 'pdf_download' - Grep reply-workflow.ts for 'interested_reply'
  </verify>
  <done> - Wizard step 3+ creates a call task via createEngagementCallTask (ENGAG-01) - PDF download creates a call task via createEngagementCallTask (ENGAG-02) - Interested reply triage creates a call task via createEngagementCallTask (ENGAG-03) - All three trigger points are fire-and-forget or try/catch — never block the primary flow - Dedup guard prevents duplicate tasks on repeated wizard visits, PDF clicks, or re-triages
  </done>
  </task>

</tasks>

<verification>
1. `npm run check` passes (type-check + lint + format)
2. `lib/outreach/engagement-triggers.ts` exports `createEngagementCallTask`
3. `server/routers/wizard.ts` calls `createEngagementCallTask` in both `trackProgress` (wizard_step3) and `trackPdfDownload` (pdf_download)
4. `lib/outreach/reply-workflow.ts` calls `createEngagementCallTask` in `applyReplyTriage` for interested intent (interested_reply)
5. Dedup guard uses Prisma JSON path query on `metadata.triggerSource` — same pattern as calcom/route.ts bookingUid dedup
6. No file imports prisma singleton directly — all use `db` parameter or `ctx.db`
</verification>

<success_criteria>

- Three engagement signals (wizard step 3+, PDF download, interested reply) each create immediate call tasks
- Duplicate tasks prevented by dedup guard using (prospectId, triggerSource) composite key
- Missing contact handled gracefully without errors
- Public wizard endpoints never block on task creation failures
- ENGAG-01, ENGAG-02, ENGAG-03 satisfied
  </success_criteria>

<output>
After completion, create `.planning/phases/09-engagement-triggers/09-02-SUMMARY.md`
</output>
