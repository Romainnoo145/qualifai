---
phase: 20-one-click-send-queue-pipeline-view
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/pipeline-stage.ts
  - components/features/prospects/pipeline-chip.tsx
  - server/routers/admin.ts
  - app/admin/prospects/page.tsx
  - app/admin/prospects/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - 'Every prospect in the Companies list shows a pipeline stage chip (Imported, Researching, Reviewed, Ready, Sending, Engaged, or Booked) instead of the raw ProspectStatus enum'
    - 'The prospect detail header shows the same pipeline stage chip alongside the QualityChip'
    - 'Pipeline stage is correctly derived from prospect status, research run status, session data, and outreach state'
  artifacts:
    - path: 'lib/pipeline-stage.ts'
      provides: 'computePipelineStage pure function and PipelineStage type'
      exports: ['computePipelineStage', 'PipelineStage']
    - path: 'components/features/prospects/pipeline-chip.tsx'
      provides: 'PipelineChip React component'
      exports: ['PipelineChip']
  key_links:
    - from: 'app/admin/prospects/page.tsx'
      to: 'components/features/prospects/pipeline-chip.tsx'
      via: 'import PipelineChip'
      pattern: 'PipelineChip'
    - from: 'app/admin/prospects/page.tsx'
      to: 'lib/pipeline-stage.ts'
      via: 'import computePipelineStage'
      pattern: 'computePipelineStage'
    - from: 'app/admin/prospects/[id]/page.tsx'
      to: 'components/features/prospects/pipeline-chip.tsx'
      via: 'import PipelineChip'
      pattern: 'PipelineChip'
    - from: 'server/routers/admin.ts'
      to: 'prisma.prospect.findMany'
      via: 'listProspects sessions include for booked detection'
      pattern: 'sessions.*callBooked'
---

<objective>
Create the `computePipelineStage` pure function, `PipelineChip` UI component, extend `listProspects` data to include pipeline-relevant fields, and wire the chip into the Companies list and prospect detail header — replacing the raw ProspectStatus badge.

Purpose: PIPE-01 requires every prospect to show a visible pipeline stage chip (Imported / Researching / Reviewed / Ready / Sending / Engaged / Booked) on the list view and detail header. The raw enum values (DRAFT, ENRICHED, GENERATING...) are meaningless to the admin. The pipeline chip provides a human-readable status that communicates state at a glance.

Output: New `lib/pipeline-stage.ts` and `components/features/prospects/pipeline-chip.tsx` files. Modified list and detail pages with PipelineChip replacing the raw status badge.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-one-click-send-queue-pipeline-view/20-RESEARCH.md
@server/routers/admin.ts
@app/admin/prospects/page.tsx
@app/admin/prospects/[id]/page.tsx
@components/features/prospects/quality-chip.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create computePipelineStage helper and PipelineChip component + extend listProspects</name>
  <files>lib/pipeline-stage.ts, components/features/prospects/pipeline-chip.tsx, server/routers/admin.ts</files>
  <action>
**A. Create `lib/pipeline-stage.ts`:**

Export `PipelineStage` type and `computePipelineStage` pure function. Follow the exact stage mapping from research:

```typescript
export type PipelineStage =
  | 'Imported'
  | 'Researching'
  | 'Reviewed'
  | 'Ready'
  | 'Sending'
  | 'Engaged'
  | 'Booked';

interface ProspectForStage {
  status: string; // ProspectStatus enum value
  researchRun?: {
    status: string; // ResearchStatus enum value
    qualityApproved: boolean | null;
  } | null;
  hasSession: boolean; // _count.sessions > 0
  hasBookedSession: boolean; // any session with callBooked === true
}

export function computePipelineStage(p: ProspectForStage): PipelineStage {
  // Priority order: most advanced stage first
  if (p.hasBookedSession || p.status === 'CONVERTED') return 'Booked';
  if (p.status === 'VIEWED' || p.status === 'ENGAGED' || p.hasSession)
    return 'Engaged';
  if (p.status === 'SENT') return 'Sending';
  if (p.status === 'READY') return 'Ready';
  if (
    p.researchRun?.qualityApproved === true &&
    p.status !== 'DRAFT' &&
    p.status !== 'GENERATING'
  )
    return 'Reviewed';
  if (
    p.status === 'ENRICHED' ||
    p.status === 'GENERATING' ||
    (p.researchRun?.status &&
      ['PENDING', 'CRAWLING', 'EXTRACTING', 'HYPOTHESIS', 'BRIEFING'].includes(
        p.researchRun.status,
      ))
  )
    return 'Researching';
  return 'Imported';
}
```

**B. Create `components/features/prospects/pipeline-chip.tsx`:**

Small colored chip matching the existing chip pattern (9px font, rounded-full, uppercase tracking-widest). Use the `cn` utility from `@/lib/utils`.

```typescript
import { cn } from '@/lib/utils';
import type { PipelineStage } from '@/lib/pipeline-stage';

const STAGE_COLORS: Record<PipelineStage, string> = {
  Imported:    'bg-slate-50 text-slate-500 border-slate-100',
  Researching: 'bg-blue-50 text-blue-600 border-blue-100',
  Reviewed:    'bg-indigo-50 text-indigo-600 border-indigo-100',
  Ready:       'bg-emerald-50 text-emerald-600 border-emerald-100',
  Sending:     'bg-amber-50 text-amber-600 border-amber-100',
  Engaged:     'bg-purple-50 text-purple-600 border-purple-100',
  Booked:      'bg-yellow-50 text-yellow-700 border-yellow-100',
};

export function PipelineChip({ stage }: { stage: PipelineStage }) {
  return (
    <span className={cn(
      'text-[9px] font-black px-3 py-1 rounded-full uppercase tracking-widest border',
      STAGE_COLORS[stage],
    )}>
      {stage}
    </span>
  );
}
```

**C. Extend `listProspects` in `server/routers/admin.ts`:**

Add to the existing `include` block in `listProspects` (around line 399-415):

1. Add `sessions` include for booked-session detection (alongside existing `_count` and `researchRuns`):

```typescript
sessions: {
  where: { callBooked: true },
  take: 1,
  select: { id: true },
},
```

This goes at the same level as `_count` and `researchRuns` in the existing include block. The `researchRuns` select already has `status: true` (added in Phase 18), so no change needed there.
</action>
<verify>Run `npx tsc --noEmit` — zero errors. Verify `lib/pipeline-stage.ts` and `components/features/prospects/pipeline-chip.tsx` exist.</verify>
<done>computePipelineStage pure function exported, PipelineChip component created, listProspects includes booked-session data for stage computation.</done>
</task>

<task type="auto">
  <name>Task 2: Wire PipelineChip into Companies list and prospect detail header</name>
  <files>app/admin/prospects/page.tsx, app/admin/prospects/[id]/page.tsx</files>
  <action>
**A. Replace raw status badge with PipelineChip in `app/admin/prospects/page.tsx`:**

1. Import `PipelineChip` from `@/components/features/prospects/pipeline-chip` and `computePipelineStage` from `@/lib/pipeline-stage`.

2. In the prospect row (around line 181-189), **replace** the existing raw status badge:

```tsx
{
  /* OLD — remove this entire block */
}
<span
  className={cn(
    'text-[9px] font-black px-3 py-1 rounded-full uppercase tracking-widest border',
    statusColors[prospect.status] ||
      'bg-slate-50 text-slate-400 border-slate-100',
  )}
>
  {prospect.status}
</span>;
```

With the PipelineChip:

```tsx
<PipelineChip
  stage={computePipelineStage({
    status: prospect.status,
    researchRun: prospect.researchRuns?.[0]
      ? {
          status: prospect.researchRuns[0].status,
          qualityApproved: prospect.researchRuns[0].qualityApproved,
        }
      : null,
    hasSession: (prospect._count?.sessions ?? 0) > 0,
    hasBookedSession: (prospect.sessions?.length ?? 0) > 0,
  })}
/>
```

3. Remove the `statusColors` const map (lines ~32-42) since it is no longer used. If any other part of the file references `statusColors`, check and remove those references too.

**B. Replace StatusBadge with PipelineChip in `app/admin/prospects/[id]/page.tsx`:**

1. Import `PipelineChip` from `@/components/features/prospects/pipeline-chip` and `computePipelineStage` from `@/lib/pipeline-stage`.

2. In the "Back row" section (around line 94), **replace** `<StatusBadge status={p.status} />` with:

```tsx
<PipelineChip
  stage={computePipelineStage({
    status: p.status,
    researchRun: researchRuns.data?.[0]
      ? {
          status: researchRuns.data[0].status,
          qualityApproved:
            (researchRuns.data[0] as any).qualityApproved ?? null,
        }
      : null,
    hasSession: (p._count?.sessions ?? 0) > 0,
    hasBookedSession: p.sessions?.some((s: any) => s.callBooked) ?? false,
  })}
/>
```

3. Remove the `StatusBadge` import if it is no longer used elsewhere in the file.

Note: `getProspect` returns ALL sessions (not filtered by `callBooked`). Use `p.sessions?.some((s: any) => s.callBooked) ?? false` for `hasBookedSession` — each WizardSession object includes the `callBooked` boolean. Do NOT use `(p.sessions?.length ?? 0) > 0` which would incorrectly mark any prospect with a /voor/ visit as "Booked".
</action>
<verify>Run `npx tsc --noEmit` — zero errors. Open `/admin/prospects` in browser and verify pipeline chips appear instead of raw enum labels.</verify>
<done>Companies list shows PipelineChip (Imported/Researching/Reviewed/Ready/Sending/Engaged/Booked) replacing the raw ProspectStatus badge. Prospect detail header shows the same PipelineChip replacing StatusBadge.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `lib/pipeline-stage.ts` exists and exports `computePipelineStage` and `PipelineStage`
3. `components/features/prospects/pipeline-chip.tsx` exists and exports `PipelineChip`
4. `grep -n "statusColors" app/admin/prospects/page.tsx` returns no matches (old badge removed)
5. `grep -n "PipelineChip" app/admin/prospects/page.tsx` shows import and usage
6. `grep -n "PipelineChip" app/admin/prospects/\[id\]/page.tsx` shows import and usage
7. `grep -n "StatusBadge" app/admin/prospects/\[id\]/page.tsx` returns no matches (replaced)
</verification>

<success_criteria>
Every prospect in the Companies list and prospect detail header shows a human-readable pipeline stage chip. The raw ProspectStatus enum labels no longer appear on the list row.
</success_criteria>

<output>
After completion, create `.planning/phases/20-one-click-send-queue-pipeline-view/20-02-SUMMARY.md`
</output>
