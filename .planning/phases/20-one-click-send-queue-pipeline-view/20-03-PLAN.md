---
phase: 20-one-click-send-queue-pipeline-view
plan: 03
type: execute
wave: 2
depends_on: ['20-01']
files_modified:
  - server/routers/admin.ts
  - app/admin/page.tsx
autonomous: true

must_haves:
  truths:
    - 'Action queue hides prospects that are still in the Researching stage — only actionable-stage prospects appear'
    - 'Prospects with recent /voor/ dashboard activity (page visit, PDF download, call booked) appear earlier in the queue than unengaged prospects'
    - 'Each draft row in the dashboard shows an inline content preview (subject + truncated body) and a single Send button that calls approveDraft'
    - 'Clicking the Send button on a draft row sends the email, the row disappears, and a second click is prevented by the idempotency guard'
  artifacts:
    - path: 'server/routers/admin.ts'
      provides: 'Enhanced getActionQueue with research-in-progress filter, engagement ranking, and inline preview data'
      contains: 'researchRuns'
    - path: 'app/admin/page.tsx'
      provides: 'Dashboard with inline send button for drafts'
      contains: 'approveDraft'
  key_links:
    - from: 'app/admin/page.tsx'
      to: 'api.outreach.approveDraft'
      via: 'useMutation call from inline send button'
      pattern: 'approveDraft.*mutate'
    - from: 'server/routers/admin.ts'
      to: 'prisma.outreachLog.findMany'
      via: 'getActionQueue researchRuns none filter'
      pattern: 'researchRuns.*none'
    - from: 'server/routers/admin.ts'
      to: 'prisma.wizardSession'
      via: 'getActionQueue session engagement data'
      pattern: 'sessions.*orderBy.*updatedAt'
---

<objective>
Enhance `getActionQueue` to filter out research-in-progress prospects (PIPE-02), rank engaged prospects higher (PIPE-03), and include inline preview data for drafts. Then update the dashboard UI with inline send buttons for draft rows.

Purpose: SEND-01 requires admin can approve and send a draft with one click from the dashboard, seeing an inline content preview without navigating. PIPE-02 eliminates noise from prospects still being researched. PIPE-03 surfaces recently engaged prospects first so the admin acts on hot leads immediately.

Output: Enhanced getActionQueue backend with research filter + engagement ranking + preview data. Dashboard page with inline send button on draft rows.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-one-click-send-queue-pipeline-view/20-RESEARCH.md
@.planning/phases/20-one-click-send-queue-pipeline-view/20-01-SUMMARY.md
@.planning/phases/20-one-click-send-queue-pipeline-view/20-02-SUMMARY.md
@.planning/phases/15-action-queue-dashboard/15-01-SUMMARY.md
@.planning/phases/15-action-queue-dashboard/15-02-SUMMARY.md
@server/routers/admin.ts
@app/admin/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance getActionQueue — research filter, engagement ranking, and draft preview data</name>
  <files>server/routers/admin.ts</files>
  <action>
Modify `getActionQueue` in `server/routers/admin.ts` (currently at line ~489):

**A. PIPE-02: Research-in-progress filter**

Add a filter to each of the four parallel queries to exclude prospects with active research runs:

1. For `workflowHypothesis` query (query 1), add to the `where` clause:

```typescript
where: {
  status: 'DRAFT',
  prospect: {
    researchRuns: {
      none: {
        status: { in: ['PENDING', 'CRAWLING', 'EXTRACTING', 'HYPOTHESIS', 'BRIEFING'] },
      },
    },
  },
},
```

2. For `outreachLog` queries (queries 2, 3, 4 — draftLogs, touchTasks, replies), add the filter nested through `contact.prospect`:

```typescript
contact: {
  prospect: {
    researchRuns: {
      none: {
        status: { in: ['PENDING', 'CRAWLING', 'EXTRACTING', 'HYPOTHESIS', 'BRIEFING'] },
      },
    },
  },
},
```

Add this to the existing `where` clause of each outreachLog query, alongside the existing `status` filter.

**B. PIPE-03: Engagement data for ranking**

Extend the `prospect` select in each query to include recent session data:

For the `workflowHypothesis` query, the prospect select is `{ id, companyName, domain }`. Extend to:

```typescript
prospect: {
  select: {
    id: true,
    companyName: true,
    domain: true,
    sessions: {
      orderBy: { updatedAt: 'desc' as const },
      take: 1,
      select: { createdAt: true, pdfDownloadedAt: true, callBookedAt: true, updatedAt: true },
    },
  },
},
```

For the three `outreachLog` queries, extend `contact.prospect.select` similarly to add `sessions`.

After mapping items, compute `engagementAt` per item:

```typescript
function latestEngagementAt(
  sessions: {
    createdAt: Date;
    pdfDownloadedAt: Date | null;
    callBookedAt: Date | null;
    updatedAt: Date;
  }[],
): Date | null {
  if (sessions.length === 0) return null;
  const s = sessions[0]!;
  const candidates = [s.updatedAt, s.pdfDownloadedAt, s.callBookedAt].filter(
    Boolean,
  ) as Date[];
  return candidates.length > 0
    ? new Date(Math.max(...candidates.map((d) => d.getTime())))
    : s.createdAt;
}
```

Add this as a helper function near `parseDueAt`. Add `engagementAt` to each mapped item object (nullable Date).

Update the sort to use engagement as secondary: overdue first, then engaged prospects (non-null engagementAt, most recent first), then oldest createdAt:

```typescript
.sort((a, b) => {
  if (a.urgency === 'overdue' && b.urgency !== 'overdue') return -1;
  if (a.urgency !== 'overdue' && b.urgency === 'overdue') return 1;
  // Engaged prospects surface first
  if (a.engagementAt && !b.engagementAt) return -1;
  if (!a.engagementAt && b.engagementAt) return 1;
  if (a.engagementAt && b.engagementAt) return b.engagementAt.getTime() - a.engagementAt.getTime();
  return a.createdAt.getTime() - b.createdAt.getTime();
});
```

**C. Draft preview data**

For `draftLogs` query (query 2) only, add `bodyText` to the outreachLog select so the dashboard can show an inline preview. The `subject` field is already included. Add `bodyText: true` to the query (or it's already fetched — check the include/select). If the query uses `include` (fetches all fields), `bodyText` is already available. If it uses `select`, add it.

Add `preview` field to `draftItems` map:

```typescript
preview: log.bodyText?.slice(0, 200) ?? '',
```

The ActionItem type will need `preview?: string` and `engagementAt?: Date | null` added.
</action>
<verify>Run `npx tsc --noEmit` — zero errors. The `getActionQueue` response now includes `preview` on draft items and `engagementAt` on all items.</verify>
<done>getActionQueue filters out research-in-progress prospects, ranks engaged prospects higher, and includes bodyText preview on draft items.</done>
</task>

<task type="auto">
  <name>Task 2: Update dashboard UI with inline send button for draft rows</name>
  <files>app/admin/page.tsx</files>
  <action>
Modify `app/admin/page.tsx` to add inline send functionality on draft rows:

**A. Add tRPC mutation for approveDraft:**

```typescript
const utils = api.useUtils();
const approveDraft = api.outreach.approveDraft.useMutation({
  onSuccess: () => {
    utils.admin.getActionQueue.invalidate();
  },
});
```

Add these inside the default export component, alongside the existing `getActionQueue` query.

**B. Update the ActionItem type:**

Extend the local ActionItem type to include the new fields:

```typescript
type ActionItem = {
  id: string;
  type: 'hypothesis' | 'draft' | 'task' | 'reply';
  prospectId: string;
  prospectName: string;
  title: string;
  createdAt: Date | string;
  urgency: 'overdue' | 'normal';
  channel?: string | null;
  dueAt?: string | null;
  preview?: string;
  engagementAt?: Date | string | null;
};
```

**C. Refactor ActionRow to handle draft vs non-draft items (CRITICAL: avoid `<button>` inside `<Link>`):**

The current `ActionRow` renders as a full `<Link>` wrapper (lines 99-134 in `app/admin/page.tsx`). Placing an interactive `<button>` inside `<Link>` is invalid HTML (interactive inside interactive) — the click propagates to the Link and navigates instead of firing the mutation.

**Solution:** Split ActionRow into two render paths. Draft items render as a `<div>` (no link), non-draft items keep the `<Link>` wrapper:

```tsx
const ActionRow = ({
  item,
  onSendDraft,
}: {
  item: ActionItem;
  onSendDraft?: (id: string) => void;
  isPending?: boolean;
}) => {
  const isOverdue = item.urgency === 'overdue';

  const content = (
    <>
      <div className="flex-1 min-w-0 mr-4">
        <p className="font-bold text-sm text-[#040026]">{item.prospectName}</p>
        <p className="text-xs text-slate-500 truncate max-w-md">{item.title}</p>
        {item.preview && (
          <p className="text-[10px] text-slate-400 line-clamp-2 mt-1 max-w-lg">
            {item.preview}
          </p>
        )}
        {item.type === 'task' && item.channel && (
          <div className="flex items-center gap-1 mt-1">
            <ChannelIcon channel={item.channel} />
          </div>
        )}
      </div>
      <div className="flex flex-col items-end gap-1 shrink-0">
        {item.engagementAt && (
          <span className="text-[9px] font-black text-purple-500 uppercase tracking-widest">
            Active
          </span>
        )}
        {isOverdue && (
          <span className="text-[9px] font-bold text-red-600 bg-red-50 px-1.5 py-0.5 rounded">
            OVERDUE
          </span>
        )}
        {item.type === 'task' && item.dueAt && !isOverdue && (
          <span className="text-[10px] text-slate-400">
            {new Date(item.dueAt).toLocaleDateString('nl-NL', {
              day: 'numeric',
              month: 'short',
            })}
          </span>
        )}
        <span className="text-[10px] text-slate-400">
          {timeAgo(item.createdAt)}
        </span>
      </div>
    </>
  );

  const wrapperClass = cn(
    'glass-card p-5 mb-2 rounded-2xl flex items-center justify-between transition-all',
    isOverdue && 'border-l-4 border-red-500',
  );

  // Draft items: render as <div> with inline Send button (NOT inside a <Link>)
  if (item.type === 'draft') {
    return (
      <div className={wrapperClass}>
        {content}
        <button
          onClick={() => onSendDraft?.(item.id)}
          disabled={isPending}
          className={cn(
            'ui-tap flex items-center gap-2 px-5 py-2 text-[10px] font-black uppercase tracking-widest rounded-full border transition-all ml-3',
            isPending
              ? 'bg-slate-50 text-slate-300 border-slate-100 cursor-not-allowed'
              : 'bg-emerald-50 text-emerald-600 border-emerald-100 hover:bg-emerald-100',
          )}
        >
          {isPending ? (
            <Loader2 className="w-3 h-3 animate-spin" />
          ) : (
            <Send className="w-3 h-3" />
          )}
          Send
        </button>
      </div>
    );
  }

  // Non-draft items: render as <Link> (existing behavior)
  const href =
    item.type === 'hypothesis'
      ? `/admin/prospects/${item.prospectId}#analysis`
      : '/admin/outreach';

  return (
    <Link href={href} className={cn(wrapperClass, 'hover:border-[#EBCB4B]/30')}>
      {content}
    </Link>
  );
};
```

Note: `isPending` and `onSendDraft` are passed from the parent section. In the ActionSection (or wherever ActionRow is rendered in a loop), pass them through:

```tsx
<ActionRow
  key={item.id}
  item={item}
  onSendDraft={(id) => approveDraft.mutate({ id })}
  isPending={approveDraft.isPending}
/>
```

1. Import `Send` and `Loader2` from `lucide-react` (add to existing imports).

2. The `approveDraft` mutation receives `{ id: item.id }` — no subject/bodyHtml overrides (uses existing draft content as-is for one-click send).

3. Add error handling: add `onError` that calls `utils.admin.getActionQueue.invalidate()` so the stale row disappears on refresh:

```typescript
const approveDraft = api.outreach.approveDraft.useMutation({
  onSuccess: () => {
    utils.admin.getActionQueue.invalidate();
  },
  onError: () => {
    // Refresh queue — draft was likely already sent (idempotency guard)
    utils.admin.getActionQueue.invalidate();
  },
});
```

**D. Keep non-draft items linking to their existing destinations:**

- Hypothesis items: keep linking to `/admin/prospects/[id]#analysis`
- Task items: keep linking to `/admin/outreach`
- Reply items: keep linking to `/admin/outreach`

Only draft items get the inline send button (rendered as `<div>`, not inside `<Link>`).
</action>
<verify>Run `npx tsc --noEmit` — zero errors. Open `/admin` in browser and verify draft rows have Send button, non-draft rows still link normally.</verify>
<done>Dashboard draft rows show inline content preview + one-click Send button. Clicking Send calls approveDraft (with idempotency guard from Plan 01). Queue refreshes on success or conflict error. Engaged prospects show Active indicator.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `grep -n "researchRuns" server/routers/admin.ts` shows `none` filter in getActionQueue queries
3. `grep -n "engagementAt" server/routers/admin.ts` shows engagement ranking in sort
4. `grep -n "approveDraft" app/admin/page.tsx` shows mutation wiring
5. `grep -n "Send" app/admin/page.tsx` shows inline send button
6. `grep -n "preview" app/admin/page.tsx` shows inline content preview rendering
</verification>

<success_criteria>
Action queue hides researching-stage prospects. Engaged prospects appear first. Draft rows have inline preview + one-click send. The send button is disabled during mutation and the queue refreshes after send.
</success_criteria>

<output>
After completion, create `.planning/phases/20-one-click-send-queue-pipeline-view/20-03-SUMMARY.md`
</output>
