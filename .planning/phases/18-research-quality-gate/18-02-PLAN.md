---
phase: 18-research-quality-gate
plan: 02
type: execute
wave: 2
depends_on: ['18-01']
files_modified:
  - components/features/prospects/quality-chip.tsx
  - app/admin/prospects/page.tsx
  - app/admin/prospects/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - 'Every prospect row in the admin list shows a traffic-light chip (red/amber/green) derived from evidence count'
    - 'Admin can click the quality chip to see a breakdown: evidence count, average confidence, source type count, hypothesis count'
    - 'Admin can mark research as reviewed (approve quality) or re-run research from the quality breakdown'
    - "Admin can proceed with an amber-quality prospect by confirming 'proceed with limited research'"
    - 'Quality chip appears in prospect detail header alongside the status badge'
    - 'Quality review state (approved/not reviewed) is visible on subsequent visits'
  artifacts:
    - path: 'components/features/prospects/quality-chip.tsx'
      provides: 'QualityChip component with traffic-light dot and inline breakdown accordion'
      min_lines: 80
    - path: 'app/admin/prospects/page.tsx'
      provides: 'Quality chip rendered in each prospect row'
      contains: 'QualityChip'
    - path: 'app/admin/prospects/[id]/page.tsx'
      provides: 'Quality chip in prospect detail header'
      contains: 'QualityChip'
  key_links:
    - from: 'components/features/prospects/quality-chip.tsx'
      to: 'server/routers/research.ts'
      via: 'approveQuality mutation and getRun query'
      pattern: 'approveQuality|getRun'
    - from: 'app/admin/prospects/page.tsx'
      to: 'components/features/prospects/quality-chip.tsx'
      via: 'QualityChip import'
      pattern: 'import.*QualityChip'
    - from: 'app/admin/prospects/[id]/page.tsx'
      to: 'components/features/prospects/quality-chip.tsx'
      via: 'QualityChip import'
      pattern: 'import.*QualityChip'
---

<objective>
Create the QualityChip component with traffic-light indicator and inline quality breakdown, then wire it into both the prospect list page and prospect detail header.

Purpose: Gives admin at-a-glance research quality visibility across the entire prospect pipeline and enables quality review decisions directly from the chip.
Output: QualityChip component, prospect list shows quality chips, prospect detail header shows quality chip.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/18-research-quality-gate/18-RESEARCH.md
@.planning/phases/18-research-quality-gate/18-01-SUMMARY.md
@components/features/prospects/evidence-section.tsx
@app/admin/prospects/page.tsx
@app/admin/prospects/[id]/page.tsx
@lib/workflow-engine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create QualityChip component with traffic-light indicator and inline breakdown</name>
  <files>components/features/prospects/quality-chip.tsx</files>
  <action>
Create a new file `components/features/prospects/quality-chip.tsx` with a `QualityChip` component.

**Props interface:**

```typescript
interface QualityChipProps {
  // From listProspects: latest run data (list view)
  runId: string | null;
  evidenceCount: number;
  hypothesisCount: number;
  qualityApproved: boolean | null; // null = not reviewed
  qualityReviewedAt: Date | string | null;
  // Optional: for detail view where we have full data
  runStatus?: string;
}
```

**Chip display (collapsed state):**

- A small rounded-full chip matching the existing status chip pattern from prospects/page.tsx (text-[9px] font-black px-3 py-1 rounded-full uppercase tracking-widest border)
- Traffic light color based on `computeTrafficLight` imported from `lib/workflow-engine.ts`:
  - Red: `bg-red-50 text-red-600 border-red-100` — label "THIN"
  - Amber: `bg-amber-50 text-amber-600 border-amber-100` — label "LIMITED"
  - Green: `bg-emerald-50 text-emerald-600 border-emerald-100` — label "SOLID"
- If `qualityApproved === true`, overlay a small checkmark or show "REVIEWED" suffix
- If no runId (no research yet), show nothing (return null)
- On list view, use `evidenceCount` alone as traffic-light proxy: call `computeTrafficLight(evidenceCount, 1, 0.65)` — source diversity unknown on list, so assume worst case 1 source type. This means list chips may show amber when detail would show green. That's acceptable — list is indicative, detail is definitive.

**Inline breakdown (expanded state on click):**

- Use the EvidenceCard expand/collapse pattern: `useState(false)`, button toggles
- When expanded, fetch full run data via `api.research.getRun.useQuery({ runId })` (lazy — only when open)
- Show breakdown rows (compact, no card wrapper — just a small floating panel below the chip):
  - Evidence items: count + average confidence (from getRun evidence items)
  - Source types: count distinct source types from evidence items
  - Hypotheses: count
  - Quality gate reasons (from `evaluateQualityGate` computed client-side from evidence items)
- Show "Reviewed" badge with timestamp if `qualityApproved !== null`
- Action buttons in breakdown:
  - If NOT reviewed: "Approve Research" button (calls `api.research.approveQuality.useMutation({ runId, approved: true })`)
  - If amber AND not reviewed: Show amber warning text "Limited evidence — proceed?" with "Approve Anyway" button that calls approveQuality with `notes: "Proceed with limited research — amber override"`
  - If reviewed (qualityApproved === true): Show "Reviewed ✓" in green, with a "Re-run Research" button that calls `api.research.retryRun.useMutation({ runId })`
  - If reviewed (qualityApproved === false): Show "Needs more research" label
- On successful approve or re-run, invalidate `admin.listProspects` and `research.listRuns` queries

**Styling notes:**

- Match the existing chip styling exactly (text-[9px] font-black uppercase tracking-widest)
- Breakdown panel: absolute positioned below chip, glass-card style, z-20, max-w-xs
- Click outside closes the breakdown (useEffect with document click listener)
- Use `cn()` from `@/lib/utils` for conditional classes
  </action>
  <verify>
- `npm run check` passes
- File exists at `components/features/prospects/quality-chip.tsx`
- Component exports `QualityChip`
- Uses `computeTrafficLight` from `lib/workflow-engine.ts`
- Uses `api.research.approveQuality` and `api.research.getRun`
  </verify>
  <done>QualityChip component renders traffic-light chip with inline expandable breakdown, approve/re-run actions, and amber override flow.</done>
  </task>

<task type="auto">
  <name>Task 2: Wire QualityChip into prospect list page and prospect detail header</name>
  <files>app/admin/prospects/page.tsx, app/admin/prospects/[id]/page.tsx</files>
  <action>
1. **app/admin/prospects/page.tsx** — Add QualityChip to each prospect row:
   - Import `QualityChip` from `@/components/features/prospects/quality-chip`
   - In the prospect row (around line 170-210, inside the flex container that has the company name and status chip), add the QualityChip after the existing status chip:
   ```tsx
   {/* After the existing status span */}
   {(() => {
     const run = prospect.researchRuns?.[0];
     return run ? (
       <QualityChip
         runId={run.id}
         evidenceCount={run._count.evidenceItems}
         hypothesisCount={run._count.workflowHypotheses}
         qualityApproved={run.qualityApproved}
         qualityReviewedAt={run.qualityReviewedAt}
       />
     ) : null;
   })()}
   ```
   - The `prospect.researchRuns` data is available from the extended `listProspects` query (Plan 01 Task 2 added this).
   - Note: The `prospect` variable from listProspects is typed via Prisma inference, which now includes `researchRuns`. If TS complains about the type, cast `prospect as any` following the established project pattern (Phase 13/14 used this for deep inference TS2589).

2. **app/admin/prospects/[id]/page.tsx** — Add QualityChip to detail header:
   - Import `QualityChip` from `@/components/features/prospects/quality-chip`
   - The detail page already queries `researchRuns` via `api.research.listRuns.useQuery({ prospectId: id })` (line 44). Use the first run's data.
   - Add the chip in the hero section (around line 98, near the StatusBadge), after the back-row:
   ```tsx
   {
     /* In the back row, after StatusBadge */
   }
   {
     researchRuns.data?.[0] && (
       <QualityChip
         runId={researchRuns.data[0].id}
         evidenceCount={researchRuns.data[0]._count.evidenceItems}
         hypothesisCount={researchRuns.data[0]._count.workflowHypotheses}
         qualityApproved={(researchRuns.data[0] as any).qualityApproved ?? null}
         qualityReviewedAt={
           (researchRuns.data[0] as any).qualityReviewedAt ?? null
         }
         runStatus={researchRuns.data[0].status}
       />
     );
   }
   ```

   - Note: `listRuns` query in research.ts does not yet include `qualityApproved` / `qualityReviewedAt` in its select. Either: (a) extend the `listRuns` query's include/select to add these two fields, OR (b) use a separate query. Option (a) is simpler — add `qualityApproved: true` and `qualityReviewedAt: true` to the `listRuns` findMany select. Do this in `server/routers/research.ts` in the `listRuns` procedure — the current query does NOT use a `select` (it uses `include`), so the full model fields are already returned. Since we added nullable fields to the model, they'll automatically be returned. Just cast as any if TS doesn't infer them yet.
     </action>
     <verify>

- `npm run check` passes
- `grep -n 'QualityChip' app/admin/prospects/page.tsx` shows import and usage
- `grep -n 'QualityChip' app/admin/prospects/[id]/page.tsx` shows import and usage
- No TypeScript errors related to QualityChip props
  </verify>
  <done>Prospect list shows traffic-light quality chip per row. Prospect detail header shows quality chip with full breakdown capability. Both views allow quality review actions.</done>
  </task>

</tasks>

<verification>
1. `npm run check` — full TypeScript + lint + format passes
2. Prospect list page shows a quality chip (red/amber/green) next to each prospect's status chip
3. Clicking the quality chip opens an inline breakdown with evidence count, source types, confidence, and hypothesis count
4. Admin can approve quality from the breakdown (button calls approveQuality mutation)
5. Admin can "approve anyway" for amber prospects with an explicit confirmation
6. Prospect detail header shows the same quality chip
7. After approving, the chip updates to show "REVIEWED" state
</verification>

<success_criteria>

- QualityChip component exists with traffic-light display and inline breakdown
- Every prospect row in the admin list shows the quality chip
- Prospect detail header shows the quality chip
- Admin can approve quality and proceed with amber overrides
- Quality review state persists and is visible on subsequent page loads
  </success_criteria>

<output>
After completion, create `.planning/phases/18-research-quality-gate/18-02-SUMMARY.md`
</output>
