---
phase: 18-research-quality-gate
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - server/routers/research.ts
  - server/routers/admin.ts
  - lib/workflow-engine.ts
autonomous: true

must_haves:
  truths:
    - 'ResearchRun has nullable qualityApproved, qualityReviewedAt, qualityNotes fields in the database'
    - 'HypothesisStatus enum includes PENDING and DECLINED values alongside existing DRAFT, ACCEPTED, REJECTED'
    - 'Admin can call approveQuality mutation to record a quality review decision on a research run'
    - "listProspects returns the latest research run's evidence count and quality review state per prospect"
    - 'computeTrafficLight function maps evidence count, source type count, and average confidence to red/amber/green'
  artifacts:
    - path: 'prisma/schema.prisma'
      provides: 'ResearchRun quality fields + PENDING/DECLINED enum values'
      contains: 'qualityApproved'
    - path: 'server/routers/research.ts'
      provides: 'approveQuality tRPC mutation'
      contains: 'approveQuality'
    - path: 'server/routers/admin.ts'
      provides: 'listProspects extended with research run quality data'
      contains: 'researchRuns'
    - path: 'lib/workflow-engine.ts'
      provides: 'computeTrafficLight pure function'
      exports: ['computeTrafficLight']
  key_links:
    - from: 'server/routers/research.ts'
      to: 'prisma.researchRun.update'
      via: 'approveQuality mutation'
      pattern: 'qualityApproved.*qualityReviewedAt'
    - from: 'server/routers/admin.ts'
      to: 'prisma.prospect.findMany'
      via: 'listProspects include researchRuns'
      pattern: 'researchRuns.*take.*1'
---

<objective>
Add the schema foundation and backend procedures for the research quality gate: Prisma migration (ResearchRun quality fields + HypothesisStatus enum extension), tRPC approveQuality mutation, extended listProspects query with quality data, and a computeTrafficLight pure function.

Purpose: Plans 02 and 03 need these schema fields, the tRPC mutation, and the traffic-light helper to build the UI layer.
Output: Migration applied, approveQuality procedure callable, listProspects returns quality data, computeTrafficLight exported from workflow-engine.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-research-quality-gate/18-RESEARCH.md
@prisma/schema.prisma
@server/routers/research.ts
@server/routers/admin.ts
@lib/workflow-engine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema migration — add quality fields to ResearchRun and PENDING/DECLINED to HypothesisStatus</name>
  <files>prisma/schema.prisma</files>
  <action>
1. Add two new values to the `HypothesisStatus` enum (after REJECTED):
   - `PENDING` — quality-approved, awaiting client validation on /voor/
   - `DECLINED` — client declined the hypothesis on /voor/ (Phase 19 will set this)

2. Add three nullable fields to the `ResearchRun` model (after `summary Json?`):
   - `qualityApproved Boolean?` — null = not reviewed, true = approved, false = needs more research
   - `qualityReviewedAt DateTime?` — when the admin reviewed
   - `qualityNotes String?` — free-text override reason (e.g., "proceeding, thin market")

3. Run `npx prisma migrate dev --name add_quality_gate_fields` to generate and apply the migration.
   - If migration fails due to DB drift (same pattern as Phase 17, Plan 02), apply the SQL manually via docker exec psql and create the migration file with `prisma migrate resolve --applied`.
   - The enum extension uses `ALTER TYPE ... ADD VALUE` which PostgreSQL handles outside a transaction. Prisma generates this correctly (confirmed by Phase 17's REGISTRY enum extension).

4. Run `npx prisma generate` to regenerate the client.

Important: Do NOT change `@default(DRAFT)` on WorkflowHypothesis or AutomationOpportunity — both keep DRAFT as default. Do NOT run any data migration — existing ACCEPTED rows stay as-is.
</action>
<verify>

- `npx prisma validate` passes
- Migration file exists in `prisma/migrations/`
- `npx prisma generate` completes without errors
- `npm run check` passes (TypeScript compilation)
  </verify>
  <done>Database has qualityApproved, qualityReviewedAt, qualityNotes columns on ResearchRun (all nullable). HypothesisStatus enum includes PENDING and DECLINED. All existing data untouched.</done>
  </task>

<task type="auto">
  <name>Task 2: Add computeTrafficLight helper, approveQuality tRPC mutation, and extend listProspects with quality data</name>
  <files>lib/workflow-engine.ts, server/routers/research.ts, server/routers/admin.ts</files>
  <action>
1. **lib/workflow-engine.ts** — Add `computeTrafficLight` pure function (export it):
   ```typescript
   export type TrafficLight = 'red' | 'amber' | 'green';

export interface QualityBreakdown {
trafficLight: TrafficLight;
evidenceCount: number;
averageConfidence: number;
sourceTypeCount: number;
hypothesisCount: number;
reasons: string[];
}

export function computeTrafficLight(
evidenceCount: number,
sourceTypeCount: number,
averageConfidence: number,
): TrafficLight {
if (evidenceCount < 3) return 'red';
if (sourceTypeCount < 2 || averageConfidence < 0.65) return 'amber';
return 'green';
}

````
Place this right after the existing `evaluateQualityGate` function (around line 391). The function mirrors the thresholds from `evaluateQualityGate` but returns a three-state traffic light instead of binary pass/fail. Red = critically thin (< 3 evidence items), amber = minor shortfall (low source diversity or confidence), green = all pass.

2. **server/routers/research.ts** — Add `approveQuality` mutation after the existing `approveEvidence` procedure:
```typescript
approveQuality: adminProcedure
  .input(
    z.object({
      runId: z.string(),
      approved: z.boolean(),
      notes: z.string().optional(),
    }),
  )
  .mutation(async ({ ctx, input }) => {
    return ctx.db.researchRun.update({
      where: { id: input.runId },
      data: {
        qualityApproved: input.approved,
        qualityReviewedAt: new Date(),
        qualityNotes: input.notes ?? null,
      },
    });
  }),
````

3. **server/routers/admin.ts** — Extend `listProspects` query include to add the latest research run's quality data. In the `include` block of `ctx.db.prospect.findMany` (currently has `_count: { select: { sessions: true, contacts: true } }`), add:
   ```typescript
   include: {
     _count: { select: { sessions: true, contacts: true } },
     researchRuns: {
       orderBy: { createdAt: 'desc' as const },
       take: 1,
       select: {
         id: true,
         status: true,
         qualityApproved: true,
         qualityReviewedAt: true,
         _count: { select: { evidenceItems: true, workflowHypotheses: true } },
       },
     },
   },
   ```
   This gives the list view the latest run's evidence count and quality review state without loading full evidence items. Source type diversity is NOT included here (avoids N+1) — it's computed on chip expand from `research.getRun`.
   </action>
   <verify>

- `npm run check` passes (TypeScript compilation validates new types and procedure)
- The tRPC router compiles without errors
- Verify `computeTrafficLight` export: `grep -n 'computeTrafficLight' lib/workflow-engine.ts` shows both function declaration and export
- Verify `approveQuality` exists: `grep -n 'approveQuality' server/routers/research.ts`
- Verify `researchRuns` in listProspects: `grep -n 'researchRuns' server/routers/admin.ts`
  </verify>
  <done>computeTrafficLight exported from workflow-engine.ts. approveQuality mutation callable on research router. listProspects returns latest research run's id, status, qualityApproved, qualityReviewedAt, and evidence/hypothesis counts per prospect.</done>
  </task>

</tasks>

<verification>
1. `npx prisma validate` — schema is valid
2. `npm run check` — full TypeScript + lint + format passes
3. New migration file exists under `prisma/migrations/`
4. `computeTrafficLight(2, 1, 0.5)` returns `'red'`, `computeTrafficLight(5, 1, 0.7)` returns `'amber'`, `computeTrafficLight(5, 3, 0.8)` returns `'green'`
</verification>

<success_criteria>

- Schema migration applied with quality fields on ResearchRun and PENDING/DECLINED on HypothesisStatus
- computeTrafficLight pure function exported and usable by UI components
- approveQuality tRPC mutation persists quality review decisions
- listProspects returns quality data for each prospect's latest research run
- All checks pass (`npm run check`)
  </success_criteria>

<output>
After completion, create `.planning/phases/18-research-quality-gate/18-01-SUMMARY.md`
</output>
