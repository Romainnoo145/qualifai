---
phase: 07-evidence-approval-gate
plan: 02
type: execute
wave: 2
depends_on: ['07-01']
files_modified:
  - app/admin/hypotheses/page.tsx
  - app/admin/layout.tsx
  - app/admin/prospects/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - 'Admin can navigate to /admin/hypotheses from the sidebar and see a filterable list of all hypotheses across all prospects'
    - 'Each hypothesis card on the review page shows prospect name, pain point title, matched use cases, and status pill'
    - 'Admin can approve or reject a hypothesis directly from the standalone review page'
    - 'On the prospect detail page, each hypothesis card shows matched use cases with scores and supporting evidence snippets'
    - 'Approve/reject decisions on the prospect detail page update the hypothesis status and are visible immediately'
    - 'Attempting to queue outreach for a prospect with no approved hypotheses shows a clear error message to the admin'
  artifacts:
    - path: 'app/admin/hypotheses/page.tsx'
      provides: 'Standalone hypothesis review list page'
      contains: 'hypotheses.listAll'
    - path: 'app/admin/layout.tsx'
      provides: 'Hypotheses nav item in Intelligence group'
      contains: '/admin/hypotheses'
    - path: 'app/admin/prospects/[id]/page.tsx'
      provides: 'Enhanced HypothesesTab with evidence + use case display'
      contains: 'evidenceItems'
  key_links:
    - from: 'app/admin/hypotheses/page.tsx'
      to: 'server/routers/hypotheses.ts'
      via: 'api.hypotheses.listAll.useQuery'
      pattern: "hypotheses\\.listAll"
    - from: 'app/admin/hypotheses/page.tsx'
      to: 'server/routers/hypotheses.ts'
      via: 'api.hypotheses.setStatus.useMutation'
      pattern: "hypotheses\\.setStatus"
    - from: 'app/admin/prospects/[id]/page.tsx'
      to: 'server/routers/hypotheses.ts'
      via: 'api.hypotheses.listByProspect consuming enriched proofMatches and evidenceItems'
      pattern: 'evidenceItems'
---

<objective>
Build the standalone hypothesis review page at /admin/hypotheses and enhance the existing HypothesesTab in the prospect detail page to display matched use cases and supporting evidence.

Purpose: Admin needs a centralized place to batch-review hypotheses across all prospects, and the per-prospect detail view must show the evidence backing each hypothesis so the admin can make informed approve/reject decisions.

Output: New /admin/hypotheses page with filterable list, Hypotheses nav item in sidebar, enhanced HypothesesTab showing use cases and evidence.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-evidence-approval-gate/07-RESEARCH.md
@.planning/phases/07-evidence-approval-gate/07-01-SUMMARY.md

@server/routers/hypotheses.ts
@app/admin/layout.tsx
@app/admin/prospects/[id]/page.tsx
@app/admin/use-cases/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build /admin/hypotheses review page and add nav item</name>
  <files>app/admin/hypotheses/page.tsx, app/admin/layout.tsx</files>
  <action>
**1. Create app/admin/hypotheses/page.tsx:**

Follow the pattern of `app/admin/use-cases/page.tsx` (use client, api import from @/components/providers, api.useUtils for invalidation).

Structure:

- `'use client'` directive
- Import `api` from `@/components/providers`
- Import icons from `lucide-react`: `Lightbulb` (page icon), `CheckCircle2`, `XCircle`, `RotateCcw`, `Loader2`, `Building2`
- State: `statusFilter: 'DRAFT' | 'ACCEPTED' | 'REJECTED' | undefined` (default: `'DRAFT'` — show drafts first since those need review)
- Query: `api.hypotheses.listAll.useQuery({ status: statusFilter, limit: 100 })`
- Mutation: `api.hypotheses.setStatus.useMutation({ onSuccess: () => utils.hypotheses.listAll.invalidate() })`

Layout:

- Page header: Lightbulb icon + "Hypothesis Review" title + subtitle "Review AI-generated hypotheses before outreach"
- Filter tabs: "Needs Review" (DRAFT), "Approved" (ACCEPTED), "Rejected" (REJECTED), "All" (undefined). Use same tab style as elsewhere in admin — small rounded-full buttons with active state `bg-[#040026] text-white` and inactive `bg-slate-100 text-slate-600`.
- Count badge next to each filter tab showing number of results
- List of hypothesis cards:

Each card:

```
[ Glass card with card-interactive class ]
├── Header row: prospect name (from h.prospect.companyName ?? h.prospect.domain) + status pill
├── Title: h.title (text-sm font-semibold)
├── Problem: h.problemStatement (text-xs text-slate-500, max 2 lines)
├── Matched Use Cases section (if h.proofMatches.length > 0):
│   └── Each match: score badge (emerald) + useCase.title ?? proofTitle + category pill
├── Confidence: h.confidenceScore as percentage
└── Action buttons: Accept (emerald), Reject (red), Reset to Draft (slate)
    └── Clicking calls setStatus({ kind: 'hypothesis', id: h.id, status: ... })
```

Prospect name should link to `/admin/prospects/${h.prospect.id}` for full context.

Status pill colors (reuse pattern from existing HypothesesTab):

- ACCEPTED: `bg-emerald-50 text-emerald-700`
- REJECTED: `bg-red-50 text-red-600`
- DRAFT: `bg-slate-100 text-slate-600`

Loading state: Show `Loader2` spinner while query is loading.
Empty state: "No hypotheses match this filter" message.

**2. Add Hypotheses nav item to admin layout:**

In `app/admin/layout.tsx`, add `Lightbulb` to the lucide-react import (line 6-19).

In the `Intelligence` group of `navItems` (around line 138-144), add the Hypotheses item BEFORE "Research runs":

```typescript
{ href: '/admin/hypotheses', label: 'Hypotheses', icon: Lightbulb },
```

This places it between "Use Cases" and "Research runs" in the Intelligence section, which matches the logical flow: Use Cases (what we offer) -> Hypotheses (what we think) -> Research (what we found).
</action>
<verify>Run `npx tsc --noEmit` — no type errors in new file or layout. Visit /admin in browser — "Hypotheses" nav item visible in Intelligence group. Navigate to /admin/hypotheses — page renders without errors.</verify>
<done>Standalone /admin/hypotheses page shows filterable list of all hypotheses with prospect info, matched use cases, and approve/reject buttons. Hypotheses nav item appears in admin sidebar Intelligence group.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance HypothesesTab with matched use cases and evidence display</name>
  <files>app/admin/prospects/[id]/page.tsx</files>
  <action>
Update the `HypothesesTab` function in `app/admin/prospects/[id]/page.tsx` (starts around line 853) to display matched use cases and evidence items from the enriched `listByProspect` response.

The enriched data shape from Plan 07-01 provides:

- `item.proofMatches[].useCase` — `{ id, title, summary, category }` or null
- `item.proofMatches[].evidenceItem` — `{ id, sourceUrl, snippet, sourceType, workflowTag, title }` or null
- `item.proofMatches[].score` — number (0-1)
- `item.evidenceItems[]` — resolved from `evidenceRefs` JSON: `{ id, sourceUrl, snippet, sourceType, workflowTag, title, confidenceScore }`

**Inside each hypothesis card (after the problemStatement paragraph around line 889 and before the action buttons div around line 890):**

Add matched use cases section:

```tsx
{
  item.proofMatches?.length > 0 && (
    <div className="mt-3 pt-3 border-t border-slate-100">
      <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">
        Matched Use Cases
      </p>
      <div className="space-y-1">
        {item.proofMatches.map((match: any) => (
          <div key={match.id} className="flex items-center gap-2 text-xs">
            <span className="font-mono text-emerald-600 font-bold text-[10px]">
              {(match.score * 100).toFixed(0)}%
            </span>
            <span className="text-slate-700">
              {match.useCase?.title ?? match.proofTitle}
            </span>
            {match.useCase?.category && (
              <span className="text-[9px] px-1.5 py-0.5 rounded bg-slate-50 text-slate-400">
                {match.useCase.category}
              </span>
            )}
          </div>
        ))}
      </div>
    </div>
  );
}
```

Add supporting evidence section:

```tsx
{
  item.evidenceItems?.length > 0 && (
    <div className="mt-3 pt-3 border-t border-slate-100">
      <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">
        Supporting Evidence
      </p>
      <div className="space-y-1.5">
        {item.evidenceItems.slice(0, 4).map((ev: any) => (
          <div key={ev.id} className="text-xs text-slate-500">
            <div className="flex items-center gap-1.5 mb-0.5">
              {ev.workflowTag && (
                <span className="text-[9px] px-1.5 py-0.5 rounded bg-blue-50 text-blue-600">
                  {ev.workflowTag}
                </span>
              )}
              {ev.sourceUrl && (
                <a
                  href={ev.sourceUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-[10px] text-blue-500 hover:underline truncate max-w-[200px]"
                >
                  {ev.title ?? new URL(ev.sourceUrl).hostname}
                </a>
              )}
            </div>
            {ev.snippet && (
              <p className="text-slate-400 line-clamp-2">{ev.snippet}</p>
            )}
          </div>
        ))}
      </div>
    </div>
  );
}
```

Apply the same matched use cases section to the **opportunities** cards (around line 920-950). Opportunities also have `proofMatches` and `evidenceItems` from the enriched response.

**Important:** Use `?.` optional chaining throughout since the data uses `any` types. Use `.slice(0, 4)` for evidence items to prevent cards from becoming too tall. Use `line-clamp-2` Tailwind class for snippet truncation. Wrap the `new URL()` call in a try-catch or use a fallback to prevent crashes on malformed URLs:

```tsx
{
  ev.sourceUrl && (
    <a
      href={ev.sourceUrl}
      target="_blank"
      rel="noopener noreferrer"
      className="text-[10px] text-blue-500 hover:underline truncate max-w-[200px]"
    >
      {ev.title ??
        (() => {
          try {
            return new URL(ev.sourceUrl).hostname;
          } catch {
            return ev.sourceUrl;
          }
        })()}
    </a>
  );
}
```

Or simpler: just use `ev.title ?? ev.sourceUrl` and let the truncation handle long URLs.

**3. Handle PRECONDITION_FAILED error on Queue Outreach button:**

The `queueOutreachDraft` mutation (line 117) currently has no `onError` handler. When the backend gate from Plan 07-01 throws a `PRECONDITION_FAILED` TRPCError, it must surface as a clear message to the admin.

Update the `queueLossMapDraft` mutation to add an `onError` handler:

```typescript
const queueLossMapDraft = api.assets.queueOutreachDraft.useMutation({
  onSuccess: async () => {
    await utils.outreach.getQueue.invalidate();
    await utils.sequences.list.invalidate();
  },
  onError: (error) => {
    // PRECONDITION_FAILED from hypothesis approval gate
    if (error.data?.code === 'PRECONDITION_FAILED') {
      alert(error.message); // Or use toast if sonner is available
    }
  },
});
```

Check if `sonner` (toast library) is already imported/used in the page. If so, use `toast.error(error.message)` instead of `alert()`. If not, use `alert()` — it is simple but effective and avoids adding a dependency. The error message from the backend already contains a clear, actionable message: "Outreach blocked: approve at least one hypothesis before generating sequences."

Also, where the Queue Outreach button is rendered (around line 1007), consider adding a disabled state when no hypotheses are approved. This provides proactive feedback before the user clicks. Check if `hypotheses` data is available in that component's scope — if `listByProspect` data is accessible, add:

```typescript
const hasApprovedHypothesis =
  hypotheses?.some((h: any) => h.status === 'ACCEPTED') ?? false;
```

Then on the button: `disabled={!hasApprovedHypothesis || isQueueing}` with a tooltip or title attribute: `title={!hasApprovedHypothesis ? 'Approve at least one hypothesis first' : undefined}`. If the hypotheses data is not in scope of that component, skip the disabled state — the backend gate + onError handler are sufficient.
</action>
<verify>Run `npx tsc --noEmit` — no type errors. Navigate to a prospect detail page with hypotheses — cards show matched use cases with scores and evidence snippets. Approve/reject buttons still work. Click Queue Outreach for a prospect with no approved hypotheses — error message is shown.</verify>
<done>HypothesesTab displays matched use cases with confidence scores and supporting evidence snippets for both bottlenecks and automation opportunities. Evidence items link to source URLs. Cards are visually clean with truncation. PRECONDITION_FAILED errors from the hypothesis gate surface as a clear message to the admin.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors in new and modified files
2. /admin/hypotheses page loads and shows hypothesis cards
3. Filter tabs switch between DRAFT / ACCEPTED / REJECTED / All
4. Approve/reject buttons on standalone page update status and refresh list
5. Prospect detail HypothesesTab shows matched use cases with scores
6. Prospect detail HypothesesTab shows evidence snippets with source links
7. Sidebar nav shows Hypotheses item in Intelligence group
</verification>

<success_criteria>

- Admin can navigate to /admin/hypotheses and see all hypotheses across prospects
- Admin can filter by status and batch-review hypotheses
- Admin can approve/reject from both the standalone page and the prospect detail page
- Each hypothesis shows its matched use cases and supporting evidence
- The review UI makes it clear which evidence supports which hypothesis
  </success_criteria>

<output>
After completion, create `.planning/phases/07-evidence-approval-gate/07-02-SUMMARY.md`
</output>
