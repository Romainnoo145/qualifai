---
phase: 27-end-to-end-cycle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/e2e-send-test.mjs
autonomous: false
requirements: [E2E-01]

must_haves:
  truths:
    - 'SPF/DKIM/DMARC DNS records for klarifai.nl are verified before sending'
    - 'A real outreach email is sent via Resend to info@klarifai.nl using the existing send infrastructure'
    - 'The email arrives in the inbox (not spam) with correct subject, body, and unsubscribe footer'
    - "OutreachLog record is created with status 'sent' and resendMessageId populated"
  artifacts:
    - path: 'scripts/e2e-send-test.mjs'
      provides: 'Reusable E2E test send script that overrides recipient to info@klarifai.nl'
  key_links:
    - from: 'scripts/e2e-send-test.mjs'
      to: 'lib/outreach/send-email.ts'
      via: 'Direct import of sendOutreachEmail'
      pattern: 'sendOutreachEmail'
    - from: 'lib/outreach/send-email.ts'
      to: 'Resend API'
      via: 'resend.emails.send()'
      pattern: "resend\\.emails\\.send"
---

<objective>
Verify DNS deliverability records and send real outreach emails to 2 test prospects (redirected to info@klarifai.nl) via the existing Resend pipeline.

Purpose: Prove that the outreach email infrastructure delivers real emails that land in the inbox — not spam — with correct formatting and compliance footer.
Output: 2 delivered emails in info@klarifai.nl inbox, OutreachLog records with 'sent' status, and a reusable E2E test send script.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-end-to-end-cycle/27-CONTEXT.md
@lib/outreach/send-email.ts
@env.mjs
@.env
</context>

<tasks>

<task type="auto">
  <name>Task 1: DNS pre-flight and E2E send script</name>
  <files>scripts/e2e-send-test.mjs</files>
  <action>
1. Run DNS verification for klarifai.nl:
   - `dig TXT klarifai.nl +short` — check for SPF record (v=spf1 ... include:... ~all or -all)
   - `dig TXT resend._domainkey.klarifai.nl +short` — check for DKIM record (or check Resend-specific DKIM selector)
   - `dig TXT _dmarc.klarifai.nl +short` — check for DMARC record (v=DMARC1; p=...)
   - If any record is missing, document what's missing but proceed — Resend handles sending even without perfect DNS, but deliverability may suffer. Note findings in the SUMMARY.

2. Query the database to find 2 prospects that:
   - Have a ResearchRun with qualityApproved=true or green traffic light
   - Have at least one Contact with a primaryEmail
   - Have at least one OutreachSequence with an OutreachStep in status 'DRAFTED' or 'QUEUED'
   - If no prospects meet all criteria, find any 2 prospects with contacts and create test outreach content inline

3. Create `scripts/e2e-send-test.mjs`:
   - Load dotenv: `import 'dotenv/config'`
   - Import PrismaClient via `@prisma/client` (direct, not the app's singleton — script runs standalone)
   - Accept optional CLI arg for prospect slug/id, or auto-select 2 qualifying prospects
   - For each prospect:
     a. Find the contact and their pending outreach draft
     b. Call Resend API directly (not through the app's send-email module — script is standalone):
     - `from`: process.env.OUTREACH_FROM_EMAIL or 'Romano Groenewoud <info@klarifai.nl>'
     - `to`: OVERRIDE to 'info@klarifai.nl' (never send to real prospect in testing)
     - `subject`: Use the actual draft subject line
     - `html`/`text`: Use the actual draft body content
     - `replyTo`: 'info@klarifai.nl'
     - Include List-Unsubscribe headers
       c. Log the Resend response (message ID, status)
       d. Update OutreachLog record: create with status 'sent', store resendMessageId in metadata
       e. Update Contact outreachStatus to 'EMAIL_SENT'
   - Print summary: which prospects were sent, Resend message IDs, any errors

4. Run the script: `node scripts/e2e-send-test.mjs`
   - Capture output showing successful sends
   - If errors occur, diagnose and fix before proceeding

5. Verify DB state:
   - Query OutreachLog for the 2 new records, confirm status='sent' and metadata contains resendMessageId
   - Query Contact for the 2 contacts, confirm outreachStatus='EMAIL_SENT'
     </action>
     <verify>
     <automated>node scripts/e2e-send-test.mjs 2>&1 | tail -20</automated>
     <manual>Check that script output shows 2 successful sends with Resend message IDs</manual>
     </verify>
     <done>2 outreach emails sent via Resend to info@klarifai.nl, OutreachLog records created with 'sent' status and resendMessageId, Contact records updated to EMAIL_SENT</done>
     </task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify email delivery in inbox</name>
  <files>n/a</files>
  <action>
  Human verifies that 2 real outreach emails were delivered to the info@klarifai.nl inbox:
  1. Open the info@klarifai.nl inbox (email client or webmail)
  2. Check for 2 new emails from "Romano Groenewoud &lt;info@klarifai.nl&gt;" (or the configured FROM_EMAIL)
  3. Verify each email:
     - Arrived in inbox (not spam/junk folder)
     - Subject line matches the outreach draft
     - Body content is properly formatted (HTML renders correctly)
     - Unsubscribe link is present at the bottom
     - Reply-To header points to info@klarifai.nl
  4. Note the from-address, subject, and delivery timing for each email
  5. If either email is in spam: check Resend dashboard for bounce/complaint status and report findings
  </action>
  <verify>Human confirms both emails arrived in inbox, not spam</verify>
  <done>Both outreach emails delivered to info@klarifai.nl inbox with correct formatting and compliance footer</done>
  <resume-signal>Type "delivered" if both emails arrived in inbox, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- DNS records for klarifai.nl checked (SPF, DKIM, DMARC) — findings documented
- 2 outreach emails sent via Resend API with real prospect content
- All sends redirected to info@klarifai.nl (no email sent to real prospects)
- OutreachLog records have status='sent' and resendMessageId in metadata
- Emails confirmed delivered to inbox by human verification
</verification>

<success_criteria>

- 2 emails delivered to info@klarifai.nl inbox (not spam)
- OutreachLog records exist with 'sent' status and valid resendMessageId
- Contact outreachStatus updated to EMAIL_SENT for both test contacts
- DNS pre-flight findings documented
  </success_criteria>

<output>
After completion, create `.planning/phases/27-end-to-end-cycle/27-01-SUMMARY.md`
</output>
