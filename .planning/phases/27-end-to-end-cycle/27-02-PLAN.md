---
phase: 27-end-to-end-cycle
plan: 02
type: execute
wave: 2
depends_on: ['27-01']
files_modified:
  - scripts/e2e-reply-test.mjs
autonomous: false
requirements: [E2E-02, E2E-03]

must_haves:
  truths:
    - "An interested reply is received via the inbound-reply webhook and triaged as 'interested' with suggested action 'book_teardown'"
    - "A not-interested reply is received via the inbound-reply webhook and triaged as 'not_fit' with suggested action 'close_lost'"
    - 'Reply triage results are stored in OutreachLog metadata with intent, confidence, and suggestedAction'
    - 'Contact outreachStatus is updated to REPLIED for both test contacts'
  artifacts:
    - path: 'scripts/e2e-reply-test.mjs'
      provides: 'Reusable E2E reply test script that POSTs realistic replies to the inbound webhook'
  key_links:
    - from: 'scripts/e2e-reply-test.mjs'
      to: 'app/api/webhooks/inbound-reply/route.ts'
      via: 'HTTP POST with webhook secret'
      pattern: 'fetch.*inbound-reply'
    - from: 'app/api/webhooks/inbound-reply/route.ts'
      to: 'lib/outreach/reply-workflow.ts'
      via: 'captureInboundReply + applyReplyTriage'
      pattern: 'applyReplyTriage'
    - from: 'lib/outreach/reply-workflow.ts'
      to: 'lib/outreach/reply-triage.ts'
      via: 'triageReplyText pattern matching'
      pattern: 'triageReplyText'
---

<objective>
Validate the full reply webhook pipeline by posting 2 realistic email replies (one interested, one not-interested) to the inbound-reply webhook endpoint and verifying correct triage classification.

Purpose: Prove that the reply reception and triage pipeline works end-to-end — from webhook POST through contact lookup, OutreachLog capture, intent classification, and status updates.
Output: 2 triaged reply records in the database, a reusable E2E reply test script, and human-verified triage outcomes.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-end-to-end-cycle/27-CONTEXT.md
@.planning/phases/27-end-to-end-cycle/27-01-SUMMARY.md
@app/api/webhooks/inbound-reply/route.ts
@lib/outreach/reply-workflow.ts
@lib/outreach/reply-triage.ts
@lib/outreach/engagement-triggers.ts
@.env
</context>

<tasks>

<task type="auto">
  <name>Task 1: E2E reply test script with 2 triage paths</name>
  <files>scripts/e2e-reply-test.mjs</files>
  <action>
1. Create `scripts/e2e-reply-test.mjs`:
   - Load dotenv: `import 'dotenv/config'`
   - Import PrismaClient via `@prisma/client` (standalone script)
   - Read ADMIN_SECRET from process.env (or INBOUND_REPLY_WEBHOOK_SECRET) for webhook auth
   - Read APP_URL from process.env.NEXT_PUBLIC_APP_URL or default to 'http://localhost:9200'

2. Query DB for the 2 contacts used in Plan 01 (outreachStatus = 'EMAIL_SENT', recently updated). If the 27-01-SUMMARY.md has specific contact IDs, use those. Otherwise, find the 2 most recently sent contacts.

3. For Contact #1 (interested reply):
   - POST to `${APP_URL}/api/webhooks/inbound-reply` with:
     - Header: `x-inbound-secret: ${ADMIN_SECRET}`
     - Content-Type: `application/json`
     - Body:
       ```json
       {
         "fromEmail": "<contact's primaryEmail>",
         "subject": "Re: <original outreach subject>",
         "bodyText": "Hoi Romano, klinkt goed! Laten we een gesprek inplannen. Wanneer schikt het jou?",
         "bodyHtml": "<p>Hoi Romano, klinkt goed! Laten we een gesprek inplannen. Wanneer schikt het jou?</p>",
         "source": "email-inbound",
         "provider": "resend",
         "autoTriage": true
       }
       ```
   - Log the webhook response (expect: success=true, triage.intent='interested')
   - Verify in DB:
     - OutreachLog created with status='triaged', metadata.triage.intent='interested'
     - Contact outreachStatus updated to 'REPLIED'
     - Prospect status updated to 'ENGAGED' (from applyReplyTriage interested path)

4. For Contact #2 (not-interested reply):
   - POST to the same webhook with:
     - Body:
       ```json
       {
         "fromEmail": "<contact's primaryEmail>",
         "subject": "Re: <original outreach subject>",
         "bodyText": "Bedankt voor je mail, maar we hebben hier geen budget voor. Dit is niet relevant voor ons op dit moment.",
         "bodyHtml": "<p>Bedankt voor je mail, maar we hebben hier geen budget voor. Dit is niet relevant voor ons op dit moment.</p>",
         "source": "email-inbound",
         "provider": "resend",
         "autoTriage": true
       }
       ```
   - Log the webhook response (expect: success=true, triage.intent='not_fit')
   - Verify in DB:
     - OutreachLog created with status='triaged', metadata.triage.intent='not_fit'
     - Contact outreachStatus updated to 'REPLIED'
     - OutreachSequence status updated to 'CLOSED_LOST' (from applyReplyTriage not_fit path)

5. Print summary table:

   ```
   Contact | Reply Intent | Triage Result | Suggested Action | DB Status
   --------|-------------|---------------|------------------|----------
   #1 name | interested  | interested    | book_teardown    | REPLIED/ENGAGED
   #2 name | not_fit     | not_fit       | close_lost       | REPLIED/CLOSED_LOST
   ```

6. IMPORTANT: The dev server must be running on port 9200 for the webhook POST to work. Before running the script, verify the server is up with a quick health check fetch. If not running, instruct to start it.

7. If any triage result is unexpected (e.g., 'unknown' instead of 'interested'), investigate the reply-triage.ts pattern matching against the test text and adjust the reply text to match existing patterns. The Dutch reply texts above are specifically crafted to match INTERESTED_PATTERNS ('klinkt goed', 'laten we', 'gesprek') and NOT_FIT_PATTERNS ('geen budget', 'niet relevant').
   </action>
   <verify>
   <automated>node scripts/e2e-reply-test.mjs 2>&1 | tail -20</automated>
   <manual>Check that script output shows 2 replies correctly triaged (interested + not_fit)</manual>
   </verify>
   <done>2 realistic replies posted to inbound-reply webhook, both correctly triaged (interested → book_teardown, not_fit → close_lost), OutreachLog and Contact records updated</done>
   </task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify triage outcomes in admin UI</name>
  <files>n/a</files>
  <action>
  Human verifies that both reply triage outcomes are correctly reflected in the admin UI:
  1. Open the admin UI at http://localhost:9200
  2. Navigate to the Prospects list
  3. For Prospect #1 (interested):
     - Check that the prospect shows status 'ENGAGED'
     - Click into the prospect detail → Results section
     - Verify the reply appears in the outreach log with 'triaged' status
     - Check that triage metadata shows intent='interested', suggestedAction='book_teardown'
  4. For Prospect #2 (not interested):
     - Check the prospect's outreach sequence shows 'CLOSED_LOST'
     - Click into detail → verify reply log shows intent='not_fit', suggestedAction='close_lost'
  5. Check the Action Queue for any new call tasks created by the interested reply engagement trigger
  6. If triage results look wrong or UI doesn't reflect the data: describe what you see
  </action>
  <verify>Human confirms both triage outcomes are correctly shown in admin UI</verify>
  <done>Both triage outcomes verified in admin UI: interested → ENGAGED + book_teardown, not_fit → CLOSED_LOST + close_lost</done>
  <resume-signal>Type "verified" if both triage outcomes are correct in UI, or describe discrepancies</resume-signal>
</task>

</tasks>

<verification>
- 2 reply payloads posted to /api/webhooks/inbound-reply with valid webhook secret
- Reply #1 triaged as 'interested' (suggestedAction: book_teardown)
- Reply #2 triaged as 'not_fit' (suggestedAction: close_lost)
- OutreachLog records have status='triaged' with triage metadata
- Contact outreachStatus updated to 'REPLIED' for both
- Prospect #1 status updated to 'ENGAGED'
- OutreachSequence for Prospect #2 updated to 'CLOSED_LOST'
- Admin UI reflects all database state changes
</verification>

<success_criteria>

- 2 replies received and correctly triaged via the webhook pipeline
- Interested reply → book_teardown action, prospect ENGAGED status
- Not-interested reply → close_lost action, sequence CLOSED_LOST status
- All triage outcomes visible in admin UI
- E2E reply pipeline proven functional for the 2 primary triage paths
  </success_criteria>

<output>
After completion, create `.planning/phases/27-end-to-end-cycle/27-02-SUMMARY.md`
</output>
