---
phase: 17-evidence-pipeline-enrichment
plan: '01'
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/enrichment/sitemap.ts
  - lib/enrichment/serp.ts
autonomous: true

must_haves:
  truths:
    - "discoverSitemapUrls returns filtered, capped URL list from a domain's sitemap.xml"
    - 'discoverSitemapUrls returns empty array on missing/malformed sitemap without throwing'
    - 'discoverGoogleSearchMentions returns search results with url, title, snippet for a company'
    - 'discoverGoogleSearchMentions returns empty array when SERP_API_KEY is not set'
  artifacts:
    - path: 'lib/enrichment/sitemap.ts'
      provides: 'Sitemap URL discovery using sitemapper package'
      exports: ['discoverSitemapUrls', 'SitemapCache']
    - path: 'lib/enrichment/serp.ts'
      provides: 'Google search mention discovery via SerpAPI google engine'
      exports: ['discoverGoogleSearchMentions', 'GoogleSearchMention']
  key_links:
    - from: 'lib/enrichment/sitemap.ts'
      to: 'sitemapper'
      via: 'npm dependency import'
      pattern: "import Sitemapper from 'sitemapper'"
    - from: 'lib/enrichment/serp.ts'
      to: 'serpapi'
      via: 'existing getJson import'
      pattern: 'engine.*google'
---

<objective>
Create two enrichment source modules: sitemap URL discovery (EVID-06) and Google search mention discovery (EVID-07).

Purpose: These modules provide the functions that Plan 03 will wire into executeResearchRun. Sitemap discovery replaces guessed URL paths with real internal pages. Google search surfaces external mentions (reviews, job postings, news) that homepage crawling would never find.

Output: Two enrichment modules ready for integration — `lib/enrichment/sitemap.ts` (new) and extended `lib/enrichment/serp.ts`.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-evidence-pipeline-enrichment/17-RESEARCH.md
@lib/enrichment/serp.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sitemap URL discovery module</name>
  <files>lib/enrichment/sitemap.ts</files>
  <action>
Install sitemapper: `npm install sitemapper`

Create `lib/enrichment/sitemap.ts` with:

1. Export interface `SitemapCache` with `discoveredAt: string` and `urls: string[]` fields — matches the pattern used by `SerpDiscoveryResult` in `serp.ts` for snapshot caching.

2. Export async function `discoverSitemapUrls(domain: string): Promise<string[]>` that:
   - Creates a Sitemapper instance with `url: https://${domain}/sitemap.xml`, `timeout: 12000`, `concurrency: 2`, `retries: 1`
   - Calls `sitemapper.fetch()` to get `{ sites }`
   - Filters sites to same domain only: `url.includes(domain)` — security measure to prevent crawling external CDN/asset URLs
   - Filters out non-content file extensions: `/\.(jpg|jpeg|png|gif|svg|pdf|xml|css|js|woff|woff2|ttf|ico|mp4|mp3|zip)$/i`
   - Caps at 25 URLs via `.slice(0, 25)` — WordPress/Shopify sitemaps can have thousands
   - Wraps entire body in try/catch returning `[]` on any error (sitemap missing, malformed XML, network timeout)
   - Does NOT log errors — sitemap absence is expected for many Dutch SMB sites

Note: Import with `import Sitemapper from 'sitemapper'`. The package has TypeScript types included. If TypeScript complains about the default import, use `import Sitemapper = require('sitemapper')` or check the actual export style — sitemapper v4.x uses CommonJS default export.
</action>
<verify>
`npx tsc --noEmit` passes with no errors on the new file.
`npm run check` passes.
</verify>
<done>
`lib/enrichment/sitemap.ts` exports `discoverSitemapUrls` and `SitemapCache`. Function accepts a domain string, returns filtered URL array, and gracefully handles missing sitemaps.
</done>
</task>

<task type="auto">
  <name>Task 2: Add Google search mention discovery to serp.ts</name>
  <files>lib/enrichment/serp.ts</files>
  <action>
Extend `lib/enrichment/serp.ts` with a new exported function. Do NOT modify the existing `discoverSerpUrls` function.

1. Add exported interface `GoogleSearchMention` with `url: string`, `title: string`, `snippet: string`.

2. Add exported async function `discoverGoogleSearchMentions(input: { companyName: string | null; domain: string }): Promise<GoogleSearchMention[]>` that:
   - Returns `[]` immediately if `process.env.SERP_API_KEY` is not set (same guard pattern as `discoverSerpUrls`)
   - Sets `serpConfig.api_key` (lazy init pattern, same as existing code)
   - Builds query from `input.companyName ?? input.domain`
   - Runs 3 sequential Google Search queries using the existing `getJson` import:
     - `"${query}" reviews OR ervaringen` (review mentions)
     - `"${query}" vacatures OR werken bij` (job/career mentions)
     - `"${query}" nieuws` (news mentions)
   - Each query uses params: `engine: 'google'`, `q`, `gl: 'nl'`, `hl: 'nl'`, `google_domain: 'google.nl'`, `num: 5`
   - Extracts `organic_results` array from response, typed inline as `{ organic_results?: Array<{ link?: string; title?: string; snippet?: string }> }`
   - For each result with `link` and `snippet.length > 30`, pushes to mentions array
   - Each query is wrapped in individual try/catch with `console.error('[SerpAPI] google search error for "${q}":', err)` — one failing query must not abort the others
   - Returns `mentions.slice(0, 12)` (cap at 12 total across all 3 queries)

The function follows the exact same patterns as `discoverSerpUrls`: lazy API key init, individual try/catch per API call, console.error logging, result capping.
</action>
<verify>
`npx tsc --noEmit` passes.
`npm run check` passes.
Existing serp.test.ts tests still pass: `npx vitest run lib/enrichment/serp.test.ts` (if it exists).
</verify>
<done>
`lib/enrichment/serp.ts` exports `discoverGoogleSearchMentions` and `GoogleSearchMention` alongside the existing `discoverSerpUrls`. Function runs 3 Google search queries via SerpAPI and returns up to 12 mention objects.
</done>
</task>

</tasks>

<verification>
1. `npm run check` passes (type-check + lint + format)
2. `lib/enrichment/sitemap.ts` exists and exports `discoverSitemapUrls` and `SitemapCache`
3. `lib/enrichment/serp.ts` exports `discoverGoogleSearchMentions` and `GoogleSearchMention` without breaking existing exports
4. No new lint warnings or type errors
</verification>

<success_criteria>
Both enrichment source functions are implemented, type-safe, and ready for integration into executeResearchRun (Plan 03). Neither function breaks existing functionality.
</success_criteria>

<output>
After completion, create `.planning/phases/17-evidence-pipeline-enrichment/17-01-SUMMARY.md`
</output>
