---
phase: 17-evidence-pipeline-enrichment
plan: '02'
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - env.mjs
  - lib/enrichment/kvk.ts
  - lib/enrichment/crawl4ai.ts
autonomous: true
user_setup:
  - service: kvk
    why: 'KvK Handelsregister API for Dutch company registry data'
    env_vars:
      - name: KVK_API_KEY
        source: "KvK Developer Portal (https://developers.kvk.nl) -> Subscribe to API plan (€6.40/month) -> Copy API key. For testing: use test key 'l7xx1f2691f2520d487b902f4e0b57a0b197' with KVK_TEST_MODE=true"
      - name: KVK_TEST_MODE
        source: "Set to 'true' to use KvK test environment (api.kvk.nl/test/api) — free, no subscription needed"

must_haves:
  truths:
    - 'fetchKvkData returns structured company data from KvK registry for a given company name'
    - 'fetchKvkData returns null gracefully when KVK_API_KEY is not set or company not found'
    - 'kvkDataToEvidenceDraft converts KvK data into a valid EvidenceDraft with REGISTRY sourceType'
    - 'REGISTRY enum value exists in EvidenceSourceType for filtering/display of registry data'
    - 'crawl4ai creates fallback draft for minimal-content pages instead of silently skipping'
    - 'KvK enrichment returns null gracefully when KVK_API_KEY is not configured, rather than throwing'
  artifacts:
    - path: 'lib/enrichment/kvk.ts'
      provides: 'KvK Handelsregister API client with two-step lookup (Zoeken + Basisprofiel)'
      exports: ['fetchKvkData', 'kvkDataToEvidenceDraft', 'KvkEnrichmentData']
    - path: 'prisma/schema.prisma'
      provides: 'REGISTRY enum value in EvidenceSourceType'
      contains: 'REGISTRY'
    - path: 'env.mjs'
      provides: 'KVK_API_KEY and KVK_TEST_MODE server env validation'
      contains: 'KVK_API_KEY'
    - path: 'lib/enrichment/crawl4ai.ts'
      provides: 'Fallback draft behavior for minimal-content pages'
      contains: 'confidenceScore: 0.55'
  key_links:
    - from: 'lib/enrichment/kvk.ts'
      to: 'api.kvk.nl'
      via: 'fetch with apikey header'
      pattern: 'apikey.*KVK_API_KEY'
    - from: 'lib/enrichment/kvk.ts'
      to: 'lib/workflow-engine.ts'
      via: 'EvidenceDraft type import'
      pattern: 'import.*EvidenceDraft.*workflow-engine'
---

<objective>
Create the KvK registry enrichment module (EVID-09), add the REGISTRY enum to the schema, register KvK env vars, and fix the crawl4ai fallback draft behavior.

Purpose: The KvK module provides Dutch company registry data (legal form, SBI sector code, employee count) as structured evidence. The REGISTRY enum enables Phase 18 quality gate to distinguish registry evidence from web evidence. The crawl4ai fix resolves a test discrepancy from Phase 8 and enables proper fallback stubs for LinkedIn extraction (EVID-08).

Output: `lib/enrichment/kvk.ts` (new), updated `prisma/schema.prisma` with migration, updated `env.mjs`, fixed `lib/enrichment/crawl4ai.ts`.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-evidence-pipeline-enrichment/17-RESEARCH.md
@lib/enrichment/crawl4ai.ts
@lib/enrichment/crawl4ai.test.ts
@env.mjs
@prisma/schema.prisma
@lib/workflow-engine.ts (for EvidenceDraft interface)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add REGISTRY enum + KVK env vars + Prisma migration</name>
  <files>prisma/schema.prisma, env.mjs</files>
  <action>
1. In `prisma/schema.prisma`, add `REGISTRY` to the `EvidenceSourceType` enum after `MANUAL_URL`:
   ```
   MANUAL_URL
   REGISTRY  // KvK Handelsregister data
   ```

2. In `env.mjs`, add to the `server` section (after `CRAWL4AI_BASE_URL`):

   ```
   KVK_API_KEY: z.string().min(1).optional(),
   KVK_TEST_MODE: z.enum(["true", "false"]).optional(),
   ```

3. In `env.mjs`, add to the `runtimeEnv` section (after `CRAWL4AI_BASE_URL`):

   ```
   KVK_API_KEY: process.env.KVK_API_KEY,
   KVK_TEST_MODE: process.env.KVK_TEST_MODE,
   ```

4. Run Prisma migration: `npx prisma migrate dev --name add-registry-source-type`
   - This adds `REGISTRY` to the PostgreSQL `EvidenceSourceType` enum via `ALTER TYPE`
   - If the migration fails because the DB is not running, create it with `npx prisma migrate dev --create-only --name add-registry-source-type` and note it for manual application

5. Also update `lib/web-evidence-adapter.ts` `baseConfidence` function — add a case for `REGISTRY` returning `0.82` (registry data is high factual confidence). This prevents a TypeScript exhaustiveness warning if the function uses a switch without default.

NOTE: Check if `baseConfidence` in `web-evidence-adapter.ts` has a default case. If it does, the REGISTRY case is optional but still good practice. If it doesn't, it's required to prevent type errors.
</action>
<verify>
`npx prisma migrate dev` completes successfully (or `--create-only` if DB not running).
`npx tsc --noEmit` passes.
`npm run check` passes.
</verify>
<done>
`REGISTRY` exists in `EvidenceSourceType` enum. `KVK_API_KEY` and `KVK_TEST_MODE` are validated in `env.mjs`. Prisma migration created and applied.
</done>
</task>

<task type="auto">
  <name>Task 2: Create KvK registry enrichment module</name>
  <files>lib/enrichment/kvk.ts</files>
  <action>
Create `lib/enrichment/kvk.ts` with:

1. Import `type { EvidenceDraft }` from `@/lib/workflow-engine`.

2. Define `KVK_BASE_URL` constant:

   ```typescript
   const KVK_BASE_URL =
     process.env.KVK_TEST_MODE === 'true'
       ? 'https://api.kvk.nl/test/api'
       : 'https://api.kvk.nl/api';
   ```

   Uses `process.env` directly (not env.mjs) — same pattern as serp.ts and crawl4ai.ts for testability.

3. Define internal interfaces for API responses:
   - `KvkZoekenResult`: `{ resultaten?: Array<{ kvkNummer?: string; naam?: string; straatnaam?: string; postcode?: string; plaats?: string; actief?: string }>; totaal?: number }`
   - `KvkBasisprofiel`: `{ kvkNummer?: string; naam?: string; formeleRegistratiedatum?: string; sbiActiviteiten?: Array<{ sbiCode?: string; sbiOmschrijving?: string; indHoofdactiviteit?: string }>; totaalWerkzamePersonen?: number; rechtsvorm?: string; uitgebreideRechtsvorm?: string }`

4. Export interface `KvkEnrichmentData`:

   ```typescript
   export interface KvkEnrichmentData {
     kvkNummer: string;
     naam: string;
     sbiCode?: string;
     sbiOmschrijving?: string;
     werkzamePersonen?: number;
     rechtsvorm?: string;
     registratiedatum?: string;
     plaats?: string;
     postcode?: string;
   }
   ```

5. Export async function `fetchKvkData(companyName: string): Promise<KvkEnrichmentData | null>`:
   - Return null immediately if `process.env.KVK_API_KEY` is not set
   - Set `headers` to `{ apikey: process.env.KVK_API_KEY }` (lowercase `apikey` — this is the KvK header name)
   - Step 1 (Zoeken): `fetch(${KVK_BASE_URL}/v2/zoeken?naam=${encodeURIComponent(companyName)}&resultatenPerPagina=3, { headers, signal: AbortSignal.timeout(8000) })`
   - If not ok, return null
   - Parse response as `KvkZoekenResult`
   - Find first active result: `searchData.resultaten?.find(r => r.actief === 'Ja') ?? searchData.resultaten?.[0]`
   - If no kvkNummer, return null
   - Step 2 (Basisprofiel): `fetch(${KVK_BASE_URL}/v1/basisprofielen/${first.kvkNummer}, { headers, signal: AbortSignal.timeout(8000) })`
   - If not ok, return null
   - Parse response as `KvkBasisprofiel`
   - Find hoofdactiviteit SBI: `profile.sbiActiviteiten?.find(s => s.indHoofdactiviteit === 'Ja') ?? profile.sbiActiviteiten?.[0]`
   - Return `KvkEnrichmentData` with all fields mapped
   - Entire function wrapped in try/catch returning null with `console.error('[KvK] enrichment failed:', err)`

6. Export function `kvkDataToEvidenceDraft(data: KvkEnrichmentData): EvidenceDraft`:
   - Builds snippet from parts array: `Rechtsvorm: ${data.rechtsvorm}`, `Sector: ${data.sbiOmschrijving}`, `Werkzame personen: ${data.werkzamePersonen}`, `Gevestigd: ${data.plaats}`, `Ingeschreven: ${data.registratiedatum}` — only include parts where value is truthy
   - Returns EvidenceDraft with: - `sourceType: 'REGISTRY'` - `sourceUrl: https://www.kvk.nl/zoeken/?source=all&q=${encodeURIComponent(data.naam)}&start=0&site=kvk` - `title: ${data.naam} - KvK Handelsregister` - `snippet: parts.join(' | ').slice(0, 240)` - `workflowTag: 'workflow-context'` - `confidenceScore: 0.82` - `metadata: { adapter: 'kvk', kvkNummer: data.kvkNummer, sbiCode: data.sbiCode, werkzamePersonen: data.werkzamePersonen }`
     </action>
     <verify>
     `npx tsc --noEmit` passes.
     `npm run check` passes.
     </verify>
     <done>
     `lib/enrichment/kvk.ts` exports `fetchKvkData`, `kvkDataToEvidenceDraft`, and `KvkEnrichmentData`. Two-step KvK API lookup with graceful null returns.
     </done>
     </task>

<task type="auto">
  <name>Task 3: Fix crawl4ai fallback draft for minimal-content pages</name>
  <files>lib/enrichment/crawl4ai.ts</files>
  <action>
Fix the discrepancy between `crawl4ai.ts` implementation and `crawl4ai.test.ts` expectations. The test at line 167 expects a fallback draft with `confidenceScore: 0.55` and `metadata.fallback: true` for minimal content. The current implementation does `continue` (skips entirely).

In `ingestCrawl4aiEvidenceDrafts`, replace the minimal-content skip block:

```typescript
// OLD — skip entirely
if (!markdown || markdown.length < 80) {
  continue;
}
```

With a fallback draft creation:

```typescript
if (!markdown || markdown.length < 80) {
  const sourceType = url.includes('google.com/maps') ? 'REVIEWS' : 'JOB_BOARD';
  drafts.push({
    sourceType,
    sourceUrl: url,
    title: 'Bron (browser-extractie mislukt)',
    snippet:
      'Pagina bestaat maar leverde minimale inhoud op bij browser-extractie.',
    workflowTag: 'workflow-context',
    confidenceScore: 0.55,
    metadata: { adapter: 'crawl4ai', fallback: true },
  });
  continue;
}
```

This matches what the Phase 8 test expected. The fallback draft is useful for EVID-08 (LinkedIn) where we want a placeholder stub even when content extraction fails — better than silent skip.

The 404 skip (`looksLikeCrawled404`) stays unchanged — 404 pages should still be skipped entirely (they truly don't exist).
</action>
<verify>
`npx vitest run lib/enrichment/crawl4ai.test.ts` — all tests pass, including the fallback draft test at line 167.
`npm run check` passes.
</verify>
<done>
`crawl4ai.ts` creates fallback drafts for minimal-content pages (confidenceScore 0.55, metadata.fallback: true). Existing test passes. 404 skip behavior unchanged.
</done>
</task>

</tasks>

<verification>
1. `npm run check` passes (type-check + lint + format)
2. `npx vitest run lib/enrichment/crawl4ai.test.ts` — all 7 tests pass
3. `REGISTRY` appears in `EvidenceSourceType` enum in schema.prisma
4. Prisma migration file exists in `prisma/migrations/`
5. `lib/enrichment/kvk.ts` exports `fetchKvkData`, `kvkDataToEvidenceDraft`, `KvkEnrichmentData`
6. `env.mjs` contains `KVK_API_KEY` and `KVK_TEST_MODE` in both server and runtimeEnv sections
</verification>

<success_criteria>
KvK enrichment module is complete, REGISTRY enum is migrated, env vars are registered, and crawl4ai fallback behavior matches test expectations. All modules ready for integration in Plan 03.
</success_criteria>

<output>
After completion, create `.planning/phases/17-evidence-pipeline-enrichment/17-02-SUMMARY.md`
</output>
