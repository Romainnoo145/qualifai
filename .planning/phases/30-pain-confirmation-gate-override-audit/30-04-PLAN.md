---
phase: 30-pain-confirmation-gate-override-audit
plan: 04
type: execute
wave: 2
depends_on: ['30-02']
files_modified:
  - server/routers/admin.ts
  - app/admin/prospects/page.tsx
  - app/admin/prospects/[id]/page.tsx
autonomous: true
requirements: [AUDT-03, AUDT-04]

must_haves:
  truths:
    - "Prospects with gate override audits display a 'Bypassed' badge in the admin prospect list"
    - 'Prospects without gate overrides show no badge'
    - 'Research run detail view shows override history with timestamp, gate type, reason, and actor'
    - 'Override history section only renders when audit records exist for the run'
  artifacts:
    - path: 'server/routers/admin.ts'
      provides: 'gateOverrideAudit count in listProspects response'
      contains: 'gateOverrideAudits'
    - path: 'app/admin/prospects/page.tsx'
      provides: 'Bypassed badge in prospect list cards'
      contains: 'Bypassed'
    - path: 'app/admin/prospects/[id]/page.tsx'
      provides: 'Override history section in prospect detail'
      contains: 'listOverrideAudits'
  key_links:
    - from: 'server/routers/admin.ts'
      to: 'prisma.prospect._count.gateOverrideAudits'
      via: 'listProspects include with _count select'
      pattern: 'gateOverrideAudits'
    - from: 'app/admin/prospects/page.tsx'
      to: 'server/routers/admin.ts'
      via: 'tRPC query reading prospect._count.gateOverrideAudits'
      pattern: '_count.*gateOverrideAudits'
    - from: 'app/admin/prospects/[id]/page.tsx'
      to: 'server/routers/research.ts'
      via: 'tRPC listOverrideAudits query for override history'
      pattern: 'listOverrideAudits'
---

<objective>
Add a "Bypassed" badge to the prospect list and render override audit history on the research run detail view.

Purpose: AUDT-03 requires visual identification of prospects with gate overrides. AUDT-04 requires full override history to be visible on research run details.
Output: Badge in prospect list, override history panel in detail view.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-pain-confirmation-gate-override-audit/30-RESEARCH.md
@.planning/phases/30-pain-confirmation-gate-override-audit/30-02-SUMMARY.md
@server/routers/admin.ts
@app/admin/prospects/page.tsx
@app/admin/prospects/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Bypassed badge to prospect list</name>
  <files>server/routers/admin.ts, app/admin/prospects/page.tsx</files>
  <action>
    1. In server/routers/admin.ts, find the `listProspects` query's Prisma include/select. Add `_count: { select: { gateOverrideAudits: true } }` to the Prospect include. If `_count` already exists (for sessions, contacts, etc.), add `gateOverrideAudits: true` to the existing `_count.select`.

    2. In app/admin/prospects/page.tsx, find the prospect card/row rendering. After the existing QualityChip or traffic light indicator, add a conditional "Bypassed" badge:
       ```tsx
       {(prospect._count?.gateOverrideAudits ?? 0) > 0 && (
         <span className="text-[9px] font-black px-3 py-1 rounded-full uppercase tracking-widest border bg-amber-50 text-amber-600 border-amber-100">
           Bypassed
         </span>
       )}
       ```
    3. The badge uses established amber color tokens (consistent with AMBER quality gate styling).
    4. Import ShieldAlert from lucide-react if you want an icon in the badge (optional — keep it text-only if that matches the existing chip pattern in the prospect list).
    5. Handle TypeScript types: the `_count` property is added by Prisma include — ensure the type inference picks it up. If the component uses a manual type for the prospect object, extend it with `_count?: { gateOverrideAudits?: number }`.

  </action>
  <verify>
    <automated>npm run check</automated>
    <manual>Visit /admin/prospects — any prospect with override audits shows "Bypassed" badge; clean prospects show no badge</manual>
  </verify>
  <done>listProspects includes gateOverrideAudit count. Prospect list renders "Bypassed" badge for prospects with gate overrides.</done>
</task>

<task type="auto">
  <name>Task 2: Add override history section to prospect detail view</name>
  <files>app/admin/prospects/[id]/page.tsx</files>
  <action>
    1. In app/admin/prospects/[id]/page.tsx, find the research run detail section (where research run data is displayed).
    2. Identify the latest research run ID — this is typically available from the existing research run query (e.g., `researchRuns.data[0]?.id`).
    3. Add a tRPC query call: `const overrideAudits = api.research.listOverrideAudits.useQuery({ runId: latestRunId }, { enabled: !!latestRunId })`.
    4. Render an "Override History" section below the existing research details:
       - Only render when `overrideAudits.data?.length > 0`
       - Header: "Override History" with a ShieldAlert icon
       - For each audit record, render a compact row:
         - Date: `new Date(audit.createdAt).toLocaleDateString('nl-NL')` + time
         - Gate type badge: use color coding — 'quality' = red chip, 'pain' = amber chip, 'quality+pain' = red chip
         - Reason text (the admin-entered reason)
         - Actor label (will be "admin" for now)
       - Use a simple list layout (not table) — consistent with compact UI preference
       - Example structure:
         ```tsx
         <div className="space-y-3">
           <h3 className="text-xs font-black uppercase tracking-widest text-slate-400 flex items-center gap-2">
             <ShieldAlert className="w-4 h-4" /> Override History
           </h3>
           {overrideAudits.data.map(audit => (
             <div key={audit.id} className="p-3 bg-amber-50/50 border border-amber-100 rounded-xl text-xs space-y-1">
               <div className="flex items-center gap-2">
                 <span className="font-mono text-slate-400">{formatDate(audit.createdAt)}</span>
                 <span className={gateTypeBadgeClass(audit.gateType)}>{audit.gateType}</span>
               </div>
               <p className="text-slate-600">{audit.reason}</p>
             </div>
           ))}
         </div>
         ```
    5. Import ShieldAlert from lucide-react.
    6. Helper function `gateTypeBadgeClass` returns Tailwind classes based on gateType:
       - 'quality': red/rose badge
       - 'pain': amber badge
       - 'quality+pain': red/rose badge
  </action>
  <verify>
    <automated>npm run check</automated>
    <manual>Visit /admin/prospects/[id] for a prospect with an override — override history section shows with timestamp, gate type, and reason. For prospects without overrides, no history section appears.</manual>
  </verify>
  <done>Override history renders on prospect detail page for research runs with gate bypasses. Section hidden when no audits exist. Each audit shows date, gate type badge, and reason.</done>
</task>

</tasks>

<verification>
```bash
npm run check
```
Visual verification: Load /admin/prospects — "Bypassed" badge visible for overridden prospects. Click into a prospect with override — override history section visible with audit details.
</verification>

<success_criteria>

- Prospect list shows "Bypassed" badge for prospects with gate override audits
- Prospects without overrides show no badge
- Research run detail view shows override history with all audit fields
- Override history section hidden when no audits exist
- npm run check passes
  </success_criteria>

<output>
After completion, create `.planning/phases/30-pain-confirmation-gate-override-audit/30-04-SUMMARY.md`
</output>
