---
phase: 30-pain-confirmation-gate-override-audit
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/quality-config.ts
  - lib/workflow-engine.ts
  - lib/workflow-engine.test.ts
autonomous: true
requirements: [GATE-01, GATE-02, GATE-03]

must_haves:
  truths:
    - 'computePainTagConfirmation returns confirmed tags for tags backed by 2+ distinct sourceTypes'
    - 'computePainTagConfirmation returns unconfirmed tags for tags backed by only 1 sourceType'
    - 'evaluateQualityGate output includes confirmedPainTags and unconfirmedPainTags arrays'
    - 'Unconfirmed pain tags do NOT cause gate.passed to become false (advisory-only)'
    - 'Placeholder evidence items are excluded from pain tag confirmation counting'
  artifacts:
    - path: 'lib/quality-config.ts'
      provides: 'PAIN_CONFIRMATION_MIN_SOURCES constant'
      contains: 'PAIN_CONFIRMATION_MIN_SOURCES'
    - path: 'lib/workflow-engine.ts'
      provides: 'computePainTagConfirmation function and extended QualityGateResult'
      exports: ['computePainTagConfirmation']
    - path: 'lib/workflow-engine.test.ts'
      provides: 'Unit tests for pain tag confirmation'
      contains: 'computePainTagConfirmation'
  key_links:
    - from: 'lib/workflow-engine.ts'
      to: 'lib/quality-config.ts'
      via: 'import PAIN_CONFIRMATION_MIN_SOURCES'
      pattern: 'import.*PAIN_CONFIRMATION_MIN_SOURCES.*quality-config'
    - from: 'lib/workflow-engine.ts'
      to: 'evaluateQualityGate'
      via: 'computePainTagConfirmation called inside evaluateQualityGate'
      pattern: 'computePainTagConfirmation'
---

<objective>
Implement cross-source pain tag confirmation as a pure, tested function and wire it into the existing quality gate output.

Purpose: GATE-01 requires per-workflowTag confirmation (2+ distinct sourceTypes). GATE-02 requires the arrays in QualityGateResult. GATE-03 requires advisory-only semantics (no hard block).
Output: `computePainTagConfirmation` function with TDD, extended `QualityGateResult` interface, `PAIN_CONFIRMATION_MIN_SOURCES` constant.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-pain-confirmation-gate-override-audit/30-RESEARCH.md
@lib/quality-config.ts
@lib/workflow-engine.ts
@lib/workflow-engine.test.ts
</context>

<feature>
  <name>Cross-source pain tag confirmation</name>
  <files>lib/quality-config.ts, lib/workflow-engine.ts, lib/workflow-engine.test.ts</files>
  <behavior>
    Given a list of EvidenceInput items:

    1. Group non-placeholder items by workflowTag (only tags in PAIN_WORKFLOW_TAGS set)
    2. For each tag, count distinct sourceType values
    3. Tags with distinctSourceTypes >= PAIN_CONFIRMATION_MIN_SOURCES (2) → confirmedPainTags
    4. Tags with distinctSourceTypes < 2 → unconfirmedPainTags
    5. Tags with zero evidence do not appear in either list

    Cases:
    - 3 items: tag "planning" from WEBSITE + REVIEWS + CAREERS → confirmed
    - 2 items: tag "handoff" from WEBSITE + WEBSITE → unconfirmed (1 distinct sourceType)
    - 1 item: tag "billing" from REVIEWS → unconfirmed
    - Placeholder item (notFound=true) for tag "planning" from REVIEWS → excluded from counting
    - Item with aiRelevance < 0.5 → still counts for pain tag confirmation (only excluded from confidence average, not from pain tag counting; isPlaceholder checks notFound/fallback, not aiRelevance)

    QualityGateResult interface adds:
    - confirmedPainTags: string[]
    - unconfirmedPainTags: string[]

    evaluateQualityGate calls computePainTagConfirmation(items) and spreads result into output.
    gate.passed is NOT affected by unconfirmed tags (GATE-03: advisory-only).

  </behavior>
  <implementation>
    RED phase:
    1. Add `PAIN_CONFIRMATION_MIN_SOURCES = 2` to lib/quality-config.ts with JSDoc
    2. Add test cases to lib/workflow-engine.test.ts:
       - Test: confirmed tag (2+ distinct sourceTypes for same workflowTag)
       - Test: unconfirmed tag (1 sourceType for workflowTag)
       - Test: placeholder items excluded from confirmation counting
       - Test: evaluateQualityGate includes confirmedPainTags/unconfirmedPainTags in output
       - Test: unconfirmed tags do NOT cause gate.passed to become false
    3. Run tests — they MUST fail (computePainTagConfirmation does not exist yet)

    GREEN phase:
    1. Add `computePainTagConfirmation(items: EvidenceInput[])` to lib/workflow-engine.ts:
       - Filter out placeholder items using existing `isPlaceholder()` function
       - Filter to PAIN_WORKFLOW_TAGS only
       - Group by workflowTag, count distinct sourceType per tag
       - Split into confirmed (>= PAIN_CONFIRMATION_MIN_SOURCES) and unconfirmed
       - Export the function
    2. Extend `QualityGateResult` interface with `confirmedPainTags: string[]` and `unconfirmedPainTags: string[]`
    3. In `evaluateQualityGate`, call `computePainTagConfirmation(items)` and spread into return object
       - Do NOT add unconfirmed tags to `reasons` array (advisory-only, GATE-03)
       - Do NOT change `passed` logic based on pain tags
    4. Run tests — they MUST pass

    REFACTOR phase: none expected (logic is straightforward).

  </implementation>
</feature>

<verification>
```bash
npm test -- --run lib/workflow-engine.test.ts
npm run check
```
</verification>

<success_criteria>

- computePainTagConfirmation is exported and tested with 5+ test cases
- QualityGateResult interface includes confirmedPainTags and unconfirmedPainTags
- evaluateQualityGate returns pain tag arrays without affecting gate.passed
- PAIN_CONFIRMATION_MIN_SOURCES = 2 lives in quality-config.ts (client-safe)
- All existing tests still pass
- `npm run check` passes with zero errors
  </success_criteria>

<output>
After completion, create `.planning/phases/30-pain-confirmation-gate-override-audit/30-01-SUMMARY.md`
</output>
