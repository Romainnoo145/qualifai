---
phase: 30-pain-confirmation-gate-override-audit
plan: 03
type: execute
wave: 2
depends_on: ['30-01', '30-02']
files_modified:
  - server/routers/outreach.ts
  - app/admin/outreach/page.tsx
autonomous: true
requirements: [GATE-04, GATE-05]

must_haves:
  truths:
    - 'Send queue draft cards display confirmed and unconfirmed pain tags'
    - 'Drafts for prospects with unconfirmed pain tags show an amber warning signal'
    - 'Send button is disabled until admin types a reason (min 12 chars) when unconfirmed pain tags exist'
    - 'Override reason is passed to the approveQuality mutation when submitting'
    - 'Pain tag chips use established amber/green color tokens consistent with quality gate chips'
  artifacts:
    - path: 'server/routers/outreach.ts'
      provides: 'Pain confirmation data enrichment in getDecisionInbox response'
      contains: 'confirmedPainTags'
    - path: 'app/admin/outreach/page.tsx'
      provides: 'Pain signal rendering and override reason textarea in draft cards'
      contains: 'unconfirmedPainTags'
  key_links:
    - from: 'server/routers/outreach.ts'
      to: 'ResearchRun.summary.gate'
      via: 'getDecisionInbox reads confirmedPainTags/unconfirmedPainTags from latest run summary'
      pattern: 'confirmedPainTags'
    - from: 'app/admin/outreach/page.tsx'
      to: 'server/routers/outreach.ts'
      via: 'tRPC query consuming pain tag data per draft'
      pattern: 'unconfirmedPainTags'
    - from: 'app/admin/outreach/page.tsx'
      to: 'server/routers/research.ts'
      via: 'approveQuality mutation called with override reason'
      pattern: 'approveQuality'
---

<objective>
Surface pain confirmation status in the send queue and require an override reason when proceeding with unconfirmed pain tags.

Purpose: GATE-04 requires the admin to see pain confirmation alongside the quality gate before sending. GATE-05 requires a mandatory reason when bypassing unconfirmed pain.
Output: Enriched getDecisionInbox response, pain tag chips in draft cards, override reason textarea.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-pain-confirmation-gate-override-audit/30-RESEARCH.md
@.planning/phases/30-pain-confirmation-gate-override-audit/30-01-SUMMARY.md
@server/routers/outreach.ts
@app/admin/outreach/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enrich getDecisionInbox with pain confirmation data</name>
  <files>server/routers/outreach.ts</files>
  <action>
    In the `getDecisionInbox` query (server/routers/outreach.ts):
    1. After fetching drafts, collect unique prospectIds from `drafts.map(d => d.contact.prospectId)`
    2. Fetch the latest COMPLETED ResearchRun per prospect:
       ```typescript
       const runsByProspect = await ctx.db.researchRun.findMany({
         where: { prospectId: { in: prospectIds }, status: 'COMPLETED' },
         orderBy: { createdAt: 'desc' },
         distinct: ['prospectId'],
         select: { prospectId: true, summary: true, id: true, qualityApproved: true },
       });
       ```
    3. Build a Map from prospectId to run data
    4. Inside the existing `drafts.map(...)` where items are enriched with `classifyDraftRisk`, also extract from the run map:
       - `confirmedPainTags: string[]` from `run.summary.gate.confirmedPainTags ?? []`
       - `unconfirmedPainTags: string[]` from `run.summary.gate.unconfirmedPainTags ?? []`
       - `qualityGatePassed: boolean` from `run.summary.gate.passed ?? true`
       - `qualityApproved: boolean | null` from `run.qualityApproved`
       - `latestRunId: string` from `run.id`
    5. Spread these into each draft item's return object
    6. Use safe JSON parsing for summary (it's a Json field): cast through `Record<string, unknown>`, check for `.gate` property existence
  </action>
  <verify>
    <automated>npm run check</automated>
    <manual>TypeScript compiles; getDecisionInbox response now includes pain tag arrays per draft</manual>
  </verify>
  <done>Each draft item in getDecisionInbox includes confirmedPainTags, unconfirmedPainTags, qualityGatePassed, qualityApproved, and latestRunId from the latest completed research run.</done>
</task>

<task type="auto">
  <name>Task 2: Render pain confirmation signal and override reason in send queue UI</name>
  <files>app/admin/outreach/page.tsx</files>
  <action>
    In app/admin/outreach/page.tsx, find the draft card rendering section (inside the "queue" view):

    1. **Pain tag chips:** After the existing quality gate indicator (or risk level display), add a row of pain confirmation chips:
       - For each `confirmedPainTags` item: render a small green chip with ShieldCheck icon: `<span className="inline-flex items-center gap-1 text-[9px] font-black px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-600 border border-emerald-100"><ShieldCheck className="w-3 h-3" />{tag}</span>`
       - For each `unconfirmedPainTags` item: render a small amber chip with AlertTriangle icon: `<span className="inline-flex items-center gap-1 text-[9px] font-black px-2 py-0.5 rounded-full bg-amber-50 text-amber-600 border border-amber-100"><AlertTriangle className="w-3 h-3" />{tag}</span>`
       - Wrap chips in a `<div className="flex flex-wrap gap-1.5 mt-2">` container
       - Only render the container if `confirmedPainTags.length + unconfirmedPainTags.length > 0`

    2. **Override reason textarea:** When `unconfirmedPainTags.length > 0` AND the draft has not been quality-approved yet:
       - Add a textarea below the pain chips: `<textarea className="input-minimal w-full mt-3 text-xs" placeholder="Reden voor doorgaan ondanks onbevestigde pijn..." rows={2} />`
       - Track the reason in local state per draft (use a Map or object state keyed by draft.id)
       - The existing send/approve button must be disabled when: `unconfirmedPainTags.length > 0 && overrideReason.trim().length < 12`
       - When the reason is provided and send is clicked, pass the `overrideReason` to the approval flow (the approveQuality mutation in research router already accepts `notes` field — use that)

    3. **Import adjustments:**
       - ShieldCheck and AlertTriangle are already imported in the file — verify and add if missing
       - Import PAIN_CONFIRMATION_MIN_SOURCES from '@/lib/quality-config' is NOT needed client-side (the comparison is done server-side); just check array length

    4. **UX details:**
       - Character counter below the textarea: `<span className="text-[9px] text-slate-400">{overrideReason.length}/12 min</span>`
       - The textarea and counter only appear when there are unconfirmed tags AND the draft needs approval
       - If all pain tags are confirmed (no unconfirmed), no textarea is shown — the draft can proceed normally

  </action>
  <verify>
    <automated>npm run check</automated>
    <manual>Visit /admin/outreach — draft cards show pain tag chips (green for confirmed, amber for unconfirmed); send button requires reason when unconfirmed tags present</manual>
  </verify>
  <done>Draft cards display confirmed (green) and unconfirmed (amber) pain tag chips. Override reason textarea appears when unconfirmed tags exist. Send button disabled until reason >= 12 chars. Reason passed to approveQuality mutation.</done>
</task>

</tasks>

<verification>
```bash
npm run check
```
Visual verification: Load /admin/outreach in browser, verify pain tag chips render on draft cards with correct colors, and override reason textarea appears for drafts with unconfirmed pain tags.
</verification>

<success_criteria>

- getDecisionInbox returns confirmedPainTags and unconfirmedPainTags per draft item
- Draft cards show green chips for confirmed tags and amber chips for unconfirmed tags
- Override reason textarea appears only when unconfirmed tags exist
- Send button is disabled without a 12+ char reason when unconfirmed tags present
- npm run check passes
  </success_criteria>

<output>
After completion, create `.planning/phases/30-pain-confirmation-gate-override-audit/30-03-SUMMARY.md`
</output>
