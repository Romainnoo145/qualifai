---
phase: 10-cadence-engine
plan: 04
type: execute
wave: 4
depends_on: ['10-03']
files_modified:
  - app/admin/prospects/[id]/page.tsx
  - components/features/CadenceTab.tsx
autonomous: true

must_haves:
  truths:
    - 'Admin can see a Cadence tab in the prospect detail page'
    - 'Cadence tab shows completed touches with channel, date, and trigger source'
    - 'Cadence tab shows current pending step with scheduled date and channel'
    - 'Cadence tab shows engagement level (high/normal) and touch count summary'
    - 'Cadence tab shows exhausted state when sequence is closed_lost'
  artifacts:
    - path: 'components/features/CadenceTab.tsx'
      provides: 'Cadence history and state display component'
      contains: 'CadenceTab'
    - path: 'app/admin/prospects/[id]/page.tsx'
      provides: 'Cadence tab registration in prospect detail'
      contains: "'cadence'"
  key_links:
    - from: 'app/admin/prospects/[id]/page.tsx'
      to: 'components/features/CadenceTab.tsx'
      via: "Tab rendering when activeTab === 'cadence'"
      pattern: 'activeTab.*cadence.*CadenceTab'
    - from: 'components/features/CadenceTab.tsx'
      to: 'trpc.sequences.getCadenceState'
      via: 'tRPC query for cadence data'
      pattern: "trpc\\.sequences\\.getCadenceState"
---

<objective>
Add a Cadence tab to the prospect detail page that displays cadence history, current state, and engagement level.

Purpose: Admin needs visibility into where each prospect is in their cadence — how many touches completed, what the next step is, when it is scheduled, and whether the prospect is engaged. This fulfills CADNC-05 and makes the cadence engine observable.

Output: CadenceTab component and prospect detail page updated with new tab.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/10-cadence-engine/10-03-SUMMARY.md
@app/admin/prospects/[id]/page.tsx
@server/routers/sequences.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CadenceTab component</name>
  <files>components/features/CadenceTab.tsx</files>
  <action>
Create `components/features/CadenceTab.tsx` — a client component that displays cadence state for a prospect.

The component receives `prospectId: string` as prop and fetches data via `trpc.sequences.getCadenceState.useQuery({ prospectId })`.

**Layout (follow existing tab component patterns like CallPrepTab, HypothesesTab):**

1. **Summary card** at top:
   - Engagement level badge: "High Engagement" (green) or "Normal" (slate)
   - Touch count: "3 of 4 touches completed"
   - Status: "Active" / "Exhausted (closed lost)" / "No cadence active"
   - Next step: "Call scheduled for Feb 23" or "No pending step"

2. **Timeline** below — vertical list of all steps across all sequences, ordered by stepOrder:
   - Each step shows:
     - Channel icon/label (email, call, linkedin, whatsapp)
     - Status badge: DRAFTED (yellow), QUEUED (blue), SENT (green), CLOSED_LOST (red)
     - `triggeredBy` label: "cadence" / "manual" / "wizard_step3" / "pdf_download" / "interested_reply"
     - Date: `sentAt` for completed, `nextStepReadyAt` for pending, `scheduledAt` for queued
   - Current pending step highlighted with a pulsing dot or distinct border

3. **Empty state** when no sequences exist:
   - "No cadence history for this prospect. Cadence starts after the first outreach sequence is sent."

**Styling:** Use Tailwind utilities. Follow the existing design system in the prospect detail page (slate colors, rounded-2xl cards, text-xs/text-sm sizing, uppercase tracking for labels). Use CSS variables for brand colors (never hardcode).

**Channel icons:** Use lucide-react icons matching the channel:

- email: Mail
- call: Phone
- linkedin: Linkedin (or Globe if not available)
- whatsapp: MessageCircle

**Date formatting:** Use `.toLocaleDateString('nl-NL', { day: 'numeric', month: 'short', year: 'numeric' })` for dates. Handle null dates with "—".

**Loading state:** Show a simple skeleton or "Loading cadence data..." text while query is pending.

Keep the component under 200 lines. If it grows larger, extract the timeline item into a sub-component in the same file.
</action>
<verify>

1. `npm run check` passes — no type errors
2. Component file exists and exports CadenceTab
3. Component uses trpc.sequences.getCadenceState query
   </verify>
   <done>
   CadenceTab component displays engagement level, touch count summary, pending step info, and a timeline of all cadence steps with channel/status/trigger/date details.
   </done>
   </task>

<task type="auto">
  <name>Task 2: Add Cadence tab to prospect detail page</name>
  <files>app/admin/prospects/[id]/page.tsx</files>
  <action>
In `app/admin/prospects/[id]/page.tsx`:

1. Add `'cadence'` to the `Tab` union type:

```typescript
type Tab =
  | 'company'
  | 'contacts'
  | 'signals'
  | 'wizard'
  | 'research'
  | 'hypotheses'
  | 'lossmap'
  | 'callprep'
  | 'cadence'; // NEW
```

2. Import the CadenceTab component:

```typescript
import { CadenceTab } from '@/components/features/CadenceTab';
```

3. Import a suitable icon from lucide-react for the tab (e.g., `Timer`, `Repeat`, or `Gauge`):

```typescript
import { Timer } from 'lucide-react'; // or Repeat, Gauge — whichever fits
```

4. Add the cadence tab entry to the `tabs` array (place it after 'callprep', as the last tab — cadence is the final step in the prospect workflow):

```typescript
{ key: 'cadence' as const, label: 'Cadence', icon: Timer },
```

5. Add the tab content rendering (after the `activeTab === 'wizard'` block):

```typescript
{activeTab === 'cadence' && (
  <CadenceTab prospectId={id} />
)}
```

That is the minimal change — the tab switching mechanism already handles the rest via the `tabs.map` loop.
</action>
<verify>

1. `npm run check` passes — no type errors
2. Tab type includes 'cadence'
3. Cadence tab appears in the tab bar with an icon
4. CadenceTab renders when the cadence tab is active
   </verify>
   <done>
   Prospect detail page has a Cadence tab that renders CadenceTab component, showing full cadence history and state for the prospect.
   </done>
   </task>

</tasks>

<verification>
- `npm run check` passes
- Prospect detail page shows Cadence tab in the tab bar
- Clicking Cadence tab loads cadence state from tRPC and displays timeline
- Empty state shown when no cadence data exists
</verification>

<success_criteria>
Admin can navigate to any prospect detail page, click the Cadence tab, and see: engagement level, touch count, pending next step, and a timeline of all cadence steps with channels, dates, and trigger sources.
</success_criteria>

<output>
After completion, create `.planning/phases/10-cadence-engine/10-04-SUMMARY.md`
</output>
