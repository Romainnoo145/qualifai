---
phase: 10-cadence-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/YYYYMMDDHHMMSS_cadence_engine_columns/migration.sql
autonomous: true

must_haves:
  truths:
    - 'OutreachStep model has scheduledAt, triggeredBy, and nextStepReadyAt nullable columns'
    - 'nextStepReadyAt column has a database index for efficient cron queries'
    - 'Prisma Client is regenerated and TypeScript can reference the new columns'
  artifacts:
    - path: 'prisma/schema.prisma'
      provides: 'OutreachStep cadence columns'
      contains: 'scheduledAt'
    - path: 'prisma/migrations/YYYYMMDDHHMMSS_cadence_engine_columns/migration.sql'
      provides: 'SQL migration for cadence columns'
      contains: 'nextStepReadyAt'
  key_links:
    - from: 'prisma/schema.prisma'
      to: 'OutreachStep'
      via: 'scheduledAt, triggeredBy, nextStepReadyAt columns + @@index'
      pattern: 'nextStepReadyAt.*DateTime'
---

<objective>
Add three cadence engine columns to the OutreachStep model and create the Prisma migration.

Purpose: The cadence engine needs `scheduledAt` (when the step was scheduled), `triggeredBy` (what created it: manual, cadence, engagement trigger), and `nextStepReadyAt` (when the cron should promote it to a touch task). These are real DB columns per the locked decision — not JSON metadata — so the cron can query `WHERE nextStepReadyAt <= NOW()` efficiently.

Output: Updated schema.prisma, migration SQL, regenerated Prisma Client.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@prisma/schema.prisma
@prisma.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cadence columns to OutreachStep and run migration</name>
  <files>prisma/schema.prisma, prisma/migrations/YYYYMMDDHHMMSS_cadence_engine_columns/migration.sql</files>
  <action>
Add three nullable columns to the OutreachStep model in prisma/schema.prisma:

```prisma
model OutreachStep {
  // ...existing fields (id, createdAt, updatedAt, stepOrder, subject, bodyText, bodyHtml, plannedAt, sentAt, status, metadata)...

  // Phase 10: Cadence Engine columns
  scheduledAt     DateTime?    // When this step was scheduled by cadence engine
  triggeredBy     String?      // 'manual' | 'cadence' | TriggerSource values
  nextStepReadyAt DateTime?    // When the NEXT step should be created (cron-queryable)

  // ...existing relations (sequenceId, sequence, outreachLogId, outreachLog)...

  @@unique([sequenceId, stepOrder])
  @@index([outreachLogId])
  @@index([nextStepReadyAt])   // NEW: enables efficient cron sweep query
}
```

Place the three new fields AFTER `metadata Json?` and BEFORE `sequenceId String`. Add the `@@index([nextStepReadyAt])` after existing `@@index([outreachLogId])`.

Then run:

1. `npx prisma migrate dev --name cadence_engine_columns` to create and apply the migration
2. `npx prisma generate` to regenerate the Prisma Client (usually done by migrate dev, but verify)

Verify the generated SQL contains:

- `ALTER TABLE "OutreachStep" ADD COLUMN "scheduledAt" TIMESTAMP(3)`
- `ALTER TABLE "OutreachStep" ADD COLUMN "triggeredBy" TEXT`
- `ALTER TABLE "OutreachStep" ADD COLUMN "nextStepReadyAt" TIMESTAMP(3)`
- `CREATE INDEX "OutreachStep_nextStepReadyAt_idx" ON "OutreachStep"("nextStepReadyAt")`

All columns are nullable — no default values, no backfill needed. This is a purely additive migration.
</action>
<verify>

1. `npx prisma validate` exits 0
2. Migration SQL file exists in `prisma/migrations/` with the expected ALTER TABLE statements
3. TypeScript can compile: `npx tsc --noEmit` (or `npm run check`) should not error on OutreachStep type references
   </verify>
   <done>
   OutreachStep has scheduledAt, triggeredBy, and nextStepReadyAt columns. The nextStepReadyAt column has a database index. Prisma Client is regenerated and type-safe.
   </done>
   </task>

</tasks>

<verification>
- `npx prisma validate` passes
- Migration file exists with correct ALTER TABLE + CREATE INDEX statements
- `npm run check` passes (no type errors from schema change)
</verification>

<success_criteria>
OutreachStep schema includes three new nullable DateTime/String columns with an index on nextStepReadyAt, migration applied, Prisma Client regenerated.
</success_criteria>

<output>
After completion, create `.planning/phases/10-cadence-engine/10-01-SUMMARY.md`
</output>
