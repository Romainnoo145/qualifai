---
phase: 10-cadence-engine
plan: 02
type: tdd
wave: 2
depends_on: ['10-01']
files_modified:
  - lib/cadence/engine.ts
  - lib/cadence/engine.test.ts
autonomous: true

must_haves:
  truths:
    - 'buildCadenceState returns correct next channel, delay, and exhaustion state for given completed touches and engagement signals'
    - 'High-engagement prospects (wizard step 3+ or PDF download) get shorter delay than normal prospects'
    - 'Channel rotation skips unavailable channels based on contact data'
    - 'Cadence is exhausted (isExhausted=true) when touch count reaches maxTouches'
    - 'evaluateCadence creates a new OutreachStep with correct scheduledAt, triggeredBy, and nextStepReadyAt when cadence is not exhausted'
    - 'processDueCadenceSteps queries due steps and creates OutreachLog touch tasks, updating step status to QUEUED'
    - 'Email opens (openedAt) are NOT used for engagement level detection'
  artifacts:
    - path: 'lib/cadence/engine.ts'
      provides: 'Cadence engine core functions'
      exports:
        [
          'buildCadenceState',
          'evaluateCadence',
          'processDueCadenceSteps',
          'DEFAULT_CADENCE_CONFIG',
          'CadenceConfig',
          'CadenceState',
        ]
    - path: 'lib/cadence/engine.test.ts'
      provides: 'Unit tests for cadence engine'
      contains: 'describe.*buildCadenceState'
  key_links:
    - from: 'lib/cadence/engine.ts'
      to: 'prisma.outreachStep'
      via: 'evaluateCadence creates OutreachStep records'
      pattern: "db\\.outreachStep\\.create"
    - from: 'lib/cadence/engine.ts'
      to: 'prisma.wizardSession'
      via: 'engagement level detection reads wizard session'
      pattern: "db\\.wizardSession\\.findFirst"
---

<objective>
Build the cadence engine: three pure/DB functions that decide what the next touch should be, when it should happen, and promote due steps into touch tasks.

Purpose: This is the brain of the multi-touch cadence system. `buildCadenceState` is a pure function that computes next channel and timing. `evaluateCadence` creates the next OutreachStep in the database. `processDueCadenceSteps` is the cron sweep function that promotes due steps into OutreachLog touch tasks.

Output: Tested cadence engine at `lib/cadence/engine.ts` with unit tests.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/10-cadence-engine/10-01-SUMMARY.md
@prisma/schema.prisma
@lib/outreach/engagement-triggers.ts
@lib/outreach/quality.test.ts
@server/routers/outreach.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD — Cadence engine with buildCadenceState, evaluateCadence, and processDueCadenceSteps</name>
  <files>lib/cadence/engine.ts, lib/cadence/engine.test.ts</files>
  <action>
**RED phase — Write failing tests first:**

Create `lib/cadence/engine.test.ts` using vitest (same pattern as `lib/outreach/quality.test.ts`).

Test cases for `buildCadenceState` (pure function, no mocks needed):

1. **Normal engagement, first touch completed** — returns `nextChannel` as second in rotation, `delayDays` = baseDelayDays (3), `isExhausted` = false, `engagementLevel` = 'normal'
2. **High engagement (wizard step 3+)** — returns `delayDays` = engagedDelayDays (1), `engagementLevel` = 'high'
3. **High engagement (PDF downloaded)** — returns `delayDays` = engagedDelayDays (1), `engagementLevel` = 'high'
4. **All touches completed (maxTouches reached)** — returns `isExhausted` = true, `nextChannel` = null, `nextScheduledAt` = null
5. **Channel rotation skips unavailable** — when contact has no `linkedinUrl`, LinkedIn is skipped in rotation; when no `primaryPhone`, call and WhatsApp are skipped
6. **Empty completed touches** — returns `touchCount` = 0, first channel in config, `lastTouchAt` = null
7. **Email opens are NOT considered for engagement** — passing `wizardMaxStep: 0, pdfDownloaded: false` returns 'normal' even if opens exist (openedAt is not in the interface)

Test cases for `evaluateCadence` (needs DB mock):

8. **Creates new OutreachStep** — when cadence is not exhausted, creates a step with `stepOrder = completedCount + 1`, `status = 'DRAFTED'`, `scheduledAt = now`, `nextStepReadyAt = now + delayDays`, `triggeredBy = 'cadence'`
9. **Does NOT create step when exhausted** — returns `{ created: false, stepId: null }`
10. **Sets sequence status to CLOSED_LOST when exhausted** — after maxTouches, updates OutreachSequence.status

Test cases for `processDueCadenceSteps`:

11. **Promotes due steps** — finds steps with `nextStepReadyAt <= now && status === 'DRAFTED'`, creates OutreachLog with `type: 'FOLLOW_UP'`, `channel` from step metadata, `status: 'touch_open'`, updates step status to 'QUEUED'
12. **Skips non-due steps** — steps with `nextStepReadyAt` in future are not processed
13. **Limits batch size** — processes max 50 steps per sweep

Use mock PrismaClient pattern: create a mock object with `outreachStep.findMany`, `outreachStep.create`, `outreachLog.create`, `outreachSequence.update`, `wizardSession.findFirst` as vi.fn() stubs.

**GREEN phase — Implement the engine:**

Create `lib/cadence/engine.ts` with these exports:

```typescript
// Types
export interface CadenceConfig {
  baseDelayDays: number; // Default: 3
  engagedDelayDays: number; // Default: 1
  maxTouches: number; // Default: 4
  channels: readonly ('email' | 'call' | 'linkedin' | 'whatsapp')[];
}

export interface CadenceState {
  touchCount: number;
  lastTouchAt: Date | null;
  nextChannel: 'email' | 'call' | 'linkedin' | 'whatsapp' | null;
  nextScheduledAt: Date | null;
  isExhausted: boolean;
  engagementLevel: 'high' | 'normal';
  delayDays: number;
}

// Contact channel availability for filtering
export interface ContactChannels {
  primaryEmail: string | null;
  primaryPhone: string | null;
  linkedinUrl: string | null;
}

export interface EngagementSignals {
  wizardMaxStep: number;
  pdfDownloaded: boolean;
}

// Default config — values pending product owner sign-off, easy to adjust
// TODO: Get product owner confirmation on these thresholds
export const DEFAULT_CADENCE_CONFIG: CadenceConfig = {
  baseDelayDays: 3,
  engagedDelayDays: 1,
  maxTouches: 4,
  channels: ['email', 'call', 'linkedin', 'whatsapp'],
};
```

**buildCadenceState** (pure function):

- Takes `completedTouches: Array<{ completedAt: Date; channel: string; stepOrder: number }>`, `engagementSignals: EngagementSignals`, `contactChannels: ContactChannels`, `config: CadenceConfig`
- `engagementLevel` = 'high' when `wizardMaxStep >= 3 || pdfDownloaded`, else 'normal'
- `delayDays` = high ? `engagedDelayDays` : `baseDelayDays`
- Filter `config.channels` by contact availability: email needs `primaryEmail`, call/whatsapp need `primaryPhone`, linkedin needs `linkedinUrl`
- `nextChannel` = availableChannels[touchCount % availableChannels.length] (or null if no channels / exhausted)
- `isExhausted` = touchCount >= maxTouches
- `nextScheduledAt` = lastTouchAt + delayDays (as Date), or null if exhausted / no lastTouch
- `lastTouchAt` = max(completedTouches.map(t => t.completedAt)) or null

**evaluateCadence** (async, takes PrismaClient):

- Takes `db: PrismaClient`, `sequenceId: string`, `config: CadenceConfig`
- Loads sequence with all completed steps (status SENT or QUEUED), contact channels, and prospect's latest WizardSession
- Calls `buildCadenceState` with loaded data
- If exhausted: update sequence status to CLOSED_LOST, return `{ created: false, stepId: null, scheduledAt: null }`
- If not exhausted: create new OutreachStep with `stepOrder = touchCount + 1`, `bodyText = ''` (placeholder — cron will create actual task), `status = 'DRAFTED'`, `scheduledAt = new Date()`, `triggeredBy = 'cadence'`, `nextStepReadyAt = state.nextScheduledAt`, `metadata = { channel: state.nextChannel }`. Return `{ created: true, stepId, scheduledAt }`

**processDueCadenceSteps** (async, takes PrismaClient):

- Queries `outreachStep.findMany({ where: { nextStepReadyAt: { lte: now }, status: 'DRAFTED' }, include: { sequence: { include: { contact: true, prospect: true } } }, take: 50, orderBy: { nextStepReadyAt: 'asc' } })`
- For each due step:
  - Read channel from `step.metadata.channel` (or default to 'email')
  - Create OutreachLog: `type: 'FOLLOW_UP'`, `channel`, `contactId: step.sequence.contactId`, `status: 'touch_open'`, `subject: 'Cadence follow-up: {channel}'`, `metadata: { kind: 'touch_task', priority: 'medium', createdBy: 'cadence-engine', outreachSequenceId: step.sequenceId, outreachStepId: step.id }`
  - Update OutreachStep: `status = 'QUEUED'`, `outreachLogId = newLog.id`
- Return `{ processed: count, created: count }`

Use native `Date` arithmetic for delay calculation: `new Date(lastTouch.getTime() + delayDays * 86400000)`

IMPORTANT: Do NOT read openedAt or any email open data in the engagement detection. Per locked decision, email opens are excluded from cadence escalation.

**REFACTOR phase:** Clean up, ensure all tests pass, ensure exports are properly typed.
</action>
<verify>

1. `npx vitest run lib/cadence/engine.test.ts` — all tests pass
2. `npm run check` — no type errors
3. All 13 test cases pass covering buildCadenceState, evaluateCadence, and processDueCadenceSteps
   </verify>
   <done>
   Cadence engine exports buildCadenceState (pure), evaluateCadence (DB), processDueCadenceSteps (cron sweep), DEFAULT_CADENCE_CONFIG, and all TypeScript types. All tests pass. Email opens are not considered for engagement level.
   </done>
   </task>

</tasks>

<verification>
- `npx vitest run lib/cadence/engine.test.ts` passes with all test cases
- `npm run check` passes
- Exported types: CadenceConfig, CadenceState, ContactChannels, EngagementSignals
- Exported functions: buildCadenceState, evaluateCadence, processDueCadenceSteps
- Exported constant: DEFAULT_CADENCE_CONFIG with comment noting values pending product owner sign-off
</verification>

<success_criteria>
Cadence engine is fully tested with 13+ test cases covering normal/high engagement, channel rotation, exhaustion, step creation, and cron sweep. No email open data used for engagement decisions.
</success_criteria>

<output>
After completion, create `.planning/phases/10-cadence-engine/10-02-SUMMARY.md`
</output>
