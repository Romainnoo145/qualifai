---
phase: 26.1-evidence-pipeline-expansion
plan: 01
subsystem: database
tags: [prisma, postgres, linkedin, evidence-pipeline, serp, backfill]

# Dependency graph
requires:
  - phase: 26-quality-calibration
    provides: EvidenceSourceType enum with WEBSITE, DOCS, CAREERS, HELP_CENTER, JOB_BOARD, REVIEWS, MANUAL_URL, REGISTRY
  - phase: 25-pipeline-hardening
    provides: research-executor.ts with discoverSerpUrls, discoverGoogleSearchMentions, LinkedIn evidence drafts
provides:
  - LINKEDIN and NEWS enum values in EvidenceSourceType (DB + Prisma client)
  - inferSourceType returns LINKEDIN for linkedin.com URLs
  - CONTEXT_SOURCE_TYPES includes LINKEDIN and NEWS for quality gate scoring
  - Domain exclusion filter in discoverGoogleSearchMentions
  - LinkedIn evidence drafts use sourceType LINKEDIN (not WEBSITE)
  - Backfill script for existing LinkedIn evidence items
affects: [26.1-02, 26.1-03, 26-quality-calibration, quality-gate, workflow-engine]

# Tech tracking
tech-stack:
  added: [@types/pg (devDependency — fixes TS7016 for pg module in scripts)]
  patterns:
    - Manual DB migration via docker exec psql + migration file creation (no prisma migrate dev)
    - inferSourceType pattern: URL substring matching, linkedin.com check before manual://
    - CONTEXT_SOURCE_TYPES Set pattern for quality gate source counting

key-files:
  created:
    - prisma/migrations/20260228_add_linkedin_news_source_types/migration.sql
    - scripts/backfill-linkedin-source-type.ts
  modified:
    - prisma/schema.prisma
    - lib/workflow-engine.ts
    - lib/research-executor.ts
    - lib/enrichment/serp.ts
    - package.json

key-decisions:
  - "LinkedIn evidence uses sourceType LINKEDIN (not WEBSITE) for both apollo-derived and crawl4ai sources"
  - "LINKEDIN confidence score 0.73 (slightly below WEBSITE 0.74 — public page, less business-critical)"
  - "CONTEXT_SOURCE_TYPES includes LINKEDIN and NEWS — external social proof counts as context"
  - "Own-domain filtering in discoverGoogleSearchMentions prevents duplicate evidence from SERP + WEBSITE"
  - "Installed @types/pg to fix pre-existing TS7016 in scripts/rerun-hypotheses.ts and new backfill script"

patterns-established:
  - "LinkedIn URLs always return LINKEDIN source type via inferSourceType (before MANUAL_URL fallback)"
  - "Backfill scripts follow PrismaPg adapter pattern with dotenv/config and process.env direct reads"

requirements-completed: [EXP-01, EXP-02]

# Metrics
duration: 3min
completed: 2026-02-28
---

# Phase 26.1 Plan 01: Schema Foundation for LINKEDIN/NEWS Source Types Summary

**LINKEDIN and NEWS EvidenceSourceType enum values added to DB + Prisma client, with inferSourceType detection, CONTEXT_SOURCE_TYPES inclusion, domain exclusion filter in SERP mentions, and a PrismaPg backfill script for existing LinkedIn evidence**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-28T03:55:10Z
- **Completed:** 2026-02-28T03:58:00Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments

- Added LINKEDIN and NEWS to EvidenceSourceType enum in DB and Prisma schema
- Updated inferSourceType to return LINKEDIN for linkedin.com URLs (before MANUAL_URL catch-all)
- Added LINKEDIN and NEWS to CONTEXT_SOURCE_TYPES Set — these count toward context score in quality gate
- Added own-domain filter to discoverGoogleSearchMentions — prevents duplicate SERP + WEBSITE evidence
- Updated LinkedIn evidence drafts in research-executor.ts to use sourceType LINKEDIN (confidence 0.73)
- Created backfill script using PrismaPg adapter pattern

## Task Commits

Each task was committed atomically:

1. **Task 1: Add LINKEDIN and NEWS to schema + update workflow-engine inference** - `6fcc90d` (feat)
2. **Task 2: Ungate SERP domain filter + LinkedIn backfill script** - `786f03b` (feat)

**Plan metadata:** committed with final docs commit

## Files Created/Modified

- `prisma/schema.prisma` - LINKEDIN and NEWS added to EvidenceSourceType enum
- `prisma/migrations/20260228_add_linkedin_news_source_types/migration.sql` - DB migration file
- `lib/workflow-engine.ts` - inferSourceType: LINKEDIN detection; CONTEXT_SOURCE_TYPES: LINKEDIN + NEWS added
- `lib/research-executor.ts` - LinkedIn evidence drafts use sourceType LINKEDIN (confidence 0.73)
- `lib/enrichment/serp.ts` - Domain exclusion filter in discoverGoogleSearchMentions
- `scripts/backfill-linkedin-source-type.ts` - One-shot backfill using PrismaPg adapter
- `package.json` - @types/pg added as devDependency

## Decisions Made

- LinkedIn evidence classified as LINKEDIN source type immediately (not deferred to backfill only)
- Used confidence 0.73 for LinkedIn evidence (matches plan's baseConfidence spec)
- Installed @types/pg to fix pre-existing TS7016 that affected existing scripts too
- Own-domain filter applied after all queries collect results, before final `.slice(0, 12)`

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Updated LinkedIn evidence sourceType in research-executor.ts**

- **Found during:** Task 2 (backfill script creation)
- **Issue:** Plan specified backfill for existing records but new LinkedIn evidence drafts in research-executor.ts still used `sourceType: 'WEBSITE'` — new runs would continue to misclassify
- **Fix:** Updated both apollo-derived profile evidence and crawl4ai browser extraction to use `sourceType: 'LINKEDIN'` with confidence 0.73
- **Files modified:** lib/research-executor.ts
- **Verification:** TypeScript type check passes with new enum value
- **Committed in:** 786f03b (Task 2 commit)

**2. [Rule 3 - Blocking] Installed @types/pg to fix TS7016**

- **Found during:** Task 2 (backfill script creation)
- **Issue:** New backfill script imports `Pool` from `pg` — same TS7016 error as pre-existing rerun-hypotheses.ts script (pg has no type declarations installed)
- **Fix:** Installed @types/pg as devDependency — fixes BOTH scripts, zero TypeScript errors now
- **Files modified:** package.json, package-lock.json
- **Verification:** npx tsc --noEmit shows 0 TypeScript errors
- **Committed in:** 786f03b (Task 2 commit)

---

**Total deviations:** 2 auto-fixed (1 missing critical, 1 blocking)
**Impact on plan:** Both fixes necessary for correctness. No scope creep.

## Issues Encountered

- `npm run check` script does not exist in this project — ran `npx tsc --noEmit` and `npm run lint` individually instead (plan references global CLAUDE.md pattern, not project-specific scripts)

## Self-Check

### Created files:

- [x] prisma/migrations/20260228_add_linkedin_news_source_types/migration.sql - FOUND
- [x] scripts/backfill-linkedin-source-type.ts - FOUND

### Verified artifacts:

- [x] DB enum has LINKEDIN and NEWS (verified via docker exec psql)
- [x] inferSourceType returns LINKEDIN for linkedin.com URLs (grep confirms line 216)
- [x] CONTEXT_SOURCE_TYPES includes LINKEDIN and NEWS (grep confirms lines 396-397)
- [x] 0 TypeScript errors (npx tsc --noEmit clean)

## Self-Check: PASSED

## Next Phase Readiness

- LINKEDIN and NEWS source types ready for use in downstream evidence collection plans (26.1-02, 26.1-03)
- Backfill script ready to run on production data: `npx tsx scripts/backfill-linkedin-source-type.ts`
- Quality gate (evaluatePainConfirmation) now counts LINKEDIN and NEWS toward context score
- Phase 26 quality calibration will see these new source types in source diversity metrics

---

_Phase: 26.1-evidence-pipeline-expansion_
_Completed: 2026-02-28_
