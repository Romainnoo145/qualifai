---
phase: 19-client-hypothesis-validation
plan: '01'
type: execute
wave: 1
depends_on: []
files_modified:
  - server/trpc.ts
  - server/routers/hypotheses.ts
  - server/routers/assets.ts
  - server/routers/wizard.ts
  - components/features/prospects/analysis-section.tsx
autonomous: true

must_haves:
  truths:
    - 'A tRPC mutation `hypotheses.validateByProspect` exists that accepts slug + hypothesisId + action (confirm/decline) and updates the hypothesis status'
    - 'The mutation validates that the hypothesis belongs to the prospect identified by slug before writing'
    - 'Admin `listAll` filter accepts PENDING and DECLINED as valid status filter values'
    - 'Outreach generation gates and requestQuote accept PENDING hypotheses alongside ACCEPTED'
    - "Admin Analysis section shows 'Confirmed by prospect' for ACCEPTED status instead of 'Pending validation'"
  artifacts:
    - path: 'server/trpc.ts'
      provides: 'prospectProcedure middleware'
      contains: 'prospectProcedure'
    - path: 'server/routers/hypotheses.ts'
      provides: 'validateByProspect mutation'
      contains: 'validateByProspect'
    - path: 'server/routers/assets.ts'
      provides: 'Updated hypothesis gates accepting PENDING'
      contains: 'in.*ACCEPTED.*PENDING'
    - path: 'server/routers/wizard.ts'
      provides: 'Updated requestQuote filter accepting PENDING'
      contains: 'in.*ACCEPTED.*PENDING'
    - path: 'components/features/prospects/analysis-section.tsx'
      provides: 'Updated STATUS_LABELS with Confirmed by prospect'
      contains: 'Confirmed by prospect'
  key_links:
    - from: 'server/routers/hypotheses.ts'
      to: 'server/trpc.ts'
      via: 'import prospectProcedure'
      pattern: 'import.*prospectProcedure.*from.*trpc'
    - from: 'server/routers/hypotheses.ts'
      to: 'prisma.workflowHypothesis'
      via: 'database update in validateByProspect'
      pattern: "workflowHypothesis\\.update"
---

<objective>
Add the backend infrastructure for prospect hypothesis validation: a slug-scoped tRPC middleware (`prospectProcedure`), a `validateByProspect` mutation on the hypotheses router, and cleanup of all `status: 'ACCEPTED'` references that should now include `'PENDING'`. Also update the admin STATUS_LABELS to reflect that ACCEPTED now means "Confirmed by prospect" since Phase 19 is where validation actually happens.

Purpose: Enable the /voor/ dashboard to call a secure, slug-scoped mutation to confirm or decline hypotheses, and ensure the rest of the system (outreach gates, admin UI) correctly handles the new status flow.
Output: Working tRPC mutation, updated status references, updated admin labels.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-client-hypothesis-validation/19-RESEARCH.md
@.planning/phases/18-research-quality-gate/18-03-SUMMARY.md

# Key source files

@server/trpc.ts
@server/routers/hypotheses.ts
@server/routers/assets.ts
@server/routers/wizard.ts
@components/features/prospects/analysis-section.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add prospectProcedure middleware + validateByProspect mutation</name>
  <files>server/trpc.ts, server/routers/hypotheses.ts</files>
  <action>
**server/trpc.ts** — Add `prospectProcedure` middleware after `adminProcedure`:

1. Import `TRPCError` (already imported).
2. Create `prospectProcedure = t.procedure.use(async ({ ctx, rawInput, next }) => { ... })` that:
   - Extracts `slug` from `rawInput` (cast as `Record<string, unknown>`).
   - Throws `BAD_REQUEST` if slug is not a string.
   - Queries `ctx.db.prospect.findUnique({ where: { slug: input.slug }, select: { id: true, status: true } })`. NOTE: Use `slug` (nanoid), NOT `readableSlug`. The DashboardClient receives `prospect.slug` (nanoid) as `prospectSlug` prop — this is confirmed in `page.tsx` line 105.
   - Throws `NOT_FOUND` if prospect is null or status is not in `['READY', 'SENT', 'VIEWED', 'ENGAGED', 'CONVERTED']`.
   - Calls `next({ ctx: { ...ctx, prospectId: prospect.id } })` to inject prospectId into downstream context.
3. Export `prospectProcedure`.

**server/routers/hypotheses.ts** — Add `validateByProspect` procedure to the router:

1. Import `prospectProcedure` from `../trpc` (add to existing import).
2. Add new procedure `validateByProspect` using `prospectProcedure`:
   ```
   validateByProspect: prospectProcedure
     .input(z.object({
       slug: z.string(),
       hypothesisId: z.string(),
       action: z.enum(['confirm', 'decline']),
     }))
     .mutation(async ({ ctx, input }) => {
       // ctx.prospectId injected by prospectProcedure
       const hypothesis = await ctx.db.workflowHypothesis.findFirst({
         where: { id: input.hypothesisId, prospectId: (ctx as any).prospectId },
         select: { id: true, status: true },
       });
       if (!hypothesis) {
         throw new TRPCError({ code: 'NOT_FOUND', message: 'Hypothesis not found for this prospect' });
       }
       // Only PENDING and ACCEPTED (legacy) can be validated; DECLINED is final
       if (hypothesis.status === 'DECLINED') {
         return hypothesis; // No-op for already declined
       }
       const newStatus = input.action === 'confirm' ? 'ACCEPTED' : 'DECLINED';
       return ctx.db.workflowHypothesis.update({
         where: { id: input.hypothesisId },
         data: { status: newStatus },
       });
     }),
   ```
3. Import `TRPCError` from `@trpc/server` at the top (add to existing imports if not present).
4. Note: `(ctx as any).prospectId` is needed because the base tRPC context type does not include `prospectId` — the middleware injects it at runtime. This is consistent with how `adminProcedure` enriches context.
   </action>
   <verify>Run `npx tsc --noEmit` — zero type errors. Grep for `validateByProspect` in hypotheses.ts and `prospectProcedure` in trpc.ts to confirm they exist.</verify>
   <done>A `prospectProcedure` middleware exists in trpc.ts that validates a nanoid slug maps to a publicly-visible prospect. A `validateByProspect` mutation exists in hypotheses.ts that confirms or declines a hypothesis owned by the slug's prospect. DECLINED hypotheses are no-ops on re-submit.</done>
   </task>

<task type="auto">
  <name>Task 2: Update ACCEPTED status references + admin STATUS_LABELS</name>
  <files>server/routers/assets.ts, server/routers/wizard.ts, server/routers/hypotheses.ts, components/features/prospects/analysis-section.tsx</files>
  <action>
**server/routers/assets.ts** — Update 5 locations where `status: 'ACCEPTED'` must become `{ in: ['ACCEPTED', 'PENDING'] }`:

1. Line 69: `where: { status: 'ACCEPTED' }` → `where: { status: { in: ['ACCEPTED', 'PENDING'] } }`
2. Line 74: same pattern change
3. Line 278: `where: { prospectId: map.prospect.id, status: 'ACCEPTED' }` → add `{ in: ['ACCEPTED', 'PENDING'] }` for status
4. Line 418: same pattern change
5. Line 426: same pattern change

These are all hypothesis gates for outreach generation. PENDING hypotheses are quality-approved and valid for outreach — they just haven't been prospect-validated yet, which is not a prerequisite for sending the initial email.

**server/routers/wizard.ts** — Line 211:

- Change `where: { status: 'ACCEPTED' }` → `where: { status: { in: ['ACCEPTED', 'PENDING'] } }`
  This ensures requestQuote includes hypotheses that are quality-approved but not yet prospect-validated.

**server/routers/hypotheses.ts** — `listAll` input validator:

- Change `z.enum(['DRAFT', 'ACCEPTED', 'REJECTED'])` → `z.enum(['DRAFT', 'ACCEPTED', 'REJECTED', 'PENDING', 'DECLINED'])`
  This prevents zod errors when admin tries to filter by new statuses.

**components/features/prospects/analysis-section.tsx** — Update `STATUS_LABELS`:

- Change `ACCEPTED: 'Pending validation'` → `ACCEPTED: 'Confirmed by prospect'`
- Change the comment on ACCEPTED from `// Legacy admin-accepted, same display as PENDING` to `// Confirmed by prospect on /voor/ dashboard`
- Update `STATUS_PILL` for `ACCEPTED`: change from `'bg-blue-50 text-blue-700 border-blue-200'` to `'bg-emerald-50 text-emerald-700 border-emerald-200'` — confirmed hypotheses should show green to distinguish from pending (blue).

This makes the admin Analysis section accurate now that Phase 19 is where validation actually happens: ACCEPTED = confirmed by prospect (green), PENDING = awaiting prospect validation (blue), DECLINED = declined by prospect (red).
</action>
<verify>Run `npx tsc --noEmit` — zero type errors. Grep `assets.ts` for `'ACCEPTED'` — should find only occurrences inside `in:` arrays, not standalone. Grep `STATUS_LABELS` in analysis-section.tsx to confirm 'Confirmed by prospect' exists.</verify>
<done>All `status: 'ACCEPTED'` gates in assets.ts, wizard.ts now accept PENDING alongside ACCEPTED. listAll accepts all 5 status values. Admin Analysis section shows "Confirmed by prospect" (green) for ACCEPTED, "Pending validation" (blue) for PENDING, "Declined by prospect" (red) for DECLINED — accurately reflecting the Phase 19 validation flow.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `grep -n "prospectProcedure" server/trpc.ts` shows export
3. `grep -n "validateByProspect" server/routers/hypotheses.ts` shows the procedure
4. `grep -n "ACCEPTED" server/routers/assets.ts` shows only `{ in: ['ACCEPTED', 'PENDING'] }` patterns
5. `grep -n "Confirmed by prospect" components/features/prospects/analysis-section.tsx` returns a match
6. `grep -n "PENDING.*DECLINED" server/routers/hypotheses.ts` shows updated listAll enum
</verification>

<success_criteria>

- prospectProcedure middleware validates nanoid slug → prospect lookup → injects prospectId into context
- validateByProspect mutation confirms or declines a hypothesis belonging to the slug's prospect
- All outreach gates accept PENDING hypotheses alongside ACCEPTED
- Admin STATUS_LABELS accurately reflect the new validation flow
- TypeScript compiles clean
  </success_criteria>

<output>
After completion, create `.planning/phases/19-client-hypothesis-validation/19-01-SUMMARY.md`
</output>
