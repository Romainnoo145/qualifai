---
phase: 28-source-discovery-with-provenance
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/enrichment/source-discovery.ts
  - lib/enrichment/source-discovery.test.ts
autonomous: true
requirements:
  - DISC-01
  - DISC-02
  - DISC-04
  - DISC-05

must_haves:
  truths:
    - 'buildSourceSet merges sitemap, serp, and default URL lists into a single DiscoveredUrl[] with provenance labels'
    - 'Per-source caps prevent any single source from exceeding its configured limit'
    - 'Duplicate URLs across sources are collapsed to a single entry (first-wins provenance)'
    - 'JS-heavy pages are flagged with jsHeavyHint=true based on URL pattern matching'
    - 'rawCounts report both discovered and capped counts per source for UI display'
  artifacts:
    - path: 'lib/enrichment/source-discovery.ts'
      provides: 'DiscoveredUrl type, SourceSet type, buildSourceSet(), normalizeUrlForDedup(), detectJsHeavy(), defaultResearchUrls()'
      exports:
        [
          'DiscoveredUrl',
          'SourceSet',
          'UrlProvenance',
          'buildSourceSet',
          'defaultResearchUrls',
          'CAPS',
        ]
    - path: 'lib/enrichment/source-discovery.test.ts'
      provides: 'Unit tests for buildSourceSet covering caps, dedup, provenance, jsHeavyHint, and rawCounts'
      min_lines: 80
  key_links:
    - from: 'lib/enrichment/source-discovery.ts'
      to: 'lib/enrichment/source-discovery.test.ts'
      via: "import { buildSourceSet } from './source-discovery'"
      pattern: 'buildSourceSet'
---

<objective>
Create the `source-discovery.ts` module with types and pure functions for URL discovery merging, deduplication, capping, JS-heavy detection, and provenance labelling. Test-drive `buildSourceSet()` using TDD since it is a pure function with clear I/O contracts.

Purpose: Establish the typed foundation that the research executor (Plan 02) and UI (Plan 03) depend on. All discovery logic is extracted into a single, testable module.

Output: `lib/enrichment/source-discovery.ts` (types + functions) and `lib/enrichment/source-discovery.test.ts` (unit tests).
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-source-discovery-with-provenance/28-RESEARCH.md

# Existing modules this extracts from:

@lib/research-executor.ts (lines 47-77 for defaultResearchUrls, lines 79-89 for cache extractors)
@lib/enrichment/sitemap.ts (discoverSitemapUrls — existing, not modified)
@lib/enrichment/serp.ts (discoverSerpUrls — existing, not modified)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create source-discovery.ts with types and pure functions</name>
  <files>lib/enrichment/source-discovery.ts</files>
  <action>
Create `lib/enrichment/source-discovery.ts` with the following exports:

**Types:**

- `UrlProvenance = 'sitemap' | 'serp' | 'default'`
- `DiscoveredUrl { url: string; provenance: UrlProvenance; jsHeavyHint: boolean }`
- `SourceSet { urls: DiscoveredUrl[]; discoveredAt: string; dedupRemovedCount: number; rawCounts: { sitemap: { discovered: number; capped: number }; serp: { discovered: number; capped: number }; default: { discovered: number; capped: number } }; serpDiscoveredAt?: string }`

**Constants:**

- `CAPS = { sitemap: 25, serp: 15, default: 20 } as const` — matches existing limits (sitemap.ts caps at 25, serp.ts at 5 review + 5 job + 5 google-search-mentions)

**Functions:**

1. `normalizeUrlForDedup(raw: string): string` — Strip scheme, www prefix, trailing slash using `new URL()`. Lowercase hostname + pathname. Fallback for malformed URLs: lowercase + trim + strip trailing slash. Same approach as `normalizedUrl()` in evidence-section.tsx but backend-side.

2. `detectJsHeavy(url: string): boolean` — Match against JS_HEAVY_PATTERNS array: trustpilot.com, indeed.com, glassdoor.\*, linkedin.com, google.com/maps, maps.app.goo, werkzoeken., jobbird., monsterboard., webflow.io, framer.website, framer.com. Also match hash-route patterns `/#/`. Per research (Claude's Discretion).

3. `buildSourceSet(input: { sitemapUrls: string[]; serpUrls: string[]; defaultUrls: string[]; serpDiscoveredAt?: string }): SourceSet` — Cap each source list to its CAPS limit FIRST (slice), then merge with provenance tags in order sitemap → serp → default (first-wins dedup via normalizeUrlForDedup), apply detectJsHeavy to each URL, track dedupRemovedCount, build rawCounts from pre-cap and post-cap lengths, set discoveredAt to current ISO timestamp.

4. `defaultResearchUrls(domain: string): string[]` — Move the existing function from `research-executor.ts` (lines 51-77) here verbatim. Export it so the executor can import from here. Keep the same 17 Dutch + English paths.

5. `extractSourceSet(snapshot: unknown): SourceSet | null` — Extract sourceSet from inputSnapshot JSON. Returns null if not present or malformed. Used by both the executor and the tRPC mutation.

**Important:** This is a pure module with zero side effects — no DB calls, no network calls, no imports from Prisma. Only stdlib `URL` class used.
</action>
<verify>
<automated>cd /home/klarifai/Documents/klarifai/projects/qualifai && npx tsx -e "import { buildSourceSet, defaultResearchUrls, CAPS, extractSourceSet } from './lib/enrichment/source-discovery'; const ss = buildSourceSet({ sitemapUrls: ['https://example.com/a'], serpUrls: ['https://example.com/b'], defaultUrls: defaultResearchUrls('example.com') }); console.assert(ss.urls.length > 0, 'urls not empty'); console.assert(ss.rawCounts.sitemap.capped === 1); console.assert(ss.rawCounts.default.discovered === 17); console.log('OK: module exports and buildSourceSet work')"</automated>
<manual>Verify module has no Prisma/DB imports</manual>
</verify>
<done>source-discovery.ts exports all types (DiscoveredUrl, SourceSet, UrlProvenance), constants (CAPS), and functions (buildSourceSet, defaultResearchUrls, normalizeUrlForDedup, detectJsHeavy, extractSourceSet). Module has zero side effects.</done>
</task>

<task type="auto">
  <name>Task 2: TDD tests for buildSourceSet — cap, dedup, provenance, jsHeavyHint</name>
  <files>lib/enrichment/source-discovery.test.ts</files>
  <action>
Create `lib/enrichment/source-discovery.test.ts` using Vitest (the project test runner — check package.json). Write tests covering:

**Cap enforcement (DISC-04):**

- Sitemap with 50 URLs → capped to 25 (CAPS.sitemap)
- SERP with 20 URLs → capped to 15 (CAPS.serp)
- Default with 25 URLs → capped to 20 (CAPS.default)
- Verify rawCounts.sitemap shows `{ discovered: 50, capped: 25 }`

**Dedup (DISC-05):**

- Same URL in sitemap and serp → only appears once with provenance 'sitemap' (first-wins)
- URLs differing only by trailing slash → deduped
- URLs differing only by scheme (http vs https) → deduped
- URLs differing only by www prefix → deduped
- Track dedupRemovedCount correctly

**Provenance (DISC-01):**

- Each URL in output has correct provenance ('sitemap', 'serp', or 'default')
- Merge order: sitemap first, then serp, then default

**jsHeavyHint (DISC-02):**

- linkedin.com URL → jsHeavyHint=true
- trustpilot.com URL → jsHeavyHint=true
- Regular company website → jsHeavyHint=false
- indeed.com URL → jsHeavyHint=true
- glassdoor URL → jsHeavyHint=true

**rawCounts:**

- Empty sources → rawCounts all zeros
- Mixed sources → accurate discovered/capped counts

**extractSourceSet:**

- Returns SourceSet from valid inputSnapshot
- Returns null from empty snapshot
- Returns null from snapshot without sourceSet field

Run with: `npx vitest run lib/enrichment/source-discovery.test.ts`
</action>
<verify>
<automated>cd /home/klarifai/Documents/klarifai/projects/qualifai && npx vitest run lib/enrichment/source-discovery.test.ts</automated>
</verify>
<done>All unit tests pass. Tests cover: cap enforcement per source type with correct rawCounts, URL deduplication across sources with first-wins provenance, jsHeavyHint detection for known JS-heavy domains, provenance labelling for all three source types, extractSourceSet from inputSnapshot.</done>
</task>

</tasks>

<verification>
- `npx vitest run lib/enrichment/source-discovery.test.ts` — all tests pass
- `npx tsx -e "import { buildSourceSet } from './lib/enrichment/source-discovery'"` — module loads without errors
- `npm run check` — no type errors in new files
</verification>

<success_criteria>

- source-discovery.ts exists with all exported types and functions
- source-discovery.test.ts has 10+ test cases covering caps, dedup, provenance, jsHeavyHint, and extractSourceSet
- All tests pass
- npm run check passes
  </success_criteria>

<output>
After completion, create `.planning/phases/28-source-discovery-with-provenance/28-01-SUMMARY.md`
</output>
