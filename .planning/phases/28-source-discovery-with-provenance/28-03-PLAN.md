---
phase: 28-source-discovery-with-provenance
plan: 03
type: execute
wave: 3
depends_on:
  - 28-01
  - 28-02
files_modified:
  - components/features/prospects/source-set-section.tsx
  - app/admin/prospects/[id]/page.tsx
autonomous: false
requirements:
  - DISC-01
  - DISC-04
  - DISC-05

must_haves:
  truths:
    - 'Admin sees a collapsible source URL section in the Evidence tab of the prospect detail view'
    - 'Collapsed summary shows total URL count, per-provenance breakdown, dedup count, and relative discovery time'
    - 'Expanded view shows URLs grouped under provenance headers (Sitemap, SERP, Default)'
    - "When a source type was capped, summary shows 'X of Y' format (e.g., 'Sitemap (20 of 147)')"
    - 'Re-discover sources button triggers re-discovery without affecting existing evidence'
  artifacts:
    - path: 'components/features/prospects/source-set-section.tsx'
      provides: 'SourceSetSection collapsible component with summary line, grouped URLs, and re-discover button'
      min_lines: 60
    - path: 'app/admin/prospects/[id]/page.tsx'
      provides: 'SourceSetSection rendered above EvidenceSection in the Evidence tab'
      contains: 'SourceSetSection'
  key_links:
    - from: 'components/features/prospects/source-set-section.tsx'
      to: 'server/routers/research.ts'
      via: 'api.research.rediscoverSources.useMutation'
      pattern: 'rediscoverSources'
    - from: 'app/admin/prospects/[id]/page.tsx'
      to: 'components/features/prospects/source-set-section.tsx'
      via: 'import { SourceSetSection }'
      pattern: 'SourceSetSection'
---

<objective>
Build the SourceSetSection UI component and wire it into the prospect detail page. Admin can see discovered source URLs with provenance labels, cap/dedup feedback, and trigger re-discovery — all within the existing Evidence tab.

Purpose: Give admin visibility into what the pipeline discovered, where each URL came from, and the ability to refresh sources independently.

Output: `source-set-section.tsx` (new component) and modified `page.tsx` (wiring).
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-source-discovery-with-provenance/28-CONTEXT.md
@.planning/phases/28-source-discovery-with-provenance/28-RESEARCH.md
@.planning/phases/28-source-discovery-with-provenance/28-01-SUMMARY.md
@.planning/phases/28-source-discovery-with-provenance/28-02-SUMMARY.md

# Existing UI patterns to match:

@components/features/prospects/evidence-section.tsx (lines 534-548 for details pattern, CSS classes)
@app/admin/prospects/[id]/page.tsx (tab structure, how latestRun is threaded)

# Types from Plan 01:

@lib/enrichment/source-discovery.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SourceSetSection collapsible component</name>
  <files>components/features/prospects/source-set-section.tsx</files>
  <action>
Create `components/features/prospects/source-set-section.tsx` as a 'use client' component:

**Props:**

```typescript
{
  runId: string;
  inputSnapshot: unknown;
}
```

**Source set extraction:**

- Import `extractSourceSet` from `@/lib/enrichment/source-discovery` (or import SourceSet type and extract inline from the JSON snapshot)
- If no sourceSet in snapshot, render null (no section shown until research has run)

**Collapsed state (per CONTEXT.md — collapsed by default):**

- Use native `<details>` WITHOUT the `open` attribute (collapsed by default per Pitfall 5 from research — avoid controlled state fighting)
- Match the exact CSS pattern from evidence-section.tsx: `className="glass-card rounded-[2rem] border border-slate-100 overflow-hidden"`
- Summary line hidden marker: `[&::-webkit-details-marker]:hidden` (matches evidence-section.tsx)

**Summary line format (per CONTEXT.md decisions):**

- Pattern: "{N} source URLs ({X sitemap, Y serp, Z default}) · {D} duplicates removed · Discovered {relative_time}"
- When capped: show "X of Y" format per provenance (e.g., "20 of 147 sitemap") — read from `rawCounts.{type}.discovered > rawCounts.{type}.capped`
- Only show provenance types that have URLs (skip empty ones from the breakdown)
- Only show "duplicates removed" part if dedupRemovedCount > 0
- Icon: use `Link` from lucide-react (as LinkIcon alias to avoid conflict with Next.js Link)
- ChevronDown on the right side

**Expanded content:**

- Group URLs by provenance under headers: "Sitemap ({count})", "SERP ({count})", "Default ({count})"
- Each header uses the same uppercase tracking style as evidence-section group labels
- Each URL rendered as a text link (anchor tag with href, target="\_blank", rel="noopener noreferrer")
- Each URL shows provenance label + URL only — NO metadata, timestamps, or jsHeavyHint per URL (locked decision)
- URL text truncated visually (CSS truncate) to prevent layout blow-up on long URLs

**Re-discover button:**

- Button text: "Re-discover sources"
- Icon: RefreshCw from lucide-react
- Uses `api.research.rediscoverSources.useMutation({ onSuccess: () => utils.research.listRuns.invalidate() })`
- Passes `{ runId, force: false }` by default (respects 24h cache)
- Shows loading spinner on RefreshCw icon while pending (animate-spin class)
- Disabled while isPending
- Styled as a lightweight secondary action — small text, subtle border, not a primary CTA
- Per CONTEXT.md: "should feel lightweight — not a big action, just a refresh"

**Relative time helper (inline, per research — no date-fns dependency):**

```typescript
function relativeTime(isoString: string): string {
  const ms = Date.now() - new Date(isoString).getTime();
  const minutes = Math.floor(ms / 60_000);
  if (minutes < 60) return `${minutes}m ago`;
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `${hours}h ago`;
  return new Date(isoString).toLocaleDateString('nl-NL');
}
```

**Styling:**

- Match existing glass-card, border-slate-100, uppercase tracking patterns exactly
- Compact padding (p-5/p-6 not p-10 — per user preference)
- URL list items: text-xs or text-sm, monospace-ish for URLs, truncated
  </action>
  <verify>
  <automated>cd /home/klarifai/Documents/klarifai/projects/qualifai && npm run check 2>&1 | tail -20</automated>
  <manual>Visually inspect the component renders correctly on a prospect with research data — collapsed summary shows counts, expanded shows grouped URLs, re-discover button works</manual>
  </verify>
  <done>SourceSetSection component renders a collapsible details section (collapsed by default) with summary line showing URL count + provenance breakdown + dedup count + relative time, expanded view with URLs grouped by provenance, and a re-discover sources button that calls the tRPC mutation.</done>
  </task>

<task type="auto">
  <name>Task 2: Wire SourceSetSection into prospect detail Evidence tab</name>
  <files>app/admin/prospects/[id]/page.tsx</files>
  <action>
Modify `app/admin/prospects/[id]/page.tsx` to include the SourceSetSection:

1. Add import:

   ```typescript
   import { SourceSetSection } from '@/components/features/prospects/source-set-section';
   ```

2. In the Evidence tab section (around line 328-335), add SourceSetSection ABOVE the EvidenceSection. Place it in the same `<div>` that wraps the evidence tab content, before `<EvidenceSection>`:

   ```tsx
   <div className={cn('pt-1', activeTab === 'evidence' ? '' : 'hidden')}>
     {latestRunId && (
       <SourceSetSection
         runId={latestRunId}
         inputSnapshot={latestRun?.inputSnapshot ?? null}
       />
     )}
     <EvidenceSection
       prospectId={id}
       signals={p.signals}
       latestRunSummary={latestRun?.summary}
       latestRunError={latestRun?.error ?? null}
     />
   </div>
   ```

3. Add a small vertical gap: wrap both in a `space-y-4` or `space-y-6` container, or add `mb-4` to SourceSetSection's outer element.

4. Ensure `latestRun?.inputSnapshot` is available. Check the `research.listRuns` query — it returns ResearchRun records which include `inputSnapshot` as a Json field. The existing `latestRun` variable (line 113) already casts the first run result. If `inputSnapshot` is not in the selected fields of the listRuns query, add it to the select in `server/routers/research.ts` listRuns procedure.

**Important:** Only render SourceSetSection if `latestRunId` is truthy (a research run exists). If no research has been run, the section should not appear.
</action>
<verify>
<automated>cd /home/klarifai/Documents/klarifai/projects/qualifai && npm run check 2>&1 | tail -20</automated>
<manual>Navigate to /admin/prospects/{id} for a prospect with research data. Verify: (1) SourceSetSection appears above evidence groups in the Evidence tab, (2) collapsed by default showing summary line, (3) expands to show grouped URLs, (4) Re-discover button triggers mutation</manual>
</verify>
<done>SourceSetSection is rendered above EvidenceSection in the Evidence tab, receives runId and inputSnapshot from the latest research run, and is conditionally rendered only when a research run exists.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of source set section</name>
  <files>components/features/prospects/source-set-section.tsx, app/admin/prospects/[id]/page.tsx</files>
  <action>
Human verification checkpoint. No automated action — verify the UI built in Tasks 1-2.

What was built: Collapsible source URL section in the prospect detail Evidence tab showing provenance-tagged URLs with dedup/cap feedback and re-discover button.

How to verify:

1. Start the dev server: check port 9200 is running
2. Navigate to http://localhost:9200/admin/prospects/{any-prospect-with-research}
3. Verify the Evidence tab shows a COLLAPSED "source URLs" section above the evidence groups
4. Verify the collapsed summary shows: URL count, per-provenance breakdown, dedup count if any, relative discovery time
5. Click to expand — verify URLs are grouped under Sitemap, SERP, Default headers
6. Verify each URL is a clickable link that opens in a new tab
7. Verify the "Re-discover sources" button is visible inside the expanded section
8. Click "Re-discover sources" — verify it shows loading state and completes without errors
9. After re-discovery, verify the summary line updates (discovery timestamp should refresh)
10. Verify no evidence items were deleted by re-discovery (evidence groups should remain unchanged)
    </action>
    <verify>
    <automated>cd /home/klarifai/Documents/klarifai/projects/qualifai && npm run check 2>&1 | tail -5</automated>
    <manual>Visual inspection per the 10 steps in the action section above</manual>
    </verify>
    <done>Admin approves the source set section visual design and functionality. Type "approved" or describe issues to fix.</done>
    </task>

</tasks>

<verification>
- `npm run check` — no type errors
- Visual: SourceSetSection visible in Evidence tab, collapsed by default
- Visual: Summary line matches CONTEXT.md format
- Visual: Expanded view groups URLs by provenance
- Functional: Re-discover button calls mutation without clearing evidence
</verification>

<success_criteria>

- SourceSetSection component renders correctly in the prospect detail Evidence tab
- Summary line shows URL count, provenance breakdown, dedup count, and relative time
- Expanded view groups URLs by provenance type
- Re-discover button triggers rediscoverSources mutation
- npm run check passes
- Admin approves the visual design
  </success_criteria>

<output>
After completion, create `.planning/phases/28-source-discovery-with-provenance/28-03-SUMMARY.md`
</output>
