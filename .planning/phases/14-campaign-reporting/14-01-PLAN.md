---
phase: 14-campaign-reporting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/routers/campaigns.ts
  - app/admin/campaigns/page.tsx
autonomous: true

must_haves:
  truths:
    - 'Admin can create a campaign with a name and segment description'
    - 'Admin can add prospects to a campaign from the campaigns list page'
    - 'Campaign list shows each campaign with prospect count and a link to campaign detail'
  artifacts:
    - path: 'server/routers/campaigns.ts'
      provides: 'getWithFunnelData query returning campaign + prospects with funnel stage per prospect + aggregate funnel counts + conversion metrics'
      contains: 'getWithFunnelData'
    - path: 'app/admin/campaigns/page.tsx'
      provides: 'Campaign creation form with name + segment description, prospect assignment, campaign list cards linking to detail'
  key_links:
    - from: 'app/admin/campaigns/page.tsx'
      to: 'server/routers/campaigns.ts'
      via: 'tRPC api.campaigns.create, api.campaigns.list, api.campaigns.attachProspect'
      pattern: "api\\.campaigns\\."
    - from: 'app/admin/campaigns/page.tsx'
      to: 'app/admin/campaigns/[id]/page.tsx'
      via: 'Next.js Link to /admin/campaigns/{id}'
      pattern: 'href=.*campaigns/'
---

<objective>
Extend campaign tRPC router with a `getWithFunnelData` query that computes funnel stage per prospect and aggregate funnel counts, then redesign the campaigns list page with cleaner creation UI and clickable campaign cards linking to the detail page.

Purpose: Build the data layer and entry point for campaign reporting -- the detail page (Plan 02) consumes the query this plan creates.
Output: Updated campaigns router with funnel computation, redesigned campaigns list page.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@server/routers/campaigns.ts
@app/admin/campaigns/page.tsx
@prisma/schema.prisma (for model relations and enums: ProspectStatus, HypothesisStatus, SequenceStatus, OutreachStatus)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getWithFunnelData tRPC query to campaigns router</name>
  <files>server/routers/campaigns.ts</files>
  <action>
Add a new query `getWithFunnelData` to the campaignsRouter. Input: `{ id: string }`. This query:

1. Fetch the campaign with `findUniqueOrThrow({ where: { id } })`.
2. Fetch all CampaignProspect records for this campaign, including the prospect with these related counts/data:
   - `prospect.companyName`, `prospect.domain`, `prospect.status`, `prospect.logoUrl`, `prospect.industry`
   - Count of ResearchRun where `status = 'COMPLETED'` for this prospect (researched if > 0)
   - Count of WorkflowHypothesis where `status = 'ACCEPTED'` for this prospect (approved if > 0)
   - Include `outreachSequences` with `select: { status: true }` for this prospect
   - Include `contacts` with `select: { outreachStatus: true }` for this prospect
   - Include `sessions` (WizardSession) with `select: { callBooked: true }` for this prospect

3. For each prospect, compute `funnelStage` as a string using this waterfall logic (highest stage wins):
   - `'booked'` — if any session has `callBooked = true`, OR any outreachSequence has status `BOOKED`, OR prospect.status is `CONVERTED`
   - `'replied'` — if any outreachSequence has status `REPLIED`, OR any contact has outreachStatus `REPLIED`
   - `'emailed'` — if any outreachSequence has status `SENT` or `OPENED` or `REPLIED` or `BOOKED`, OR any contact has outreachStatus `EMAIL_SENT` or `OPENED` or `REPLIED` or `CONVERTED`
   - `'approved'` — if approvedHypothesisCount > 0
   - `'researched'` — if completedResearchCount > 0
   - `'imported'` — default (prospect exists in campaign)

4. Compute aggregate `funnel` object: `{ imported: number, researched: number, approved: number, emailed: number, replied: number, booked: number }` — each count includes prospects AT that stage AND all higher stages (cumulative). Example: if 10 prospects, 7 researched, 5 approved, 3 emailed, 1 replied, 0 booked, then `imported=10, researched=7, approved=5, emailed=3, replied=1, booked=0`.

5. Compute `metrics` object: `{ responseRate: number, bookingRate: number }` — both as percentages (0-100).
   - `responseRate` = (replied + booked) / emailed \* 100, or 0 if emailed=0
   - `bookingRate` = booked / emailed \* 100, or 0 if emailed=0

6. Return: `{ campaign, prospects: ProspectWithStage[], funnel, metrics }`

Where `ProspectWithStage` has: `id, companyName, domain, status, logoUrl, industry, funnelStage`.

IMPORTANT: Do NOT use deeply nested Prisma includes that would cause TS2589. Keep the query practical — use separate targeted queries if needed (e.g., one for research run counts, one for hypothesis counts) and merge results in JS. Or use `_count` on specific relations where possible.

Do NOT change or remove any existing procedures (create, list, get, update, attachProspect, detachProspect, runAutopilot).
</action>
<verify>Run `npx tsc --noEmit` — no type errors in campaigns.ts. Grep for `getWithFunnelData` in the file to confirm it exists.</verify>
<done>getWithFunnelData query exists, accepts campaign id, returns campaign + prospect array with funnelStage per prospect + aggregate funnel counts + responseRate/bookingRate metrics.</done>
</task>

<task type="auto">
  <name>Task 2: Redesign campaigns list page with creation form and clickable campaign cards</name>
  <files>app/admin/campaigns/page.tsx</files>
  <action>
Rewrite the campaigns page. Keep the same file path. The page should have:

**1. Header section:**

- Title "Campaigns" (h1, same styling as prospects page: `text-4xl font-black text-[#040026] tracking-tighter`)
- "Create Campaign" button on the right that opens/closes a creation form panel

**2. Create Campaign panel (collapsible, initially hidden):**

- Input: Campaign name (required, min 2 chars)
- Input: Segment description (maps to `nicheKey` field — change the placeholder to something meaningful like "e.g. Bouw &amp; Installatie NL" instead of "construction_nl_sme"). Keep it as a text input, not a dropdown with hardcoded options.
- "Create" button calling `api.campaigns.create.useMutation`
- On success: collapse panel, invalidate list, clear fields

**3. Campaign list (main content):**

- Each campaign as a `glass-card glass-card-hover` card (matching prospects page pattern)
- Left side: FolderKanban icon + campaign name (bold) + segment description (small, muted)
- Right side: prospect count badge + right arrow chevron
- Entire card is a `Link` to `/admin/campaigns/${campaign.id}` (this route will be created in Plan 02)

**4. Remove from current page:**

- Remove the "Add Companies to Campaign" section (prospect assignment will move to campaign detail page in Plan 02)
- Remove the "Campaign Processing" / autopilot section (this is backend processing, not campaign reporting)
- Remove the autopilot result JSON display

**Styling:** Follow the established glass-card pattern from prospects page. Use Lucide icons (FolderKanban, Plus, ChevronRight, X). Use existing CSS variable colors (never hardcode brand colors except the established `#040026` and `#EBCB4B` patterns seen throughout the codebase).

Keep `'use client'` and `import { api } from '@/components/providers'`.
</action>
<verify>Run `npm run check` to verify types, lint, and formatting pass. Open the page in browser at http://localhost:9200/admin/campaigns and verify it renders.</verify>
<done>Campaigns page shows a clean list of campaigns with clickable cards linking to /admin/campaigns/[id], a collapsible creation form, and no autopilot/assignment UI.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run check` passes (type-check + lint + format)
3. Campaign list page renders at /admin/campaigns
4. getWithFunnelData query exists in campaigns router and type-checks correctly
</verification>

<success_criteria>

- campaigns.ts has getWithFunnelData query computing funnel stage per prospect and aggregate metrics
- campaigns page shows clean list with clickable cards and collapsible creation form
- No type errors, lint errors, or formatting issues
  </success_criteria>

<output>
After completion, create `.planning/phases/14-campaign-reporting/14-01-SUMMARY.md`
</output>
