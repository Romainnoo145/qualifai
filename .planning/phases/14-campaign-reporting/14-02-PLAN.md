---
phase: 14-campaign-reporting
plan: 02
type: execute
wave: 2
depends_on: ['14-01']
files_modified:
  - app/admin/campaigns/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - 'Admin can open a campaign and see a funnel visualization with counts at each stage'
    - 'Admin can see every prospect in the campaign with their current funnel stage visible at a glance'
    - 'Admin can see response rate and booking rate for the campaign'
    - 'Admin can add prospects to the campaign from the campaign detail page'
  artifacts:
    - path: 'app/admin/campaigns/[id]/page.tsx'
      provides: 'Campaign detail page with funnel bar, prospect status table, conversion metrics, and prospect assignment'
  key_links:
    - from: 'app/admin/campaigns/[id]/page.tsx'
      to: 'server/routers/campaigns.ts'
      via: 'tRPC api.campaigns.getWithFunnelData, api.campaigns.attachProspect, api.campaigns.detachProspect'
      pattern: "api\\.campaigns\\.(getWithFunnelData|attachProspect|detachProspect)"
    - from: 'app/admin/campaigns/[id]/page.tsx'
      to: 'app/admin/prospects/[id]/page.tsx'
      via: 'Next.js Link to prospect detail'
      pattern: 'href=.*prospects/'
---

<objective>
Create the campaign detail page at `/admin/campaigns/[id]` showing funnel visualization, per-prospect status table with funnel stage badges, and conversion metrics — all powered by the `getWithFunnelData` query from Plan 01.

Purpose: Give the admin a single-page overview of campaign health with both aggregate funnel data and per-prospect drill-down.
Output: Fully functional campaign detail page with funnel, prospect list, and metrics.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-campaign-reporting/14-01-SUMMARY.md
@server/routers/campaigns.ts (for getWithFunnelData return shape)
@app/admin/prospects/page.tsx (for styling patterns: glass-card, statusColors, layout)
@app/admin/campaigns/page.tsx (for campaign creation UI patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create campaign detail page with funnel visualization and prospect table</name>
  <files>app/admin/campaigns/[id]/page.tsx</files>
  <action>
Create a new `'use client'` page at `app/admin/campaigns/[id]/page.tsx`. This page uses `useParams()` to get the campaign id and calls `api.campaigns.getWithFunnelData.useQuery({ id })`.

The page has these sections (all in a single page, no tabs):

**1. Header:**

- Back link to `/admin/campaigns` (ArrowLeft icon + "Campaigns")
- Campaign name as h1 (`text-4xl font-black text-[#040026] tracking-tighter`)
- Segment description shown below in muted text (`text-sm font-bold text-slate-400`)

**2. Conversion Metrics bar (horizontal strip):**

- Two metric cards in a compact row (glass-card, inline):
  - "Response Rate" — show `metrics.responseRate` formatted as `XX.X%` (one decimal)
  - "Booking Rate" — show `metrics.bookingRate` formatted as `XX.X%` (one decimal)
- Each card: small label (uppercase, tracking-widest, slate-400) + large number (text-3xl font-black)
- Color code the numbers: response rate in blue (`text-blue-600`), booking rate in emerald (`text-emerald-600`)

**3. Funnel Visualization:**

- A horizontal funnel bar showing 6 stages left-to-right: Imported, Researched, Approved, Emailed, Replied, Booked
- Each stage is a segment with:
  - Stage name (small label above)
  - Count (large bold number)
  - A colored horizontal bar whose width is proportional to count/max (max = imported count)
  - Min-width of 2rem so zero-count stages are still visible
- Stage colors (left to right, getting warmer): slate-300, blue-400, indigo-400, amber-400, orange-400, emerald-500
- Use `glass-card p-6 rounded-[2.5rem]` container

**4. Prospect Table:**

- Header: "Companies in Campaign" + count badge + "Add Company" button on right
- "Add Company" button opens a dropdown/panel with a select of all prospects (from `api.admin.listProspects.useQuery()`) and a "Link" button calling `api.campaigns.attachProspect.useMutation`
- Each prospect row is a `glass-card glass-card-hover` card showing:
  - Left: logo (or Building2 icon fallback) + company name (link to `/admin/prospects/${id}`) + industry text
  - Center: funnel stage badge — a colored pill matching the funnel stage colors above, showing the stage name
  - Right: detach button (X icon, calls `api.campaigns.detachProspect.useMutation`, with confirm dialog)
- Sort prospects by funnel stage (booked first, imported last) — define stage order: `['booked', 'replied', 'emailed', 'approved', 'researched', 'imported']` and sort descending

**Funnel stage badge colors** (match funnel bar):

```
imported:   bg-slate-100 text-slate-600
researched: bg-blue-50 text-blue-600
approved:   bg-indigo-50 text-indigo-600
emailed:    bg-amber-50 text-amber-600
replied:    bg-orange-50 text-orange-600
booked:     bg-emerald-50 text-emerald-600
```

**Funnel stage labels** (user-facing, Dutch-friendly but keep English since admin UI is English):

```
imported:   Imported
researched: Researched
approved:   Approved
emailed:    Emailed
replied:    Replied
booked:     Booked
```

**Loading state:** Show skeleton loaders (pulse animation) for funnel and table while query loads.

**Error state:** If campaign not found, show a centered error message with link back to campaigns list.

**Styling patterns to follow:**

- Glass-card pattern from prospects page
- Font sizing: h1 text-4xl, labels text-[10px] uppercase tracking-widest, body text-sm
- Button patterns: btn-pill-primary for primary actions, btn-pill-secondary for secondary
- Icon sizing: w-4 h-4 for inline, w-6 h-6 for card icons
- Spacing: space-y-8 between major sections

Keep file under 300 lines. If approaching limit, extract FunnelBar and ProspectRow as inline helper components within the same file (not separate files).

Import icons from lucide-react: ArrowLeft, Building2, ChevronRight, FolderKanban, Plus, X, Users, TrendingUp, Loader2.
</action>
<verify>
Run `npm run check` to verify types, lint, and formatting pass.
Open http://localhost:9200/admin/campaigns — click a campaign card — verify the detail page renders with funnel, metrics, and prospect list.
</verify>
<done>Campaign detail page at /admin/campaigns/[id] shows funnel visualization with stage counts, per-prospect status badges sorted by stage, response rate and booking rate metrics, prospect assignment and detachment controls.</done>
</task>

</tasks>

<verification>
1. `npm run check` passes (type-check + lint + format)
2. Navigating from campaigns list to campaign detail page works
3. Funnel bar shows 6 stages with accurate counts
4. Each prospect has a colored funnel stage badge
5. Metrics section shows response rate and booking rate
6. Admin can add and remove prospects from the campaign detail page
7. Back navigation to campaigns list works
</verification>

<success_criteria>

- Campaign detail page renders funnel, prospect table, and metrics from getWithFunnelData query
- All four CAMP requirements (CAMP-01 through CAMP-04) are satisfied
- No type errors, lint errors, or formatting issues
  </success_criteria>

<output>
After completion, create `.planning/phases/14-campaign-reporting/14-02-SUMMARY.md`
</output>
