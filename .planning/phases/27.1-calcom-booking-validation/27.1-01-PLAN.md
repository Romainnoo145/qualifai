---
phase: 27.1-calcom-booking-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/e2e-calcom-booking-test.mjs
autonomous: false
requirements:
  - E2E-03

must_haves:
  truths:
    - 'A simulated BOOKING_CREATED event is POSTed to /api/webhooks/calcom with valid HMAC-SHA256 signature and receives HTTP 200'
    - "The webhook handler creates a CallPrepPlan record linked to the prospect's research run"
    - 'OutreachSequence status is updated to BOOKED'
    - 'OutreachStep statuses are updated to BOOKED'
    - 'Contact outreachStatus is updated to CONVERTED'
    - 'Prospect status is updated to ENGAGED'
    - 'OutreachLog record is created with channel=calcom and status=booked'
  artifacts:
    - path: 'scripts/e2e-calcom-booking-test.mjs'
      provides: 'E2E Cal.com booking webhook test script'
      min_lines: 150
  key_links:
    - from: 'scripts/e2e-calcom-booking-test.mjs'
      to: '/api/webhooks/calcom'
      via: 'HTTP POST with HMAC signature'
      pattern: 'fetch.*webhooks/calcom'
    - from: '/api/webhooks/calcom'
      to: 'prisma.callPrepPlan'
      via: 'createCallPrepFromSequence in transaction'
      pattern: "callPrepPlan\\.create"
---

<objective>
Create an E2E test script that simulates a Cal.com BOOKING_CREATED webhook event, verifies the full booking-to-call-prep pipeline, and confirms all database state changes (sequence, step, contact, prospect, outreach log, call prep plan).

Purpose: Closes the unsatisfied E2E-03 requirement from v2.1 audit. The Cal.com webhook handler and call prep generation code already exist (built in Phase 09) but have never been exercised end-to-end.

Output: `scripts/e2e-calcom-booking-test.mjs` — standalone E2E test script following the established pattern from Phase 27 scripts.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-end-to-end-cycle/27-01-SUMMARY.md
@.planning/phases/27-end-to-end-cycle/27-02-SUMMARY.md

# Key source files

@app/api/webhooks/calcom/route.ts
@scripts/e2e-send-test.mjs
@scripts/e2e-reply-test.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create E2E Cal.com booking test script with HMAC signature and full DB verification</name>
  <files>scripts/e2e-calcom-booking-test.mjs</files>
  <action>
Create `scripts/e2e-calcom-booking-test.mjs` following the exact same patterns as `scripts/e2e-send-test.mjs` and `scripts/e2e-reply-test.mjs`:

**Setup (same as existing E2E scripts):**

- `import 'dotenv/config'` at top
- `createRequire` for CJS dependencies (`@prisma/adapter-pg`, `@prisma/client`, `pg`)
- Pool + PrismaClient with PrismaPg adapter
- Read `CALCOM_WEBHOOK_SECRET` from `process.env.CALCOM_WEBHOOK_SECRET` — if not set, use a default test secret `'e2e-calcom-test-secret'` and print a warning that the script will set it temporarily in the environment for the dev server to pick up. Actually: the dev server reads env at boot, so the script must instruct the user to add `CALCOM_WEBHOOK_SECRET=e2e-calcom-test-secret` to `.env` and restart if not present. Guard with a clear error message and exit if the secret is missing.
- APP_URL from `process.env.NEXT_PUBLIC_APP_URL ?? 'http://localhost:9200'`
- Server health check (same `fetch HEAD` pattern)

**Test data setup (in DB, before webhook POST):**

1. Find a prospect with a COMPLETED research run that has at least 1 WorkflowHypothesis and 1 AutomationOpportunity. Use the same test prospects as Phase 27 (`mujjo.com` or `deondernemer.nl`). If neither has the required data, search for any prospect matching criteria.
2. Find or create a Contact for that prospect (reuse test contacts from e2e-send-test.mjs if they exist — look for `primaryEmail = 'info@klarifai.nl'`).
3. Find or create an OutreachSequence for that contact+prospect with `status: 'SENT'` and link it to the research run. Also create at least 1 OutreachStep with `status: 'SENT'`, `stepOrder: 1`, `bodyText: 'E2E test step'`.
4. Store the sequenceId, contactId, prospectId, researchRunId for verification later.

**HMAC signature computation:**

- Use `node:crypto` `createHmac('sha256', CALCOM_WEBHOOK_SECRET)` with `.update(rawBody).digest('hex')`
- The webhook handler reads signature from `x-cal-signature-256` header
- The handler strips `sha256=` prefix if present, so either format works — use the raw hex digest

**Webhook payload construction:**
Build a realistic BOOKING_CREATED payload matching the `webhookSchema` in the handler:

```javascript
{
  triggerEvent: 'BOOKING_CREATED',
  payload: {
    bookingUid: `e2e-test-${Date.now()}`,
    startTime: new Date(Date.now() + 86400000).toISOString(), // tomorrow
    endTime: new Date(Date.now() + 86400000 + 1800000).toISOString(), // +30min
    eventTypeId: 999,
    attendees: [{ email: contact.primaryEmail, name: `${contact.firstName} ${contact.lastName}` }],
    metadata: {
      outreachSequenceId: sequence.id,
      contactId: contact.id,
    },
    responses: {},
  },
}
```

**POST to webhook:**

```javascript
const rawBody = JSON.stringify(payload);
const signature = createHmac('sha256', CALCOM_WEBHOOK_SECRET)
  .update(rawBody)
  .digest('hex');
const resp = await fetch(`${APP_URL}/api/webhooks/calcom`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'x-cal-signature-256': signature,
  },
  body: rawBody,
});
```

Log HTTP status and response JSON. Fail with clear error if not 200.

**DB state verification (after POST):**
Query the database to verify ALL of the following. Print each as PASS/FAIL:

1. **OutreachSequence** — `status` changed to `'BOOKED'`, metadata contains `calcom.bookingUid`
2. **OutreachStep** — all steps for this sequence have `status: 'BOOKED'`
3. **Contact** — `outreachStatus` changed to `'CONVERTED'`, `lastContactedAt` is recent
4. **Prospect** — `status` changed to `'ENGAGED'`
5. **OutreachLog** — new record with `channel: 'calcom'`, `status: 'booked'`, `contactId` matches, metadata contains `bookingUid` and `eventType: 'BOOKING_CREATED'`
6. **CallPrepPlan** — new record with `prospectId`, `researchRunId` matching, `summary` is non-empty, `plan30`/`plan60`/`plan90` are non-null JSON

**Summary table and exit:**
Print a summary table (same format as e2e-reply-test.mjs) with all 6 checks and overall PASS/FAIL. Exit with code 1 if any check fails.

**Cleanup:** Disconnect prisma, end pool.

**Important:** Do NOT use `env.mjs` (requires Next.js module resolution). Read env vars directly from `process.env` — this is the established pattern for CLI scripts per project conventions.
</action>
<verify>
<automated>cd /home/klarifai/Documents/klarifai/projects/qualifai && npx eslint scripts/e2e-calcom-booking-test.mjs --no-error-on-unmatched-pattern 2>&1 | head -20</automated>
<manual>Script file exists and follows same structure as e2e-send-test.mjs / e2e-reply-test.mjs</manual>
</verify>
<done>
`scripts/e2e-calcom-booking-test.mjs` exists, passes lint, computes HMAC signature correctly, constructs valid BOOKING_CREATED payload, POSTs to /api/webhooks/calcom, and verifies all 6 DB state changes (sequence BOOKED, steps BOOKED, contact CONVERTED, prospect ENGAGED, outreach log created, call prep plan created).
</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Run E2E Cal.com booking test and verify results</name>
  <files>scripts/e2e-calcom-booking-test.mjs</files>
  <action>
    Run the E2E Cal.com booking test script and verify all 6 database state checks pass.

    Prerequisites:
    1. Dev server running on port 9200 (`npm run dev`)
    2. `CALCOM_WEBHOOK_SECRET` set in `.env` (e.g. `CALCOM_WEBHOOK_SECRET="e2e-calcom-test-secret"`) — restart dev server after adding
    3. At least one prospect with a completed research run exists (from Phase 25+)

    Run: `node scripts/e2e-calcom-booking-test.mjs`

    Expected: Webhook POST returns HTTP 200 with `success: true` and `callPrepId`. All 6 DB checks PASS:
    1. OutreachSequence status = BOOKED
    2. OutreachStep status = BOOKED
    3. Contact outreachStatus = CONVERTED
    4. Prospect status = ENGAGED
    5. OutreachLog with channel=calcom, status=booked
    6. CallPrepPlan created with summary, plan30, plan60, plan90

  </action>
  <verify>
    <automated>cd /home/klarifai/Documents/klarifai/projects/qualifai && node scripts/e2e-calcom-booking-test.mjs 2>&1 | tail -20</automated>
    <manual>Confirm "ALL TESTS PASSED" in output and callPrepId is non-null</manual>
  </verify>
  <done>Script runs successfully, webhook returns HTTP 200, all 6 DB state checks PASS, CallPrepPlan record exists with non-empty summary and 30/60/90 plans.</done>
</task>

</tasks>

<verification>
1. `scripts/e2e-calcom-booking-test.mjs` exists and passes lint
2. Script successfully POSTs a BOOKING_CREATED event with valid HMAC to `/api/webhooks/calcom`
3. Webhook returns HTTP 200 with `success: true` and `callPrepId` in response
4. All 6 database state changes verified (sequence, steps, contact, prospect, outreach log, call prep plan)
5. Script follows established E2E test patterns (dotenv, PrismaPg adapter, health check, summary table)
</verification>

<success_criteria>

- E2E-03 requirement satisfied: Cal.com booking triggers automatic meeting brief generation
- A simulated BOOKING_CREATED webhook event produces a CallPrepPlan record with non-empty summary and 30/60/90 plans
- All pipeline side effects verified: sequence BOOKED, contact CONVERTED, prospect ENGAGED, outreach log created
- Script is reusable for future regression testing
  </success_criteria>

<output>
After completion, create `.planning/phases/27.1-calcom-booking-validation/27.1-01-SUMMARY.md`
</output>
