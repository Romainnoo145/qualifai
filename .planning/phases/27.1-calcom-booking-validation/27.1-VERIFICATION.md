---
phase: 27.1-calcom-booking-validation
verified: 2026-03-01T00:00:00Z
status: human_needed
score: 7/7 must-haves verified (automated); 1 human checkpoint outstanding
re_verification: false
human_verification:
  - test: 'Run node scripts/e2e-calcom-booking-test.mjs against live dev server'
    expected: 'Webhook POST returns HTTP 200 with success=true and callPrepId non-null; all 6 DB state checks print PASS; script exits with code 0'
    why_human: 'Task 2 in the plan is a blocking human-verify checkpoint. The SUMMARY claims it passed but this cannot be confirmed programmatically — script execution against a running dev server with CALCOM_WEBHOOK_SECRET set is required. The E2E-03 requirement is only truly closed when the live pipeline is exercised.'
---

# Phase 27.1: Cal.com Booking Validation Verification Report

**Phase Goal:** Validate the Cal.com booking to call prep generation flow end-to-end with a simulated BOOKING_CREATED webhook event.
**Requirement:** E2E-03 — Cal.com booking triggers automatic meeting brief generation
**Verified:** 2026-03-01
**Status:** human_needed — all automated checks pass; live execution checkpoint outstanding
**Re-verification:** No — initial verification

---

## Goal Achievement

### Observable Truths

| #   | Truth                                                                                                                      | Status   | Evidence                                                                                                                                                                                                                                                                                                      |
| --- | -------------------------------------------------------------------------------------------------------------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | A simulated BOOKING_CREATED event is POSTed to /api/webhooks/calcom with valid HMAC-SHA256 signature and receives HTTP 200 | VERIFIED | `postBookingCreated()` at line 263–317 builds HMAC via `createHmac('sha256', CALCOM_WEBHOOK_SECRET).update(rawBody).digest('hex')`, sends to `/api/webhooks/calcom` via `fetch` with `x-cal-signature-256` header; handler validates with `timingSafeEqual` at route.ts:52–63; HTTP 200 guard at line 310–314 |
| 2   | The webhook handler creates a CallPrepPlan record linked to the prospect's research run                                    | VERIFIED | `createCallPrepFromSequence()` at route.ts:158–278 calls `tx.callPrepPlan.create()` at line 259 with `prospectId`, `researchRunId`, `summary`, `plan30`, `plan60`, `plan90`; invoked inside `$transaction` at route.ts:338 for BOOKING_CREATED events                                                         |
| 3   | OutreachSequence status is updated to BOOKED                                                                               | VERIFIED | `tx.outreachSequence.update({ data: { status: 'BOOKED' } })` at route.ts:355–361; verified by DB check 1 in `verifyDbState()` at test script line 327–344                                                                                                                                                     |
| 4   | OutreachStep statuses are updated to BOOKED                                                                                | VERIFIED | `tx.outreachStep.updateMany({ data: { status: 'BOOKED' } })` at route.ts:363–371; verified by DB check 2 at test script line 347–355                                                                                                                                                                          |
| 5   | Contact outreachStatus is updated to CONVERTED                                                                             | VERIFIED | `tx.contact.update({ data: { outreachStatus: 'CONVERTED' } })` at route.ts:373–382; verified by DB check 3 at test script line 358–368                                                                                                                                                                        |
| 6   | Prospect status is updated to ENGAGED                                                                                      | VERIFIED | `tx.prospect.update({ data: { status: 'ENGAGED' } })` at route.ts:384–389; verified by DB check 4 at test script line 370–379                                                                                                                                                                                 |
| 7   | OutreachLog record is created with channel=calcom and status=booked                                                        | VERIFIED | `tx.outreachLog.create({ data: { channel: 'calcom', status: 'booked', metadata: { bookingUid, eventType: 'BOOKING_CREATED' } } })` at route.ts:391–421; verified by DB check 5 at test script line 382–403                                                                                                    |

**Score:** 7/7 truths verified (all automated checks pass)

---

## Required Artifacts

| Artifact                              | Expected                                               | Status   | Details                                                                                                                                                                                                                      |
| ------------------------------------- | ------------------------------------------------------ | -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `scripts/e2e-calcom-booking-test.mjs` | E2E Cal.com booking webhook test script, min 150 lines | VERIFIED | File exists, 562 lines — well above minimum. Substantive: HMAC computation, DB setup, webhook POST, 6-point DB verification, summary table, exit code. Wired: directly invokes `/api/webhooks/calcom` endpoint.              |
| `app/api/webhooks/calcom/route.ts`    | Cal.com webhook handler (pre-existing, from Phase 09)  | VERIFIED | File exists, 452 lines. Substantive: HMAC validation, Zod schema, transaction with all 5 side effects + callPrepPlan creation. Wired: imported `createCallPrepDraft` from `lib/workflow-engine` confirmed at line 7 and 255. |

---

## Key Link Verification

| From                                  | To                                        | Via                                         | Status | Details                                                                                                                                                                   |
| ------------------------------------- | ----------------------------------------- | ------------------------------------------- | ------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `scripts/e2e-calcom-booking-test.mjs` | `/api/webhooks/calcom`                    | HTTP POST with HMAC signature               | WIRED  | `fetch(WEBHOOK_URL, { method: 'POST', headers: { 'x-cal-signature-256': signature } })` at line 298–305; `WEBHOOK_URL` set to `${APP_URL}/api/webhooks/calcom` at line 41 |
| `/api/webhooks/calcom`                | `prisma.callPrepPlan`                     | `createCallPrepFromSequence` in transaction | WIRED  | `tx.callPrepPlan.create(...)` at route.ts line 259 inside `createCallPrepFromSequence()`; called at route.ts line 424–431 within `prisma.$transaction()`                  |
| `/api/webhooks/calcom`                | `lib/workflow-engine.createCallPrepDraft` | import + call                               | WIRED  | `import { createCallPrepDraft } from '@/lib/workflow-engine'` at route.ts line 7; called at route.ts line 255 with `(run.prospect, hypotheses, opportunities)`            |

---

## Requirements Coverage

| Requirement | Source Plan     | Description                                                 | Status                       | Evidence                                                                                                                                                                                                                                                                                                                                                              |
| ----------- | --------------- | ----------------------------------------------------------- | ---------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| E2E-03      | 27.1-01-PLAN.md | Cal.com booking triggers automatic meeting brief generation | SATISFIED (pending live run) | Webhook handler at `app/api/webhooks/calcom/route.ts` creates `CallPrepPlan` inside a transaction on BOOKING_CREATED event. E2E test script at `scripts/e2e-calcom-booking-test.mjs` simulates the full flow and verifies all 6 DB state changes. REQUIREMENTS.md marks E2E-03 as `[x]` complete with Phase 27.1 assignment at line 36 and coverage table at line 90. |

No orphaned requirements: E2E-03 is the only requirement declared for Phase 27.1 in both the PLAN frontmatter and ROADMAP.md. REQUIREMENTS.md maps it exclusively to Phase 27.1.

---

## Anti-Patterns Found

| File                                  | Line | Pattern       | Severity | Impact                                                                                                                                                                                                                      |
| ------------------------------------- | ---- | ------------- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `scripts/e2e-calcom-booking-test.mjs` | 135  | `return null` | Info     | Legitimate null return in `findEligibleProspect()` fallback — function exits early if no prospect matches criteria, guarded by caller at line 456–464 which exits the script with an instructive error message. Not a stub. |

No blockers or warnings found. No TODO/FIXME/PLACEHOLDER/HACK comments in either file. No empty handlers. No static returns masking real implementations.

---

## Human Verification Required

### 1. Live E2E Run of Cal.com Booking Script

**Test:** With `CALCOM_WEBHOOK_SECRET=e2e-calcom-test-secret` in `.env` and the dev server running on port 9200, execute:

```
node scripts/e2e-calcom-booking-test.mjs
```

**Expected:**

- Server health check passes
- Eligible prospect found (mujjo.com, deondernemer.nl, or any COMPLETED run with hypotheses and opportunities)
- BOOKING_CREATED POST returns HTTP 200 with `{ success: true, callPrepId: "<uuid>" }`
- All 6 DB checks print PASS:
  1. OutreachSequence status=BOOKED + bookingUid in metadata
  2. OutreachStep(s) status=BOOKED
  3. Contact outreachStatus=CONVERTED
  4. Prospect status=ENGAGED
  5. OutreachLog channel=calcom, status=booked, eventType=BOOKING_CREATED
  6. CallPrepPlan created with summary + plan30/60/90
- Script exits with code 0 and prints "ALL TESTS PASSED"

**Why human:** Task 2 in the plan is a blocking human-verify checkpoint. The automated code analysis confirms every piece is in place — the script is substantive, the handler is substantive, all wiring is verified. However, E2E-03 requires actual end-to-end execution: the HMAC must validate against the same secret the server loaded, the DB must have an eligible prospect, and the LLM-powered `createCallPrepDraft` must return non-empty content. The SUMMARY claims Task 2 was human-verified PASS, but this verifier cannot confirm script execution occurred.

---

## Implementation Quality Notes

The implementation is well-structured and follows established project patterns exactly:

- Script uses `import 'dotenv/config'` + `createRequire` for CJS deps — matches e2e-send-test.mjs and e2e-reply-test.mjs
- HMAC computation: `createHmac('sha256', secret).update(rawBody).digest('hex')` — matches what the handler validates with `timingSafeEqual`
- Early exit with clear instructions if `CALCOM_WEBHOOK_SECRET` missing — prevents silent failures
- Idempotency guard in handler (`alreadyProcessed` check at route.ts:138–156) prevents duplicate processing on re-runs
- Sequence reset strategy (reset to SENT, not delete) avoids DB accumulation from repeated test runs
- Fallback prospect search covers the common case where preferred test domains lack required research data
- Transaction wraps all 5 side effects + callPrepPlan creation — atomicity guaranteed

---

## Gaps Summary

No gaps found in automated verification. All 7 observable truths are supported by substantive, wired code. The single outstanding item is a live execution confirmation (human checkpoint) that was part of the plan's design — it is not a gap in the implementation, but a verification step that requires a running environment.

---

_Verified: 2026-03-01_
_Verifier: Claude (gsd-verifier)_
