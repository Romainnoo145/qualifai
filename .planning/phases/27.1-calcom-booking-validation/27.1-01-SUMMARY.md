---
phase: 27.1-calcom-booking-validation
plan: 01
subsystem: testing
tags: [calcom, webhook, hmac, e2e, booking, call-prep, outreach]

# Dependency graph
requires:
  - phase: 09-call-prep
    provides: Cal.com webhook handler at /api/webhooks/calcom and createCallPrepDraft
  - phase: 27-end-to-end-cycle
    provides: E2E test patterns (e2e-send-test.mjs, e2e-reply-test.mjs), test contacts/prospects
provides:
  - E2E test script for Cal.com BOOKING_CREATED webhook pipeline
  - Verified HMAC-SHA256 signature pattern for Cal.com webhook simulation
  - 6-point DB state verification for full booking-to-call-prep pipeline
affects: [future regression testing, calcom integration validation]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Cal.com HMAC: createHmac('sha256', secret).update(rawBody).digest('hex') → x-cal-signature-256 header"
    - 'E2E webhook test: find/create DB state → POST webhook → verify all DB side effects'

key-files:
  created:
    - scripts/e2e-calcom-booking-test.mjs
  modified: []

key-decisions:
  - 'CALCOM_WEBHOOK_SECRET must be pre-set in .env — script errors early with clear instructions if missing (no fallback injection since dev server reads env at boot)'
  - 'Test data setup: script resets existing OutreachSequence to SENT status rather than creating new ones, avoiding DB accumulation'
  - 'Fallback prospect search: tries mujjo.com/deondernemer.nl first, then any COMPLETED run with hypotheses+opportunities'

patterns-established:
  - 'Cal.com E2E: set up SENT sequence → POST BOOKING_CREATED with HMAC → verify 6 DB states'

requirements-completed: [E2E-03]

# Metrics
duration: 8min
completed: 2026-03-01
---

# Phase 27.1 Plan 01: Cal.com Booking E2E Test Summary

**HMAC-signed BOOKING_CREATED webhook simulation script verifying full booking-to-call-prep pipeline across 6 DB state checks (sequence BOOKED, steps BOOKED, contact CONVERTED, prospect ENGAGED, outreach log created, CallPrepPlan with 30/60/90 plans)**

## Performance

- **Duration:** ~8 min
- **Started:** 2026-02-28T23:34:07Z
- **Completed:** 2026-03-01T
- **Tasks:** 2/2
- **Files modified:** 1

## Accomplishments

- Created `scripts/e2e-calcom-booking-test.mjs` (562 lines) following exact patterns of e2e-send-test.mjs and e2e-reply-test.mjs
- HMAC-SHA256 signature computation using `node:crypto createHmac` — matches what the webhook handler validates
- Realistic BOOKING_CREATED payload with metadata containing `outreachSequenceId` and `contactId` for deterministic sequence lookup
- Full 6-point DB verification: OutreachSequence, OutreachStep, Contact, Prospect, OutreachLog, CallPrepPlan
- Guard: script exits with clear error if `CALCOM_WEBHOOK_SECRET` not set in env (server reads env at boot, so runtime injection does not work)

## Task Commits

Each task committed atomically:

1. **Task 1: Create E2E Cal.com booking test script** - `4efcebc` (feat)
2. **Task 2: Run E2E test and verify results** - Human-verified PASS (all 6 DB checks passed)

**Plan metadata:** (see final commit below)

## Files Created/Modified

- `scripts/e2e-calcom-booking-test.mjs` - E2E Cal.com booking webhook test: simulates BOOKING_CREATED with HMAC signature, verifies 6 DB state changes, summary table output

## Decisions Made

- `CALCOM_WEBHOOK_SECRET` must match what the dev server loaded at boot — no runtime fallback. Script exits early with exact `.env` instruction if missing.
- Sequence reset strategy: existing OutreachSequence for the test contact is reset to `SENT` status (not deleted), so the webhook can transition it to `BOOKED`. Avoids accumulating test sequences.
- Fallback prospect search scans last 20 COMPLETED research runs if preferred domains (mujjo.com, deondernemer.nl) don't have both hypotheses and opportunities.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

Before running Task 2 (human-verify checkpoint), ensure:

1. `.env` contains `CALCOM_WEBHOOK_SECRET=e2e-calcom-test-secret` (or any value)
2. Dev server restarted after adding the env var (`npm run dev`)
3. At least one prospect with COMPLETED research run and hypotheses/opportunities exists

## Next Phase Readiness

- E2E-03 requirement closed: Cal.com booking triggers automatic meeting brief generation, verified end-to-end
- Regression test available: `node scripts/e2e-calcom-booking-test.mjs`
- Phase 27.1 complete — v2.1 gap closure finished
- Ready to plan v2.2 milestone (Phases 28-30: verified pain intelligence)

## Self-Check: PASSED

- `scripts/e2e-calcom-booking-test.mjs` — FOUND
- Commit `4efcebc` — FOUND (feat(27.1-01): create E2E Cal.com booking webhook test script)

---

_Phase: 27.1-calcom-booking-validation_
_Completed: 2026-03-01_
