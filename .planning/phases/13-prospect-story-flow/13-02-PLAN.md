---
phase: 13-prospect-story-flow
plan: 02
type: execute
wave: 2
depends_on: ['13-01']
files_modified:
  - components/features/prospects/analysis-section.tsx
  - app/admin/prospects/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - 'Admin sees each hypothesis with its reasoning chain: which evidence led to which conclusion'
    - 'Admin sees which services (use cases) were matched to each hypothesis and their match score'
    - 'Admin can accept or reject hypotheses directly from the Analysis section'
    - 'Both bottlenecks and automation opportunities are shown in one unified list'
  artifacts:
    - path: 'components/features/prospects/analysis-section.tsx'
      provides: 'Analysis section with hypothesis reasoning chain and matched services'
  key_links:
    - from: 'app/admin/prospects/[id]/page.tsx'
      to: 'components/features/prospects/analysis-section.tsx'
      via: 'import AnalysisSection'
      pattern: 'import.*AnalysisSection'
    - from: 'components/features/prospects/analysis-section.tsx'
      to: 'api.hypotheses.listByProspect'
      via: 'tRPC query for hypotheses with evidence and proof matches'
      pattern: "hypotheses\\.listByProspect"
---

<objective>
Build the Analysis section that shows each hypothesis with its full reasoning chain — from raw evidence to conclusion to matched services — replacing the old Hypotheses tab.

Purpose: Admin should be able to follow the chain of reasoning: "We found [evidence] on their website, which suggests [hypothesis/problem], and we can help because [matched use case with score]." This is the core of the story flow.

Output: AnalysisSection component wired into the prospect detail page.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-prospect-story-flow/13-01-SUMMARY.md
@server/routers/hypotheses.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Analysis section component with reasoning chain display</name>
  <files>components/features/prospects/analysis-section.tsx</files>
  <action>
    Create `components/features/prospects/analysis-section.tsx` as a client component.

    Props: `{ prospectId: string; onSetStatus: (kind: 'hypothesis' | 'opportunity', id: string, status: 'DRAFT' | 'ACCEPTED' | 'REJECTED') => void }`

    Use `api.hypotheses.listByProspect.useQuery({ prospectId })` which returns `{ hypotheses, opportunities }` — each with `proofMatches` (including useCase and evidenceItem) and `evidenceItems` (resolved from evidenceRefs).

    Merge hypotheses and opportunities into a single list called "findings" — sort by status (ACCEPTED first, then DRAFT, then REJECTED) then by confidenceScore descending. Use plain-language labels:
    - Instead of "Bottlenecks" -> "Identified Challenges"
    - Instead of "Automation Opportunities" -> "Improvement Areas"
    - But since we're merging, label them all as "Findings" with a small type badge: "Challenge" or "Improvement"

    For each finding, render a card with this reasoning chain layout:

    **Card header:**
    - Status pill (ACCEPTED = emerald, REJECTED = red, DRAFT = slate) — same style as existing
    - Title of the hypothesis/opportunity
    - Type badge: "Challenge" or "Improvement" (small, muted)
    - Accept/Reject/Reset buttons (same as existing HypothesesTab)

    **Reasoning chain (the new part):**

    1. "Based on" section — show the evidence items that led to this conclusion:
       - For each evidence item (from the resolved evidenceItems array):
         - Source URL as a clickable link (truncated, external link icon)
         - Snippet preview (line-clamp-2)
         - Source type badge (use same plain-language mapping from 13-01: WEBSITE -> "Website", etc.)
       - If no evidence items, show "No specific sources linked"
       - Limit to 4 evidence items with "and N more..." if there are more

    2. "We can help because" section — show matched use cases (services):
       - For each proofMatch (from the proofMatches array):
         - Use case title (from match.useCase?.title or match.proofTitle as fallback)
         - Match score as percentage (e.g., "87% match")
         - Use case category as a small badge
       - If no proof matches, show "No services matched yet — run proof matching"

    3. Problem statement — the problemStatement (hypotheses) or description (opportunities) as a summary paragraph below the reasoning chain.

    Style: Each finding is a glass-card with generous padding. The reasoning chain uses subtle background sections (bg-slate-50 rounded-xl p-4) for "Based on" and "We can help" areas. Use arrow or flow indicators between sections to show the chain visually (a small down-arrow divider or a vertical timeline-like connector).

    Section header: "Analysis (N findings, M accepted)"

    Handle empty state: "No analysis available yet. Run research and proof matching to generate findings."

    Handle loading state with skeleton cards.

    Keep component under 250 lines.

  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
  </verify>
  <done>
    Analysis section component shows hypotheses and opportunities with full reasoning chain: evidence -> conclusion -> matched services. Admin can see WHY each finding was generated and WHAT service addresses it.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Analysis section into prospect detail page</name>
  <files>app/admin/prospects/[id]/page.tsx</files>
  <action>
    Import AnalysisSection from `@/components/features/prospects/analysis-section`.

    Replace the Analysis section placeholder with:
    ```tsx
    <AnalysisSection
      prospectId={id}
      onSetStatus={(kind, entryId, status) =>
        setHypothesisStatus.mutate({ kind, id: entryId, status })
      }
    />
    ```

    Ensure the `setHypothesisStatus` mutation is still defined in the page (it should be from plan 13-01). If the `hypothesisData` query was removed in 13-01 (it may have been kept for passing to command center — check the 13-01 SUMMARY), remove it now since AnalysisSection fetches its own data.

    Run `npm run check` to verify.

  </action>
  <verify>
    Run `npm run check` — passes type-check + lint + format.
  </verify>
  <done>
    Analysis section is wired into the prospect detail page, showing findings with reasoning chains. The old Hypotheses tab content is fully replaced.
  </done>
</task>

</tasks>

<verification>
1. `npm run check` passes
2. Analysis section shows merged hypotheses + opportunities as "findings"
3. Each finding shows evidence sources, matched services with scores, and problem description
4. Accept/Reject buttons work for hypothesis status changes
5. No jargon: "Bottlenecks" and "Automation Opportunities" replaced with plain language
</verification>

<success_criteria>

- Each hypothesis displays its reasoning chain: evidence -> conclusion -> matched service
- Admin can follow WHY a finding was generated by clicking through to source URLs
- Accept/Reject/Reset functionality preserved from old tab
- "Bottlenecks" and "Automation Opportunities" replaced with "Challenges" and "Improvements"
- TypeScript compiles without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/13-prospect-story-flow/13-02-SUMMARY.md`
</output>
