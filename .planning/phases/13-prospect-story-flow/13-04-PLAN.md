---
phase: 13-prospect-story-flow
plan: 04
type: execute
wave: 3
depends_on: ['13-01', '13-02', '13-03']
files_modified:
  - components/features/prospects/results-section.tsx
  - app/admin/prospects/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - 'Admin sees engagement data: email opens, replies, bookings, and conversions for this prospect'
    - 'Admin sees the cadence timeline showing all outreach touches'
    - 'Admin sees wizard session data: steps visited, PDF downloads, quote requests'
    - 'Results section combines all engagement signals in one view'
  artifacts:
    - path: 'components/features/prospects/results-section.tsx'
      provides: 'Results section showing engagement metrics and cadence timeline'
  key_links:
    - from: 'app/admin/prospects/[id]/page.tsx'
      to: 'components/features/prospects/results-section.tsx'
      via: 'import ResultsSection'
      pattern: 'import.*ResultsSection'
    - from: 'components/features/prospects/results-section.tsx'
      to: 'api.sequences.getCadenceState'
      via: 'tRPC query for cadence state and engagement'
      pattern: "sequences\\.getCadenceState"
---

<objective>
Build the Results section that shows all engagement data for a prospect — email opens, replies, bookings, conversions, cadence timeline, and wizard session activity.

Purpose: Admin needs to see "what happened after outreach" without switching between Cadence tab and wizard session data. This closes the story loop: Evidence -> Analysis -> Outreach -> Results.

Output: ResultsSection component that combines cadence timeline, email engagement, and wizard activity into one section.
</objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-prospect-story-flow/13-01-SUMMARY.md
@.planning/phases/13-prospect-story-flow/13-02-SUMMARY.md
@.planning/phases/13-prospect-story-flow/13-03-SUMMARY.md
@components/features/CadenceTab.tsx
@server/routers/sequences.ts
@server/routers/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Results section component with engagement metrics and cadence timeline</name>
  <files>components/features/prospects/results-section.tsx</files>
  <action>
    Create `components/features/prospects/results-section.tsx` as a client component.

    Props:
    ```tsx
    {
      prospectId: string;
      prospect: any; // prospect data including sessions, notificationLogs
    }
    ```

    Use these tRPC queries:
    - `api.sequences.getCadenceState.useQuery({ prospectId })` — for cadence state, engagement level, sequences, and timeline
    - The prospect data (passed as prop) includes `sessions` (wizard sessions with step times, PDF downloads, bookings, quote requests) and `notificationLogs`

    Layout in three sub-sections:

    **1. Engagement Summary (top cards row)**
    A compact row of metric cards showing:
    - Engagement Level: "High" (emerald) or "Normal" (slate) — from cadence state
    - Emails Sent: count of steps with status SENT
    - Opens: count of opens (from OutreachLog.openedAt — available via sequences steps, or note that we track this at the OutreachLog level)
    - Replies: count of sequences with status REPLIED or BOOKED
    - Bookings: count from wizard sessions (callBooked = true) + sequences with BOOKED status
    - PDF Downloads: count from wizard sessions (pdfDownloaded = true)
    - Quote Requests: count from wizard sessions (quoteRequested = true)

    Use a grid layout: 4 columns on large screens, 2 on small.

    **2. Wizard Activity**
    If prospect has sessions (wizard sessions):
    - Show latest session: max step reached, PDF downloaded (yes/no + date), booking made (yes/no + date), quote requested (yes/no + date)
    - Show total sessions count
    - If readableSlug exists: show dashboard URL being tracked

    If no sessions: "No prospect dashboard activity yet"

    **3. Outreach Timeline**
    Reuse the cadence timeline rendering logic from `CadenceTab.tsx` but embedded in this section. Do NOT import CadenceTab — instead, extract the timeline rendering into this component (or create a shared sub-component if useful).

    For each outreach step in the timeline:
    - Channel icon (email/call/linkedin/whatsapp) — reuse the channelIcon pattern from CadenceTab
    - Status badge (Drafted/Queued/Sent/Closed Lost)
    - Date
    - Triggered by indicator
    - Pending step pulse indicator

    Include the cadence summary: touches completed, next step info.

    If no sequences exist: "No outreach sent yet"

    Section header: "Results"

    Handle loading state with skeleton loaders.

    Plain-language labels throughout:
    - "Engagement Summary" not "Cadence State"
    - "Outreach Timeline" not "Touch Timeline"
    - "Dashboard Activity" not "Wizard Session"

    Keep under 280 lines.

  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
  </verify>
  <done>
    Results section shows engagement summary metrics, wizard/dashboard activity, and the full outreach timeline. Admin can see all outcomes in one place.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Results section into prospect detail page and clean up</name>
  <files>app/admin/prospects/[id]/page.tsx</files>
  <action>
    Import ResultsSection from `@/components/features/prospects/results-section`.

    Replace the Results section placeholder with:
    ```tsx
    <ResultsSection
      prospectId={id}
      prospect={p}
    />
    ```

    Now that all four sections are wired in, do a final cleanup of page.tsx:
    - Remove any unused imports (CadenceTab should already be removed from 13-01, but verify)
    - Remove any tRPC queries that are no longer used directly in the page (they're now inside section components). Keep only:
      - `api.admin.getProspect.useQuery` (for header, company info, contacts)
      - `api.research.listRuns.useQuery` (for latestRunId computation)
      - `api.hypotheses.listByProspect.useQuery` (only if needed for latestRunId — check, may be removable)
      - `api.assets.getLatest.useQuery` (for latestRunId computation)
      - `api.callPrep.getLatest.useQuery` (for latestRunId computation)
      - All mutations that are passed to section components
    - Remove any tRPC queries that are now fetched inside their respective section components (e.g., if AnalysisSection fetches its own hypothesisData, remove it from the page)
    - Clean up unused state variables
    - Verify page is under 300 lines

    Also remove the old CadenceTab component file import and the old inline sub-components that should have been removed in 13-01 (double-check).

    Run full check to ensure everything works.

  </action>
  <verify>
    Run `npm run check` — passes type-check + lint + format.
  </verify>
  <done>
    All four sections are wired in. Prospect detail page is clean, under 300 lines, with no unused imports or queries. The story flow is complete: Evidence -> Analysis -> Outreach Preview -> Results.
  </done>
</task>

</tasks>

<verification>
1. `npm run check` passes
2. Results section shows engagement metrics (emails, opens, replies, bookings)
3. Wizard/dashboard activity is displayed with session data
4. Outreach timeline shows all touches with channel icons and status
5. Page.tsx is clean with no dead code, under 300 lines
6. All four sections render and are navigable via the sticky section nav
</verification>

<success_criteria>

- Results section shows engagement data: sends, opens, replies, bookings, PDF downloads, quote requests
- Cadence timeline is visible showing all outreach touches
- Wizard session data is shown (step progress, conversions)
- Prospect detail page tells the complete story from Evidence through Results
- Page.tsx is clean and under 300 lines
- TypeScript compiles without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/13-prospect-story-flow/13-04-SUMMARY.md`
</output>
