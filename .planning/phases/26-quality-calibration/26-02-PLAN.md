---
phase: 26-quality-calibration
plan: 02
type: execute
wave: 2
depends_on: [26-01]
files_modified:
  - server/routers/admin.ts
  - components/features/prospects/quality-chip.tsx
  - server/routers/outreach.ts
autonomous: true
requirements: [QUAL-02]

must_haves:
  truths:
    - 'List-view quality chip shows the same tier as detail-view (both use real sourceTypeCount from ResearchRun.summary.gate)'
    - "Prospects with no research data show a grey 'Geen data' chip (not invisible)"
    - 'Sending outreach for an AMBER prospect without qualityApproved=true returns an error from the server'
  artifacts:
    - path: 'server/routers/admin.ts'
      provides: 'listProspects includes ResearchRun summary field so sourceTypeCount is available client-side'
      contains: 'summary: true'
    - path: 'components/features/prospects/quality-chip.tsx'
      provides: 'Uses real sourceTypeCount from summary.gate instead of hardcoded 1'
      contains: 'summary?.gate?.sourceTypeCount'
    - path: 'server/routers/outreach.ts'
      provides: 'sendEmail mutation checks qualityApproved for AMBER prospects and blocks if not approved'
      contains: 'qualityApproved'
  key_links:
    - from: 'components/features/prospects/quality-chip.tsx'
      to: 'ResearchRun.summary.gate.sourceTypeCount'
      via: 'summary prop parsed from listProspects query'
      pattern: "summary\\.gate\\.sourceTypeCount"
    - from: 'server/routers/outreach.ts'
      to: 'ResearchRun.qualityApproved'
      via: 'DB lookup before sending'
      pattern: 'qualityApproved'
---

<objective>
Fix the list-view traffic light to compute quality from real per-prospect data instead of the hardcoded worst-case approximation (sourceTypeCount=1, confidence=0.65), and harden the send queue so AMBER prospects block outreach until explicitly reviewed.

Purpose: After Phase 26-01 calibrates thresholds, this plan makes the list-view chip actually reflect those thresholds using real data — completing the QUAL-02 requirement. AMBER behavior change (block-not-warn) must also be enforced at the API level.

Output:

- List-view quality chip uses real sourceTypeCount from ResearchRun.summary.gate
- Grey chip for prospects with no research data
- sendEmail mutation rejects if prospect is AMBER and not qualityApproved
  </objective>

<execution_context>
@/home/klarifai/.claude/get-shit-done/workflows/execute-plan.md
@/home/klarifai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-quality-calibration/26-CONTEXT.md
@.planning/phases/26-quality-calibration/26-01-SUMMARY.md

Key existing code to understand before implementing:

- server/routers/admin.ts — listProspects query (line ~427): currently selects id, status, qualityApproved, qualityReviewedAt, \_count (evidenceItems, workflowHypotheses) — does NOT include summary
- components/features/prospects/quality-chip.tsx — QualityChipProps interface, hardcoded computeTrafficLight call on line ~108: `computeTrafficLight(evidenceCount, 1, 0.65)` — must be fixed
- lib/workflow-engine.ts — computeTrafficLight (updated in 26-01 to use quality-config constants)
- lib/research-executor.ts — runSummaryPayload stores gate object: { sourceTypeCount, averageConfidence, evidenceCount, passed, reasons, ... }
- server/routers/outreach.ts — sendEmail mutation (line ~253): currently does NOT check research quality

Design decisions (locked from 26-CONTEXT.md):

- Color chip only in list view — no score number or source count text
- Grey chip ("Geen data") for prospects with no research data
- "Matching" means same color tier because both views call computeTrafficLight with same real data
- AMBER = block until reviewed — send queue must enforce qualityApproved === true for AMBER
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Extend listProspects with summary field and fix QualityChip to use real data</name>
  <files>
    server/routers/admin.ts
    components/features/prospects/quality-chip.tsx
  </files>
  <action>
**1. Update server/routers/admin.ts — add summary to listProspects researchRuns select**

In the `listProspects` query (around line 451), the `researchRuns` include has a `select` block. Add `summary: true` to it so the gate data (sourceTypeCount, averageConfidence) is available:

```ts
researchRuns: {
  orderBy: { createdAt: 'desc' as const },
  take: 1,
  select: {
    id: true,
    status: true,
    qualityApproved: true,
    qualityReviewedAt: true,
    summary: true,   // Add this line
    _count: {
      select: { evidenceItems: true, workflowHypotheses: true },
    },
  },
},
```

**2. Update components/features/prospects/quality-chip.tsx**

**2a. Update QualityChipProps** to accept the summary field (optional, since existing usages from detail view may not pass it):

```ts
interface QualityChipProps {
  runId: string | null;
  evidenceCount: number;
  hypothesisCount: number;
  qualityApproved: boolean | null;
  qualityReviewedAt: Date | string | null;
  /** Summary JSON from ResearchRun.summary — contains gate.sourceTypeCount and gate.averageConfidence */
  summary?: unknown;
  runStatus?: string;
}
```

**2b. Fix the hardcoded traffic light computation** (line ~108).

Replace the hardcoded worst-case call:

```ts
// OLD — hardcoded approximation:
const trafficLight = computeTrafficLight(evidenceCount, 1, 0.65);
```

With real data extracted from `summary.gate`:

```ts
// Extract real quality metrics from stored gate data
// eslint-disable-next-line @typescript-eslint/no-explicit-any
const gate = (summary as any)?.gate;
const realSourceTypeCount: number =
  typeof gate?.sourceTypeCount === 'number' ? gate.sourceTypeCount : 1;
const realAvgConf: number =
  typeof gate?.averageConfidence === 'number' ? gate.averageConfidence : 0.65;

const trafficLight = computeTrafficLight(
  evidenceCount,
  realSourceTypeCount,
  realAvgConf,
);
```

**2c. Add grey chip for no-data state** — replace the early return `if (!runId) return null;` with a grey chip:

```ts
if (!runId) {
  return (
    <span className="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold border bg-slate-50 text-slate-400 border-slate-100">
      Geen data
    </span>
  );
}
```

**2d. Update the usage in app/admin/prospects/page.tsx** — pass `summary={run.summary}` to QualityChip:

```tsx
<QualityChip
  runId={run.id}
  evidenceCount={run._count.evidenceItems}
  hypothesisCount={run._count.workflowHypotheses}
  qualityApproved={run.qualityApproved}
  qualityReviewedAt={run.qualityReviewedAt}
  summary={run.summary} // Add this prop
/>
```

After all changes run:

```
cd /home/klarifai/Documents/klarifai/projects/qualifai && npm run check
```

Fix all TypeScript and lint errors.
</action>
<verify>
<automated>cd /home/klarifai/Documents/klarifai/projects/qualifai && npm run check</automated>
<manual>Grep confirms: `grep "summary: true" server/routers/admin.ts` finds the new field. `grep "gate?.sourceTypeCount" components/features/prospects/quality-chip.tsx` finds the real-data extraction. `grep "Geen data" components/features/prospects/quality-chip.tsx` finds the grey chip.</manual>
</verify>
<done> - listProspects select includes `summary: true` - QualityChip extracts real sourceTypeCount and averageConfidence from summary.gate - Hardcoded `computeTrafficLight(evidenceCount, 1, 0.65)` call is gone - Grey "Geen data" chip shown for prospects without a research run - app/admin/prospects/page.tsx passes `summary={run.summary}` to QualityChip - npm run check passes with zero errors
</done>
</task>

<task type="auto">
  <name>Task 2: Enforce AMBER hard gate in sendEmail mutation</name>
  <files>
    server/routers/outreach.ts
  </files>
  <action>
Enforce the AMBER blocking behavior in the `sendEmail` mutation (line ~253 in server/routers/outreach.ts).

The current `sendEmail` mutation does not check research quality at all. Per 26-CONTEXT.md, AMBER must BLOCK send until admin explicitly reviews (qualityApproved === true). RED must also block.

Add a quality gate check at the start of the `sendEmail` mutation, after the contact lookup:

1. From the contact, get the prospectId
2. Look up the latest ResearchRun for that prospect
3. Compute the traffic light
4. If RED: throw with "Kwaliteitsgate gefaald: te weinig bewijsmateriaal om outreach te versturen"
5. If AMBER and qualityApproved !== true: throw with "Kwaliteitsgate: beperkte bronnen gevonden. Controleer de kwaliteitsreview en keur goed voordat je verstuurt"
6. GREEN: proceed normally

Implementation in `sendEmail` mutation, after `ctx.db.contact.findUniqueOrThrow`:

```ts
// Quality gate: check research quality before sending
const prospectId = contact.prospectId;
if (prospectId) {
  const latestRun = await ctx.db.researchRun.findFirst({
    where: { prospectId },
    orderBy: { createdAt: 'desc' },
    select: {
      summary: true,
      qualityApproved: true,
    },
  });

  if (latestRun) {
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const gate = (latestRun.summary as any)?.gate;
    const evidenceCount: number =
      typeof gate?.evidenceCount === 'number' ? gate.evidenceCount : 0;
    const sourceTypeCount: number =
      typeof gate?.sourceTypeCount === 'number' ? gate.sourceTypeCount : 0;
    const avgConf: number =
      typeof gate?.averageConfidence === 'number' ? gate.averageConfidence : 0;

    const { computeTrafficLight } = await import('@/lib/workflow-engine');
    const tier = computeTrafficLight(evidenceCount, sourceTypeCount, avgConf);

    if (tier === 'red') {
      throw new TRPCError({
        code: 'PRECONDITION_FAILED',
        message:
          'Kwaliteitsgate gefaald: te weinig bewijsmateriaal om outreach te versturen. Voer eerst een onderzoek uit.',
      });
    }
    if (tier === 'amber' && latestRun.qualityApproved !== true) {
      throw new TRPCError({
        code: 'PRECONDITION_FAILED',
        message:
          'Kwaliteitsgate: beperkte bronnen gevonden. Keur de kwaliteitsreview goed in het prospect-overzicht voordat je verstuurt.',
      });
    }
  }
}
```

Import `TRPCError` at the top of the file if not already imported: `import { TRPCError } from '@trpc/server';`

Note: Use dynamic import for `computeTrafficLight` if it avoids circular dependency issues — otherwise use a static import at the top. Check existing imports pattern in the file and follow the same approach.

Also check if `contact.prospectId` is the field name by checking the Prisma schema — it may be `Contact.prospectId`. If the Contact model does not have a direct `prospectId` field, look it up via the prospect relationship.

After changes run:

```
cd /home/klarifai/Documents/klarifai/projects/qualifai && npm run check
```

Fix all TypeScript and lint errors.
</action>
<verify>
<automated>cd /home/klarifai/Documents/klarifai/projects/qualifai && npm run check</automated>
<manual>
Grep confirms: `grep "PRECONDITION_FAILED" server/routers/outreach.ts` finds the two gate throws.
`grep "computeTrafficLight" server/routers/outreach.ts` finds the traffic light call.
Test flow: attempting to send email for a prospect with 0 evidence should throw. (Can verify by checking the error appears in the outreach UI when trying to send a prospect with no research.)
</manual>
</verify>
<done> - sendEmail mutation checks research quality before sending - RED tier throws TRPCError PRECONDITION_FAILED with Dutch error message - AMBER tier without qualityApproved=true throws TRPCError PRECONDITION_FAILED with Dutch error message - GREEN tier proceeds normally - npm run check passes with zero errors
</done>
</task>

</tasks>

<verification>
1. `grep "summary: true" /home/klarifai/Documents/klarifai/projects/qualifai/server/routers/admin.ts` — finds the field in listProspects
2. `grep "gate?.sourceTypeCount\|gate\?\.sourceTypeCount" /home/klarifai/Documents/klarifai/projects/qualifai/components/features/prospects/quality-chip.tsx` — finds real-data extraction (not hardcoded 1)
3. `grep "Geen data" /home/klarifai/Documents/klarifai/projects/qualifai/components/features/prospects/quality-chip.tsx` — finds grey chip
4. `grep "PRECONDITION_FAILED" /home/klarifai/Documents/klarifai/projects/qualifai/server/routers/outreach.ts` — finds amber/red gate
5. `cd /home/klarifai/Documents/klarifai/projects/qualifai && npm run check` — zero errors
</verification>

<success_criteria>

- List-view QualityChip uses real sourceTypeCount from summary.gate (not hardcoded 1)
- Prospects with no research run show grey "Geen data" chip
- sendEmail API rejects RED prospects and AMBER prospects without qualityApproved=true
- npm run check passes with zero errors
  </success_criteria>

<output>
After completion, create `.planning/phases/26-quality-calibration/26-02-SUMMARY.md` including:
- Evidence that list-view now uses real sourceTypeCount (grep output)
- Evidence that amber gate is enforced at API level (grep output)
- Any deviations from plan
- Commit hashes
</output>
